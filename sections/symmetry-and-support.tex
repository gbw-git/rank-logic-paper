\documentclass[../paper.tex]{subfiles}

\begin{document}
In order to analyse families of symmetric circuits we need to develop some
theory for analysing symmetries. In this section we define the terms needed
(e.g. the notion of a support) and prove basic results. We then prove the first
important theorem in this paper, the support theorem, using these tools. It is
worth noting that we prove the support theorem for arbitrary symmetric circuits
with matrix-symmetric gates, not just for rank gates.    

\subsection{Supports and Supporting Partitions}
In this section we formally define a support and the related notion of a
supporting partition.

\begin{definition}
  Let $G \leq \sym_n$ and let $S \subseteq [n]$. Then $S$ is a \emph{support}
  for $G$ if $\stab_n(S) \leq G$. 
\end{definition}
% AD - \stab needs to be defined in background section GW - I've added it to my
% notes, to be filled in.

\begin{definition}
  Let $G \leq \sym_n$ and $\mathcal{P}$ be a partition of $[n]$. Then
  $\mathcal{P}$ is a \emph{supporting partition} for $G$ if $\stab(\mathcal{P})
  \leq G$.
\end{definition}

Notice that if $\mathcal{P}$ is a supporting partition for $G$ and $P \in
\mathcal{P}$ then $\stab([n] \setminus P) \leq \stab(\mathcal{P}) \leq G$, i.e.
$[n] \setminus P$ is a support for $G$.

Let $\mathcal{P}, \mathcal{P}'$ be partitions of $[n]$. We say that
$\mathcal{P}'$ is as \emph{coarse} as $\mathcal{P}$ (denoted by $\mathcal{P}
\preceq \mathcal{P}'$) if for all $x \in \mathcal{P}$ there exists $y \in
\mathcal{P}'$ such that $x \subseteq y$. Anderson and Dawar~\cite{AndersonD17}
define an operation $\mathcal{E}$ on pairs of partitions of $[n]$, where
$\mathcal{E} (\mathcal{P}, \mathcal{P}')$ is the partition of $[n]$ consisting
of the equivalence classes of the transitive closure of the relation $\sim$ on
$[n]$ defined by $a \sim b$ if, and only if, there exists $P \in \mathcal{P}
\cup mathcal{P}'$ such that $a,b \in P$. They show that $\mathcal{E}$ preserves
supporting partitions, and that $\mathcal{E}(\mathcal{P}, \mathcal{P}')$ is as
coarse as both $\mathcal{P}$ and $\mathcal{P}'$.

They use the $\mathcal{E}$ operation to show that for any permutation group $G
\leq \sym_n$ a unique coarsest supporting partition can always be found. We call
this partition the \emph{canonical supporting partition}, and denote it by $\SP
(G)$. This canonical supporting partition, along with the above observation
about supports, allows us to construct for each group a canonical support.
Anderson and Dawar \ref{AndersonD17} prove the following result.

\begin{prop}
  Let $G \leq \sym_n$ be a group and let $\mathcal{P}$ and $\mathcal{P}'$ be
  supporting partitions of $G$. Then $\mathcal{P} \preceq
  \mathcal{E}(\mathcal{P}, \mathcal{P}')$, $ \mathcal{P}' \preceq
  \mathcal{E}(\mathcal{P}, \mathcal{P}')$ and $\mathcal{E}(\mathcal{P},
  \mathcal{P}')$ is a supporting partition of $G$.
  \label{prop:combining-supporting-patitions}
\end{prop}

\begin{definition}
  Let $G \leq \sym_n$. Let $\| \SP(G) \| = \min \{\vert [n] \setminus P \vert :
  P \in \SP(G) \}$. We say that $G$ has \emph{small support} if $\| \SP(G) \| <
  \frac{n}{2}$.
\end{definition}

Note that if $G$ has small support then there is a part in its canonical
supporting partition of size greater than $\frac{n}{2}$ and this part is
necessarily the unique largest part in the partition.

\begin{definition}
  Let $G \leq \sym_n$ such that $G$ has small support. Let $\consp(G) = [n]
  \setminus P$, where $P$ is the largest element of $\SP(G)$. We call
  $\consp(G)$ the \emph{canonical support} of $G$.
\end{definition}

% \begin{remark}
%   Include a remark about the importance of asserting the size consideration.
%   Use the alternating group as an example.
% \end{remark}

\begin{lem}\label{lem:subgroup-coarse}
  Let $G_1, G_2 \leq \sym_n$ with $G_1 \leq G_2$. Then $\SP(G_1) \preceq
  \SP(G_2)$
\end{lem}
\begin{proof}
  We have that $\stab(\SP(G_1)) \leq G_1 \leq G_2$, and so $\SP(G_1)$ supports
  $G_2$. Since $\SP(G_2)$ is the coarsest support of $G_2$, $\SP(G_1) \preceq
  \SP(G_2)$.
\end{proof}

\begin{lem}
  Let $G_1, G_2 \leq \sym_n$ such that $G_1 \leq G_2$ and $G_1$ has small
  support. Then $G_2$ has small support and $\consp(G_2) \subseteq \consp(G_1)$.
  \label{lem:support-containment}
\end{lem}
\begin{proof}
  By Lemma~\ref{lem:subgroup-coarse}, we have that $\SP(G_1) \preceq \SP(G_2)$.
  Let $P_1$ be the largest element of $\SP(G_1)$, and note that since $G_1$ has
  small support, $\vert P_1 \vert > \frac{n}{2}$. Then there exists a (unique)
  $P_2 \in \SP(G_2)$ such that $P_1 \subseteq P_2$. Thus $G_2$ has small
  support, and $\consp(G_2) = [n] \setminus P_2 \subseteq [n] \setminus P_1 =
  \consp(G_1)$.
\end{proof}

\begin{lem}
  Let $G, H, K \leq \sym_n$ such that $G$ has small support and $G = H \cap K$.
  Then $H$ and $K$ have small support and $\consp(G) = \consp(H) \cup
  \consp(K)$.
  \label{lem:row-column-supports-well-behaved}
\end{lem}
\begin{proof}
  The fact that $H$ and $K$ have small support follows from
  Lemma~\ref{lem:support-containment}.

  Let $\mathcal{Q} = \{P_H \cap P_K : P_H \in \SP(H), P_K \in \SP(K) \text{ and
  } \exists P \in \SP(G), P \subseteq P_H \cap P_K \}$. We first show that
  $\mathcal{Q}$ is a supporting partition of $G$. We have that for any $P_H \cap
  P_K, P_H' \cap P_K' \in \mathcal{Q}$, $P_H \cap P_K \cap P_H' \cap P_K' \neq
  \emptyset$ if, and only if, $P_H = P_H'$ and $P_K = P_K'$ if, and only if,
  $P_H \cap P_K = P_H' \cap P_K'$. By Lemma~\ref{lem:subgroup-coarse}, we have
  that $\SP(G) \preceq \SP(H)$ and $\SP(G) \preceq \SP(K)$. It follows that for
  each $P \in SP(G)$ there exists $P_K \in \SP(K)$ and $P_H \in \SP(H)$ such
  that $P \subseteq P_H \cap P_K$. So, for each $a \in [n]$ there is $P_a \in
  \SP(G)$, $P_H \in \SP(H)$ and $P_K \in \SP(K)$ such that $a \in P_a \subseteq
  P_H \cap P_K$. It follows that $\mathcal{Q}$ is a partition.

  Moreover, we note that $\stab(\mathcal{Q}) \leq \stab(\SP(H))$ and
  $\stab(\mathcal{Q}) \leq \stab(\SP(K))$, and thus $\stab(\mathcal{Q}) \leq
  \stab(\SP(H)) \cap \stab(\SP(K)) \leq H \cap K = G$. It follows that
  $\mathcal{Q}$ is a supporting partition of $G$, and so by definition of the
  canonical supporting partition $\mathcal{Q} \preceq \SP (G)$. Since $G$ has
  small support, there is a part $P_G$ in $\SP(G)$ with $|P_G| > \frac{n}{2}$.
  Then there exists $P_H \in \SP(H)$ and $P_K \in \SP(K)$ such that $P_G
  \subseteq P_H \cap P_K$, and so $\vert P_H \cap P_K \vert > \frac{n}{2}$. Thus
  $P_H \cap P_K$ is the unique largest element in $\mathcal{Q}$. It follows from
  $\mathcal{Q} \subseteq \SP(G)$ that $P_G \subseteq P_H \cap P_K \subseteq
  P_G$.

  % From the fact that $G$ has small support, $P_H$ and $P_K$

  % Thus if $P_Q$ is the maximal element of $\mathcal{Q}$ then there exists $P_G
  % \in \SP(G)$ such that $P_Q \subsetq P_G$. But $\SP(G)$ supports

  % Since It follows that there exists $P \in \SP(G)$ suLet $P_G$ be the maximal
  % element of $\SP(G)$. Since $G$ has small support, $\vert P_G \vert >
  % \frac{n}{2}$. $We have that there exists unique maximal elements $P_H \in
  % \SP(H)$ and $P_K \in \SP(K)$ such that $P_G P_H \cap P_K$
\end{proof}

We state the following two results proved by Anderson and Dawar
\cite{AndersonD17}.

\begin{lem}
  \label{lem:SP_conjugation}
  Let $G \leq \sym_n$ and $\sigma \in \sym_n$ then $\sigma \SP (G) = \SP(\sigma
  G \sigma^{-1})$.
\end{lem}

\begin{lem}
  For any $G \leq \sym_n$ we have that $\stab (\SP (G)) \leq G \leq
  \setstab(\SP(G))$.
\end{lem}

\subsection{Group Action on Supports}
In this paper, unlike in the case of Anderson and Dawar \cite{AndersonD17}, we
often wish to speak of supports and group actions on elements on the circuit
other than gates. As such, we need to develop theory and terminology for dealing
with group actions (and supports) in general. In this subsection we introduce
some useful terminology.

\begin{definition}
  Let $G \leq X$ be a set on which a left group action of $G$ on $X$ is defined
  and let $x \in X$. Then $\stab_G (x) = \{\pi \in G : \pi x = x\}$ and $\orb_G
  (x) = \{\pi x : \pi \in G\}$. In the event that the context makes the group
  obvious we omit the subscript. We use $\stab_n$ and $\orb_n$ to abbreviate
  $\stab_{\sym_n}$ and $\orb_{\sym_n}$. Let $Y$ be a set on which a left group
  action of $G$ on $Y$ is defined and let $y \in Y$. Then we let $\stab_y(x) :=
  \stab_{\stab_G(y)}(x)$ and $\orb_y(x) := \orb_{\stab_{G}(y)}(x)$.
\end{definition}

\begin{definition}
  Let $X$ be a set on which a left group action of $\sym_n$ on
  $X$ is defined. We denote the \emph{canonical supporting partition} of $x \in
  X$ by $\SP (x) = \SP (\stab_G(x))$. Similarly we let $\| \SP (x) \| = \| \SP
  (\stab_G(x)) \|$. We say that $x \in X$ has \emph{small support} if
  $\stab_G(x)$ has small support. We say that $X$ has small supports if all $x
  \in X$ have small support.

  If $x \in X$ has small support, we denote the \emph{canonical support} of $x$
  by $\consp(x) = \consp (stab_G(x))$.

  Let $Y$ be a set on which a left group action of $G$ on $Y$ is defined. We 
\end{definition}

\begin{lem}
  \label{lem:stab_conjugation}
  Let $G \leq \sym_n$, $\sigma \in G$ and let $X$ be a set on which a left group
  action of $G$ on $X$ is defined. Then for any $x \in X$ it follows that
  $\sigma \stab_n (x) \sigma^{-1} = \stab_n(\sigma x)$.
\end{lem}

\begin{proof}
  Let $\pi \in \stab(x)$, then $\sigma \pi \sigma^{-1}(\sigma x) = \sigma \pi
  (x) = \sigma (x)$, and so $\sigma \pi \sigma^{-1} \in \stab(\sigma x)$. Let
  $\pi \in \stab(\sigma (x))$ then $\pi \sigma (x) = \sigma (x)$ and so
  $\sigma^{-1} \pi \sigma (x) = x$. It follows that $\sigma^{-1} \pi \sigma \in
  \stab(x)$ and so $\pi = \sigma (\sigma^{-1} \pi \sigma) \sigma ^{-1} \in
  \sigma \stab(x) \sigma^{-1}$.
\end{proof}

\begin{lem}
  \label{lem:support_mapping}
  Let $G \leq \sym_n$, $X$ be a set on which a left group action of $G$ on $X$
  is defined and $\sigma \in G$. Then for any $x \in X$ it follows that $\sigma
  \SP (x) = \SP (\sigma x)$ and, if $x$ has small support, $\sigma \consp (x) =
  \consp (\sigma x)$.
\end{lem}
\begin{proof}
  From Lemma \ref{lem:SP_conjugation} and Lemma \ref{lem:stab_conjugation} have
  that $\sigma \SP (x) = \SP(\sigma \stab(h) \sigma^{-1}) = \SP (\stab(\sigma
  x)) = \SP (\sigma x)$. Thus proving the first part of the statement.

  From the fact that $\| \SP(x) \| < \frac{n}{2}$ it follows there exists a
  unique $P_1 \in \SP(x)$ such that $\vert P_1 \vert > \frac{n}{2}$ and
  $\consp(x) = [n] \setminus P_1$. But then $\sigma \consp (x) = \sigma([n]
  \setminus P_1) = [n] \setminus (\sigma P_1)$. We note that $\sigma P_1 \in
  \sigma \SP (x) = \SP(\sigma x)$ and $\vert \sigma P_1 \vert > \frac{n}{2}$.
  Thus $\sigma P_1$ is the unique largest partition in $\SP(\sigma x)$, and so
  $\consp(\sigma x) = [n]\setminus (\sigma P_1) = \sigma (\consp(x))$. Thus
  proving the second part of the statement.
\end{proof}

\begin{lem}
  Let $G \leq \sym_n$, $X$ be a set on which a left group action of $G$ on $X$
  is defined. Then for any $x \in X$ with small support, and $\sigma, \sigma'
  \in G$ such that $\sigma (\vec{\consp}(x)) = \sigma' (\vec{\consp}((x))$ we
  have that $\sigma (x) = \sigma'(x)$.
  \label{lem:support-determine-action}
\end{lem}
\begin{proof}
  We have that $(\sigma')^{-1}\sigma(\vec{\consp}(x)) = \vec{\consp}(x)$ and so
  $(\sigma')^{-1} \sigma (x) = x$ and thus $\sigma (x) = \sigma' (x)$.
\end{proof}


\subsection{Support Theorems}
The support theorem of Anderson and Dawar~\cite{AndersonD17} asserts that, for
the case of symmetric circuits with symmetric gates, if the circuit is not too
large then the stabiliser group of any gate in the circuit has small support. In
particular, their result implies that polynomial-size family of symmetric
circuits with symmetric gates consists of gates each of which has a
constant-size support. In this section we generalise the support theorem to
transparent $(\mathbb{B}, \rho)$-circuits defined over arbitrary bases.

The proof of this result follows a strategy broadly similar to the one used by
Anderson and Dawar~\cite{AndersonD17}. We also make use of two lemmas proved by
Anderson and Dawar~\cite{AndersonD17}. The first of these lemmas gives us that
if the index of a group $G \leq \sym_n$ is small then $\SP(G)$ either has very
few or very many parts. The second lemma gives us that for $G \leq \sym_n$,
$\SP(G)$ has very few parts then it must have a single very large part. The
formal statements of these two results have been reproduced here as
Lemma~\ref{big-or-small} and Lemma~\ref{lem:small-means-support}. These two
results allow us to conclude that a gate in a symmetric circuit has a small
canonical support support if it has a canonical supporting partition with very
few parts. We thus argue by structural induction on the circuit that no gate can
have a canonical supporting partition with very many parts. The inductive step
is proved by analysing the orbits of the gates in the circuit, and showing that
if a gate has a canonical supporting partition with too many parts then its
orbit would exceed the required bound, thus allowing us to conclude the result
by contradiction.

We begin by first building up a few observations about the size of the
stabiliser group, and hence the orbit, of a gate. Let $C$ be a circuit of order
$n$ with unique labels and let $g$ be a gate in the circuit. Let $\vec{x} \in
\ind(g)$ and $\sigma \in \sym_n$ be such that $\sigma L(g)(\vec{x}) \in H_g$.
Then we let $\sigma \cdot \vec{x} := L(g)^{-1}\sigma L(g)(\vec{x})$. While this
operation is not defined for certain $\sigma \in \sym_n$, and hence does not
define a group action of $\sym_n$ on $\ind(g)$, it does define a group action of
$\stab(H_g)$ on $\ind(g)$. For $\sigma in \sym_n$, if $H_g = \sigma H_g$ and
$L(g)$ is isomorphism-equivalent to $\sigma L(g)$ then we say that $\sigma$
\emph{acts like an isomorphism} at $g$. Notice that for $\sigma \in \sym_n$, we
have that $\sigma \in \stab_n(g)$ if, and only if, $\sigma$ acts like an
isomorphism at $g$, which holds if, and only if, $H_g = \sigma H_g$ and there
exists $\pi \in \sortsymsub$ such that $\sigma \cdot \vec{x} = \pi (\vec{x})$
for all $\vec{x} \in \ind(g)$.


% We first now In this subsection we always use $\tau$ to denote a many-sorted
% vocabulary and $D$ to be a $\tau$-universe. Let $C$ be a symmetric circuit of
% order $n$ with unique labels and let $g$ and $g'$ be two non-output gates such
% that $\ind(\tau, D) = \ind(g) = \ind(g')$. We note that for $\sigma \in
% \sym_n$, $\sigma (g) = g'$ if, and only if, $\sigma H_g = H_{g'}$ and there
% exists $\pi \in \sortsym_D$ such that, for all $\vec{x} \in \ind(D, \tau)$,
% $L(g')^{-1} \sigma L(g)(\vec{x}) = \pi \vec{x}$. In other words we are
% interested in testing whether $L(g')^{-1} \sigma L(g)$ acts on $\ind(\tau, D)$
% \emph{like an automorphism}.

% \begin{definition}
%   Let $\tau$ be a many-sorted vocabulary and $D$ be a $\tau$-universe. Let $G$
%   be a group and let $\phi : G \rightarrow \sym_{\ind(\tau, D)}$ be a group
%   action of $G$ on $\ind(\tau, D)$. Let $\sigma \in G$. If $\phi(\sigma) \in
%   \symsort_D$ then we say that $\sigma$ \emph{acts on like an automorphism}
%   with respect to $\phi$. We let $\sortsym_D(\phi) \leq G$ denote the group
%   consisting of all those elements of $G$ that act as an automorphism with
%   respect to $\phi$.

%   %   Let $\tau$ be a many-sorted vocabulary and $D$ a $\tau$-universe. Let $G
%   %   \leq
%   %   \sym_n$ and suppose there is a (left) group action $\phi: $ defined on
%   %   $\ind(\tau, D)$.
%   %   We say that $\sigma \in G$ \emph{acts like an isomorphism} if there
%   %   exists
%   %   $\pi \in \sortsym_D$ such that $\pi \cdot \vec{x} = \sigma \cdot
%   %   \vec{x}$ for all $\vec{x} \in \ind(\tau, D)$.
% \end{definition}

% If the group action is obvious from context we write $\sortsym_D(\cdot)$
% instead of $\sortsym_D(\phi)$.
We say that $\sigma \in \sym_n$ is \emph{compatible} with a pair $h, h' \in H_g$
if $\sigma$ acts like an isomorphism at $g$ when restricted to the gates $h$ and
$h'$. We formalise this notion below.

\begin{definition}
  Let $C$ be a circuit of order $n$ with unique labels and let $g$ be a gate in
  the circuit. Let $\tau$ be the vocabulary of $g$ and $D$ be the universe of
  $g$. Let $\sigma \in \sym_n$, $h, h' \in H_g$, and let $\vec{x} :=
  L(g)^{-1}(h)$ and $\vec{y} := L(g)^{-1}(h')$. We say that $(h, h')$ is
  \emph{compatible} with $\sigma$ if $\sigma h, \sigma h' \in H_g$ and for every
  $R_i$ and $R_j$ be relation symbols in $\tau$ such that $\vec{x} \in R^{D}_i$
  and $\vec{y} \in R^{D}_j$, $\sigma \cdot \vec{x} \in R^{D}_i$ and $\sigma
  \cdot \vec{y} \in R^D_j$, and for all $a \in [\arty(R_i)]$ and $b \in
  [\arty(R_j)]$, $\vec{x}(a) = \vec{y}(b)$ if, and only if, $(\sigma \cdot
  \vec{x})(a) = (\sigma \cdot \vec{y})(b)$.
\end{definition}

% \begin{definition}
%   Let $G$ be a group and let $\phi : G \rightarrow \sym_{\ind(\tau, D)}$ be a
%   group action. Let $\sigma \in G$, $\vec{x}, \vec{y} \in \ind(\tau, D)$, and
%   let $R_i$ and $R_j$ be relation symbols in $\tau$ such that $\vec{x} \in
%   R^{D}_i$ and $\vec{y} \in R^{D}_j$. We say that $(\vec{x}, \vec{y})$ is
%   \emph{compatible} with $\sigma$ with respect to $\phi$ if $\sigma \cdot
%   \vec{x} \in R^{D}_i$ and $\sigma \cdot \vec{y} \in R^D_j$, and for all $a
%   \in [\arty(R_i)]$ and $b \in [\arty(R_j)]$, $\vec{x}(a) = \vec{y}(b)$ if,
%   and only if, $(\sigma \cdot \vec{x})(a) = (\sigma \cdot \vec{y})(b)$. If the
%   group action in question is obvious from context we omit it, and write just
%   that $(\vec{x}, \vec{y})$ is compatible with $\sigma$.
% \end{definition}

For a gate $g$ in a circuit with unique labels, we show that a permutation
$\sigma$ acts like an isomorphism at $g$ if, and only if, every pair of gates in
$H_g$ is compatible with $\sigma$. This gives us a useful local condition for
checking if a permutation acts like an isomorphism at $g$, and hence stabilises
$g$.

\begin{lem}
  Let $C$ be a circuit of order $n$ with unique labels, $g$ be a gate in the
  circuit, and $\sigma \in \sym_n$. Then $\sigma$ acts like an automorphism at
  $g$ if, and only if, for all $h, h' \in H_g$, $(h, h')$ is compatible with
  $\sigma$.
  \label{lem:isostab-compatible}
\end{lem}

\begin{proof}
  Let $\tau$ be the vocabulary and $D$ the universe of $g$.
  
  $`\Rightarrow'$: Suppose $\sigma$ acts like an isomorphism at $g$. We then
  have that $\sigma H_g = H_g$. and there exists $\pi \in \sortsymsub$ such that
  $\sigma \cdot \vec{x} = \pi (\vec{x})$ for all $\vec{x} \in \ind(\tau, D)$.
  Let $h, h' \in H_g$ and let $\vec{x} := L(g)^{-1}(h)$ and $\vec{y} =
  L^{-1}(h)$. Since $\sigma$ acts like an isomorphism at $g$ it is easy to see
  that it maps tuples in a relation to tuples in the same relation. Let $R_i$
  and $R_j$ be relation symbols in $\tau$ such that $\vec{x} \in R^D_i$ and
  $\vec{y} \in R^D_j$. Let $w \in [\arty (R_i)]$ and $z \in [\arty (R_j)]$, then
  $\sigma \cdot \vec{x} (w) = \sigma \cdot \vec{y}(z)$ if, and only if,
  $\pi(\vec{x}(w)) = \pi (\vec{x})(w) = \pi (\vec{y})(z) = \pi(\vec{y}(z))$ if,
  and only if, $\vec{x}(w) = \vec{y}(z)$. The final equivalence follows from the
  injectivety of $\pi$.
  
  $`\Leftarrow'$: We have that for all $h, h' \in H_g$ that $(h, h')$ is
  compatible with $\sigma$. It follows that $\sigma H_g = H_g$. We now define
  $\pi$ such that $\pi \in \sortsymsub$ and $\sigma \cdot \vec{x} = \pi
  (\vec{x})$ for all $\vec{x} \in \ind(\tau, D)$. Let $a \in D$ and $\vec{x} \in
  \ind(\tau, D)$ be a tuple containing $a$. Then let $\pi (a) = \sigma \cdot
  \vec{x} (\vec{x}^{-1}(a))$. The compatibility condition ensures that this
  definition is independent of the particular choice of $\vec{x}$ and that,
  since $\sigma$ takes tuples in a given relation to tuples of the same
  relation, $a$ and $\pi (a)$ must be of the same sort.
  
  We show that $\pi$ is injective. Suppose $\pi(a) = \pi(b)$. Suppose $a$
  appears in $\vec{x} \in \ind(\tau, D)$ and $b$ appears in $\vec{y} \in
  \ind(\tau, D)$, then $\sigma \cdot \vec{x} (\vec{x}^{-1}(a)) = \pi (a) =
  \pi(b) = \sigma \cdot \vec{y}(\vec{y}^{-1}(b))$. From the hypothesis
  $(\vec{x}, \vec{y})$ is compatible with $\sigma$, and so $a =
  \vec{x}(\vec{x}^{-1}(a)) = \vec{y}(\vec{y}^{-1}(b)) = b$. It follows $\pi$ is
  an injection.
  
  We now prove surjectivity. Let $b \in D$. Suppose $b$ appears in $\vec{x} \in
  \ind(\tau, D)$ and let $i \in \dom(\vec{x})$ be such that $\vec{x}(i) = b$.
  Let $\vec{y} = \sigma \cdot \vec{x}$. Then $\pi (\vec{y}(i)) = \sigma \cdot
  \vec{y} (\vec{y}^{-1}(\vec{y}(i))) = \vec{x}(i) = b$. It follows that $\pi$ is
  surjective, and so bijective. Thus $\pi \in \sortsymsub$.

  Clearly $\pi (\vec{x}) = \sigma \cdot \vec{x}$ for all $\vec{x} \in \ind(\tau,
  D)$, and the result follows.
\end{proof}

% \begin{lem}
%   Let $G$ be a group, suppose $\phi : G \rightarrow \sym_{\ind(\tau, D)}$ is a
%   group action and let $\sigma \in G$. Then $\sigma$ acts like an automorphism
%   with respect to $\phi$ if, and only if, for all $\vec{x}, \vec{y} \in
%   \ind(\tau, D)$, $(\vec{x}, \vec{y})$ is compatible with $\sigma$ with
%   respect to $\phi$.
%   \label{lem:isostab-compatible}
% \end{lem}

% \begin{proof}
%   $`\Rightarrow'$: Let $\vec{x}, \vec{y} \in \ind(\tau, D)$ and suppose
%   $\sigma$ acts like a sorted permutation. Let $\pi \in \sortsym(\tau, D)$ be
%   the permutation that witnesses this. Then $\sigma$ acts on $\ind (\tau, D)$
%   as an isomorphism, and so maps tuples in a relation to tuples of the same
%   relation. Let $R_i$ and $R_j$ be relation symbols in $\tau$ such that
%   $\vec{x} \in R^D_i$ and $\vec{y} \in R^D_j$. Let $w \in [\arty (R_i)]$ and
%   $z \in [\arty (R_j)]$, then $\sigma \cdot \vec{x} (w) = \sigma \cdot
%   \vec{y}(z)$ iff $\pi \cdot \vec{x}(w) = \pi \cdot \vec{y}(z)$ iff
%   $\vec{x}(w) = \vec{y}(z)$.
  
%   $`\Leftarrow'$: We have that for all $\vec{x}, \vec{y} \in \ind(\tau, D)$,
%   $(\vec{x}, \vec{y})$ is compatible with $\sigma$. We now define $\pi$ such
%   that $\pi \in \sortsym(D)$ and $\sigma \cdot \vec{x} = \pi \cdot$. Let
%   $\vec{x} \in \ind(\tau, D)$ be a tuple containing $a$ and let $\pi (a) =
%   \sigma \cdot \vec{x} (\vec{x}^{-1}(a))$. The compatibility condition ensures
%   that this definition is independent of the particular choice of $\vec{x}$.
  
%   We show that $\pi$ is injective. Suppose $\pi(a) = \pi(b)$. Suppose $a$
%   appears in $\vec{x} \in \ind(\tau, D)$ and $b$ appears in $\vec{y} \in
%   \ind(\tau, D)$, then $\sigma \cdot \vec{x} (\vec{x}^{-1}(a)) = \pi (a) =
%   \pi(b) = \sigma \cdot \vec{y}(\vec{y}^{-1}(b))$. From the hypothesis
%   $(\vec{x}, \vec{y})$ is compatible with $\sigma$, and so $a =
%   \vec{x}(\vec{x}^{-1}(a)) = \vec{y}(\vec{y}^{-1}(b)) = b$. It follows $\pi$
%   is an injection.
  
%   We now prove surjectivity. Let $b \in D$. Suppose $b$ appears in $\vec{x}
%   \in \ind(\tau, D)$ and let $i \in \dom(\vec{x})$ be such that $\vec{x}(i) =
%   b$. Let $\vec{y} = \sigma \cdot \vec{x}$. Then $\pi (\vec{y}(i)) = \sigma
%   \cdot \vec{y} (\vec{y}^{-1}(\vec{y}(i))) = \vec{x}(i) = b$. It follows that
%   $\pi$ is surjective, and thus bijective. The compatibility condition gives
%   us that $\pi (R^D_i) = R^D_i$ for any relation symbol $R_i$ in $\tau$. Thus
%   $\pi \in \sortsym(D)$.

%   Clearly $\pi \cdot \vec{x} = \sigma \cdot \vec{x}$ for all $\vec{x} \in
%   \ind(\tau, D)$, and the result follows.
% \end{proof}


% is a group action of $G$ on $\ind(\tau, D)$. We also use $\sortsym_G (D)$ (or
% $\sortsym_n(D)$ if $G = \sym_n$) to refer to the subgroup of $G$ consisting of
% those permutations that act like a sorted permutation (or, equivalently, are
% compatible with every pair of vectors in $\ind(\tau, D)$).

In the proof of the support theorem by contradiction we show that if a gate does
not have a small enough support then its orbit must be too large. In particular,
we construct a set $S$ such that $\vert \orb(g) \vert = [\sym_n : \stab_n(g)]
\geq 2^S$, and $S$ is large enough to give the required contradiction. We now
show that any set $S \subseteq (\sigma, h, h') \in \sym_n \times H^2_g$ that is
\emph{useful} and \emph{independent} will have that $[\sym_n : \stab_n(g)] \geq
2^S$. The idea is that the `useful' property ensures that every tuple in the set
moves the gate $g$. The `independent' property ensures that for all $(\sigma_1,
h_1, h_1'), (\sigma_2, h_2, h_2') \in S$, $\sigma_1$ fixes $h_2$, $\sigma_2
h_2$, $h_2'$ and $\sigma_2 h_2$. Independence ensures that for a triple
$(\sigma, h, h') \in S$ the only permutation that appears in $S$ that could move
$h$ or $h'$ is $\sigma$. Moreover, this observation extends to sequences of
permutations, with such sequences acting trivially on $h$ and $h'$ unless
$\sigma$ is in the sequence, in which case the action on $h$ and $h'$ is equal
to $\sigma h$ and $\sigma h'$.

We now define these terms formally and prove that useful and independent sets
indeed give the required lower bound.

% \begin{definition}
%   Let $G$ and $G'$ be groups and suppose be a group and suppose $\phi : G
%   \rightarrow \sym_{\ind(\tau, D)}$ is a group action. We say that $(\sigma,
%   \vec{x}, \vec{y}) \in G \times \ind(\tau, D)^{2}$ is \emph{useful} if
%   $(\vec{x}, \vec{y})$ is not compatible with $\sigma$ with respect to $\phi$.

%   We say that two distinct pairs $(\sigma_1, \vec{x}_1, \vec{y}_1), (\sigma_2,
%   \vec{x}_2, \vec{y}_2) \in G\times \ind(\tau, D)^2$ are \emph{mutually
%   independent} if
%   \begin{itemize}
%     \setlength\itemsep{0mm}
%   \item $\sigma_2 cdot \vec{x}_1 = \vec{x}_1$,
%   \item $\sigma_2 \sigma_1 \cdot \vec{x}_1 = \sigma_1 \cdot \vec{x}_1$,
%   \item $\sigma_2 \cdot \vec{y}_1 = \vec{y}_1$, and
%   \item $\sigma_2 \sigma_1 \cdot \vec{y}_1 = \sigma_1 \cdot \vec{y}_1$.
%   \end{itemize}
  
%   We say that a set $S \subseteq G \times \ind(\tau, D)^2$ is \emph{useful}
%   (with respect to $\phi$) if each pair in it is useful. We say that $S$ is
%   \emph{independent} (with respect to $\phi$) if any two distinct elements of
%   $S$ are mutually independent.
% \end{definition}

% AD: isn't this definition missing something about y_2 and x_2? I also think it
% needs some intuitive explanation to accompany it.

\begin{definition}
  Let $C$ be a circuit with injective labels of order $n$ and $g$ be a gate in
  $C$. We say that $(\sigma, h, h') \in \sym_n \times H^2_g$ is \emph{useful} if
  $(h, h')$ is not compatible with $\sigma$.

  We say that two distinct pairs $(\sigma_1, h_1, h_1'), (\sigma_2, h_2, h_2')
  \in \sym_n\times H^2_g$ are \emph{mutually independent} if
  \begin{itemize}
    \setlength\itemsep{0mm}
  \item $\sigma_2 h_1 = h_1$,
  \item $\sigma_2 \sigma_1 h_1 = \sigma_1 h_1$,
  \item $\sigma_2 h_1' = h_1'$, and
  \item $\sigma_2 \sigma_1 h_1' = \sigma h_1'$.
  \end{itemize}
  We say that a set $S \subseteq \sym_n \times H^2$ is \emph{useful} (at $g$) if
  each pair in it is useful. We say that $S$ is \emph{independent} (at $g$) if
  every two distinct elements of $S$ are mutually independent.
\end{definition}

% \begin{lem}
%   \label{lem:duel-sort-equivalence-compatible}
%   Let $H$ be a set on which an action of $\sym_n$ is defined and let $L :
%   \ind(\mathcal{D} \rightarrow H$ be a bijection. Let $\sigma_1, \sigma_2 \in
%   \sym_n$ be such that $\sigma_1 \cdot L$ is isomorphism-equivalent to
%   $\sigma_2 \cdot L$. Then for any $h, h' \in H$, $(h, h')$ is compatible with
%   $\sigma_1$ iff $(h, h')$ is compatible with $\sigma_2$.
% \end{lem}
% \begin{proof}
%   We have that $\sigma_1 \cdot L$ is isomorphism-equivalent to $\sigma_2 \cdot
%   L$, and thus there exists $\pi \in \aut(\mathcal{D})$ such that $\sigma_1
%   \cdot L \cdot \pi = \sigma_2 \cdot L $.

%   Suppose $h, h' \in H$, and suppose $(h, h')$ is compatible with $\sigma_1$.
%   Let $\vec{x} := L^{-1}(h)$ and $\vec{y} := L^{-1} (h')$. We then have that
%   $(\vec{x}, \vec{y})$ is compatible with $L^{-1} \cdot \sigma_1 \cdot L$. Let
%   $R_i$ and $R_j$ be relation symbols in the vocabulary of $\mathcal{D}$ such
%   that $\vec{x} \in R^{\mathcal{D}}_i$ and $\vec{y} \in R^{\mathcal{D}}_j$.
%   Then $L^{-1} \cdot \sigma_2 \cdot L (\vec{x}) = L^{-1} \cdot \sigma_1 \cdot
%   L (\pi \cdot \vec{x})$. But since $\pi$ is an automorphism of $\mathcal{D}$
%   we have that $\pi \cdot \vec{x} \in R_i$

%   Similarly $\sigma_2 \cdot \vec{x}' = \sigma_2 \cdot (\pi \cdot \vec{x}')$.
%   Let $i \in \dom (\vec{x})$, then $\vec{x}(i) = \vec{x}'(i)$ iff $(\sigma_1
%   \cdot \vec{x})(i) = (\sigma_2 \cdot \vec{x}')(i)$ iff $(\sigma_1 \cdot (\pi
%   \vec{x}))(i) = (\sigma_2 \cdot (\pi \vec{x}'))(i)$ iff $(\sigma_2 \cdot
%   \vec{x})(i) = (\sigma_2 \cdot \vec{x}')(i)$. The other direction follows by
%   symmetry.
% \end{proof}

% \begin{lem}
%   \label{lem:duel-sort-equivalence-compatible}
%   Let $g \in C_n$ and $\sigma_1, \sigma_1 \in \sym_n$ such that $\sigma_1
%   \cdot L(g)$ is sort-equivalent to $\sigma_2 \cdot L(g)$. Then for any $h,h'
%   \in H_g$, $(h,h')$ is compatible with $\sigma_1$ iff $(h,h')$ is compatible
%   with $\sigma_2$.
% \end{lem}
% \begin{proof}
%   Suppose $\sigma_1 \cdot L(g)$ is sort-equivalent to $\sigma_2 \cdot L(g)$.
%   Then there exists $\pi \in \sym_{A_1} \times \ldots \times \sym_{A_s}$ such
%   that $\sigma_1 \cdot L(g) (\pi \cdot \vec{x}) = \sigma_2 \cdot L(g)
%   (\vec{x})$.

%   Suppose $(h, h')$ is compatible with $\sigma_1$. Let $\vec{x} =
%   L(g)^{-1}(h)$ and $\vec{x}' = L(g)^{-1}(h')$. Then $\sigma_2 \cdot \vec{x} =
%   (L(g)^{-1} \cdot \sigma_2 \cdot L(g)) (\vec{x}) = L(g)^{-1} \cdot \sigma_1
%   \cdot L(g)(\pi \cdot \vec{x}) = \sigma_1 \cdot (\pi \cdot \vec{x})$.
%   Similarly $\sigma_2 \cdot \vec{x}' = \sigma_2 \cdot (\pi \cdot \vec{x}')$.
%   Let $i \in \dom (\vec{x})$, then $\vec{x}(i) = \vec{x}'(i)$ iff $(\sigma_1
%   \cdot \vec{x})(i) = (\sigma_2 \cdot \vec{x}')(i)$ iff $(\sigma_1 \cdot (\pi
%   \vec{x}))(i) = (\sigma_2 \cdot (\pi \vec{x}'))(i)$ iff $(\sigma_2 \cdot
%   \vec{x})(i) = (\sigma_2 \cdot \vec{x}')(i)$. The other direction follows by
%   symmetry.
% \end{proof}


% \begin{lem}
%   \label{lem:useful-independant-set}
%   Let $G$ and $G'$ be groups such that $G \leq G'$ and $\phi: G \rightarrow
%   \sym_{\ind(\tau, D)}$ be a group action. Let $S \subseteq G \times
%   \ind(\tau, D)^2$ be a useful and independent set with respect to $\phi$.
%   Then $[G' : \sortsym_D(\phi)] \geq 2^{\vert S \vert}$.
% \end{lem}

% \begin{proof}
%   For any $R \subseteq S$ define $\sigma_R = \Pi_{(\sigma, \vec{x}, \vec{y})
%   \in R} \sigma$ (with some arbitrary order assumed on $S$). We prove that the
%   mapping $R \mapsto \sigma_R \sortsym_D(\phi)$ is injective. Let $R$ and $Q$
%   be distinct subsets of $S$ and WLOG let $\vert R \vert \geq \vert Q \vert$.
%   It suffices to show that $\sigma^{-1}_Q \sigma_R \notin \sortsym (D)$. Pick
%   any $(\sigma, \vec{x}, \vec{y}) \in R \setminus Q \neq \emptyset$.
%   %   AD: the claim below doesn't follow just from independence.
%   %   GW: It seems like it does. What in particular do you think should be
%   %   added
%   %   here?
%   From independence we have $\sigma_R \cdot \vec{x} = \sigma \cdot \vec{x}$,
%   $\sigma_R \cdot \vec{y} = \sigma \cdot \vec{y}$, $\sigma_Q \sigma \cdot
%   \vec{x} = \sigma \cdot \vec{x} $, and $\sigma_Q \sigma \cdot \vec{y} =
%   \sigma \cdot \vec{y}$. By substitution we get that $\sigma^{-1}_Q \sigma_R
%   \cdot \vec{x} = \sigma^{-1}_Q \sigma \cdot \vec{x} = \sigma \cdot \vec{x}$,
%   and similarly $\sigma^{-1}_Q\sigma_R \cdot \vec{y} = \sigma \cdot \vec{y}$.
%   Thus, since $(\sigma, \vec{x}, \vec{y})$ is useful, we have that $(\vec{x},
%   \vec{y})$ is incompatible with $\sigma$ and so $(\vec{x}, \vec{y})$ is
%   incompatible with $\sigma^{-1}_Q\sigma_R$. We thus have from Lemma
%   \ref{lem:isostab-compatible} that $\sigma^{-1}_Q\sigma_R \notin
%   \sortsym_D(\phi)$.
% \end{proof}

\begin{lem}
  \label{lem:useful-independant-set}
  Let $C$ be a circuit of order $n$ and let $g$ be a gate in that circuit. If
  $S$ is a useful and independent set at $g$ then $[\sym_n : \stab_n(g)] \geq
  2^{\vert S \vert}$.
\end{lem}
\begin{proof}
  Let $\tau$ and $D$ be the vocabulary and universe of $g$ respectively. Notice
  that $\sigma \in stab_n(g)$ if, and only if, $H_g = \sigma H_g$ and $L(g)$ and
  $\sigma L(g)$ are isomorphism-equivalent. For any $R \subseteq S$ define
  $\sigma_R = \Pi_{(\sigma, h, h') \in R} \sigma$ (with some arbitrary order
  assumed on $S$). We prove that the mapping $R \mapsto \sigma_R \sortsymsub$ is
  injective. Let $R$ and $Q$ be distinct subsets of $S$ and WLOG let $\vert R
  \vert \geq \vert Q \vert$. It is sufficient to prove that $\sigma^{-1}_Q
  \sigma_R H_g \neq H_g$ or $\sigma^{-1}_Q \sigma_R L(g)$ is not
  isomorphism-equivalent to $L(g)$. We prove that if $\sigma^{-1}_Q \sigma_R H_g
  = H_g$ then $\sigma^{-1}_Q \sigma_R L(g)$ is not isomorphism-equivalent to
  $L(g)$.

  Pick any $(\sigma, h, h') \in R \setminus Q \neq \emptyset$. From independence
  we have $\sigma_R h = \sigma h$, $\sigma_R h' = \sigma h'$, $\sigma_Q sigma h
  = \sigma h $, and $\sigma_Q sigma h = \sigma h$. Thus $\sigma^{-1}_Q \sigma_R
  h = \sigma^{-1}_Q \sigma h = \sigma h$, and similarly $\sigma^{-1}_Q\sigma_R
  h' = \sigma h'$. Thus, since $(h, h')$ is incompatible with $\sigma$, it
  follows $(h, h')$ is incompatible with $\sigma^{-1}_Q\sigma_R$. So Lemma
  \ref{lem:isostab-compatible} gives us that $\sigma^{-1}_Q \sigma_R L(g)$ is
  not isomorphism-equivalent to $L(g)$ and the result follows.
\end{proof}




%
% $determines a set of automorphisms of $\mathcal{D}$, all of which are equal
% when their domain in restricted to $\mathcal{D}_R$. Let $s$ be a sort symbol
% in the vocabulary of $\mathcal{D}$. Let $\sigma \in \isostab(L(g))$ determine
% $\sigma' \in \aut (\mathcal{D})$. Then

% Let $R_i$ be a relation symbol in the vocabulary of $\Sigma(g)$. Then there is
% an action of $\sigma$[\arty(R_i)]$


% \begin{lem}
%   \label{lem:useful-independant-set}
%   Let $g \in C_n$. Let $S$ be a useful and independent. We then have that $[
%   \sym_n: \isostab(L(g)) ] \geq 2^{\vert S \vert}$.
% \end{lem}

% \begin{proof}
%   For any $R \subseteq S$ define $\sigma_R = \Pi_{(\sigma, h, h') \in R}
%   \sigma$ (with some arbitrary order assumed on $S$). Let $R$ and $Q$ be
%   distinct subsets of $S$ and WLOG let $\vert R \vert \geq \vert Q \vert$. We
%   want to show that $\sigma_R L(g)$ is not isomorphism-equivalent to $
%   \sigma_Q L(g)$. Pick any $(\sigma, h, h') \in R/Q \neq \emptyset$. From
%   independence we have $\sigma_R h = \sigma h$ and $\sigma_R h' = \sigma h'$,
%   and from the fact that $(\sigma, h,h')$ is useful, we have that $(h,h')$ is
%   incompatible with $\sigma_R$. Moreover, the fact that $\sigma_Q h = h$ and
%   $\sigma_Q h' = h'$ makes it easy to see $(h,h')$ is compatible with
%   $\sigma_Q$. The result then follows from Lemma
%   \ref{lem:duel-sort-equivalence-compatible}.
% \end{proof}

% \begin{claim}
%   \label{claim:useful-independant-set}
%   Let $g \in C_n$. Let $S$ be a useful and independent. We then have that
%   $\vert \sym_n: \sortstab(g) \vert \leq 2^{\vert S \vert}$.
% \end{claim}

% \begin{proof}
%   Let $R \subseteq S$ and define $\sigma_R = \Pi_{(\sigma, h, h') \in R}
%   \sigma$ (with some arbitrary order assumed on $S$). Let $R$ and $Q$ be
%   distinct subsets of $S$ and WLOG let $\vert R \vert \geq \vert Q \vert$. We
%   want to show that we don't have $\sigma_R \omega \sim_\omega \sigma_Q
%   \omega$. Pick any $(\sigma, h, h') \in R/Q \neq \emptyset$. Given that
%   $\sigma_R h = \sigma h$ and $\sigma_R h' = \sigma h'$ it is easy to see that
%   the usefulness of $(\sigma, h,h')$ implies the incompatibility of $(h,h')$
%   with with $(\omega, \sigma_R)$. Moreover, the fact that $\sigma_Q h = h$ and
%   $\sigma_Q h' = h'$ makes it easy to see $(h,h')$ is compatible with
%   $(\omega, \sigma_Q)$. From the above lemma we may conclude that that we do
%   not have $\sigma_R \sim_\omega \sigma_Q$, and the result follows.
% \end{proof}

The following two lemmas are proved by Anderson and Dawar \cite{AndersonD17},
and are both useful for proving the support theorem. The following lemma is used
to establish a size bound on the supporting partition of a gate. In particular,
it shows that for a partition $\mathcal{P}$ of $[n]$, if the index of $\setstab
(\mathcal{P})$ in $\sym_n$ is small enough, then $\mathcal{P}$ either contains
very few or very many parts.

\begin{lem}[{\cite[Lemma 5]{AndersonD17}}]
  \label{lem:big-or-small}
  For any $\epsilon$ and $n$ such that $0 < \epsilon < 1$ and $\log n \geq
  \frac{4}{\epsilon}$, if $\mathcal{P}$ is a partition of $[n]$ with $k$ parts,
  $s = [\sym_n : \setstab (\mathcal{P})]$ and $n \leq s \leq
  2^{n^{1-\epsilon}}$, then $\min \{k, n-k\} \leq \frac{8}{\epsilon} \frac{\log
    s}{\log n}$.
\end{lem}

The following lemma tell us that, under the same assumptions as the previous
lemma, if the number of parts in $\mathcal{P}$ is less then $\frac{n}{2}$ then
$\mathcal{P}$ contains a very large part. This lemma is used both to establish
that the stabiliser group of a gate has small support, and hence a canonical
support, but also that this canonical support has bounded size (and is in fact
constant for polynomial-size circuits).

\begin{lem}[{\cite[Lemma 6]{AndersonD17}}]
  \label{lem:small-means-support}
  For any $\epsilon$ and $n$ such that $0 < \epsilon < 1$ and $\log n \geq
  \frac{8}{\epsilon^2}$, if $\mathcal{P}$ is a partition of $[n]$ with $\vert
  \mathcal{P} \vert \leq \frac{n}{2}$, $s:= [\sym_n : \setstab (\mathcal{P})]$
  and $n \leq s \leq 2^{n^{1-\epsilon}}$, then $\mathcal{P}$ contains a part $P$
  with at least $n - \frac{33}{\epsilon} \cdot \frac{\log s} {\log n}$ elements.
\end{lem}

% Let $C$ be a symmetric circuit of order $n$ with unique labels. Let $\SP(C)$
% denote the maximum $\| \SP(g) \|$ over all gates $g$ in $C$. Let $g$ be a gate
% in $C$, and suppose $\Sigma (g)$ is a $(\tau, D)$-structured function. Define a
% group action $\phi_g : \stab_n (H_g) \rightarrow \sym_{\ind(\tau, D)}$ for
% $\sigma \in \stab_n(H_g)$ by $\sigma \cdot_{\phi_g} \vec{x} := L(g)^{-1} \sigma
% L(g) (\vec{x})$ for all $\vec{x} \in \ind(\tau,D)$. Since $C$ has unique labels,
% we have for $\sigma \in \sym_n$ that $\sigma (g) = g$ if, and only if, $\sigma
% H_g = H_g$ and $\sigma L(g)$ is isomorphism-equivalent to $L(g)$, which holds
% if, and only if, $\sigma \in \sortsym_$. It follows from the
% orbit-stabiliser theorem that $\vert \orb (g) \vert = [\sym_n : \stab_n(g)] =
% [\sym_n : \sortsym_D(\phi_g)]$.

\begin{thm}
  \label{thm:support_thm}
  For any $\epsilon$ and $n$ such that $\frac{2}{3} \leq \epsilon \leq 1$ and $n
  \geq \frac{128}{\epsilon^2}$, if $C$ is a symmetric circuit of order $n$ with
  unique labels and $s := \max_{g \in C} \vert \orb (g)\vert \leq
  2^{n^{1-\epsilon}}$, then, $\SP(C) \leq \frac{33}{\epsilon}\frac{log s}{log
    n}$.
\end{thm}

\begin{proof}
  First we note that if $1 \leq s < n$, then $C$ cannot have a relational gate,
  as the orbit of a relational gate has at least $n$ elements. Since $C$ has no
  relational gates, the only input gates in the circuit are the constant gates.
  Since constant gates are fixed by all permutations, it follows that any gate
  $g$ whose children are constant gates must similarly be fixed under all
  permutations. Furthermore, from the fact that $C$ has unique labels, and hence
  unique extensions, this property inductively extends to the rest of the
  circuit. Thus for each gate $g$ in $C$ the partition $\{[n]\}$ supports $g$,
  and since this is trivially the coarsest such partition it follows that $\|
  \SP(g) \| = 0 = \SP(C)$. We therefore assume that $s \geq n$.

  If $g$ is a gate in $C$ then $\stab (g) \subseteq \setstab(\SP(g))$, and so $s
  \geq \vert \orb(g) \vert = [\sym_n : \stab(g)] \geq [\sym_n :
  \setstab(\SP(g))]$. Thus if $\vert \SP(g) \vert \leq \frac{n}{2}$, then from
  Lemma \ref{lem:small-means-support}, we have $\| \SP (g) \| \leq
  \frac{33}{\epsilon} \cdot \frac{\log s} {\log n}$. The result thus follows
  from showing that for each $g$ in $C$ we have that $\vert \SP (g) \vert \leq
  \frac{n}{2}$.
  
  If $g$ is a constant gate, then as argued above, it follows $\vert \SP(g)
  \vert = 0 < \frac{n}{2}$. If $g$ is a relational gate, then $g$ is fixed by a
  permutation $\sigma \in \sym_n$ if, and only if, $\sigma$ fixes all elements
  that appear in $\Lambda(g)$. It follows that $\{a\} \in \SP(g)$ for each $a$
  appearing in $\Lambda(g)$ and all other elements of $[n]$ are contained in a
  single part of $\SP(g)$. But suppose $\vert \SP(g) \vert > \frac{n}{2}$. Then
  the number of singletons in $\SP(g)$ must be larger than $\frac{n}{2}$, which
  in turn, from the orbit-stabiliser theorem, gives us that $ s \geq \vert \orb
  (g) \vert \geq \frac{n!}{(n-\vert \Lambda (g) \vert)!} \geq
  \frac{n!}{{(\frac{n}{2}})!} \geq 2^{\frac{n}{4}} > 2^{n^{1- \epsilon}} $. This
  is a contradiction, and so $\vert \SP(g) \vert \leq \frac{n}{2}$.

  We now consider the internal gate case. Let $g$ be the topologically first
  internal gate with $\vert \SP(g) \vert > \frac{n}{2}$. Let $k' := \lceil
  \frac{8 \log s}{\epsilon \log n} \rceil$. From the assumptions on $s$, $ n$
  and $\epsilon$ we have that $k' \leq \frac{1}{4}n^{1-\epsilon} < \frac{n}{2}$.
  We note that Lemma \ref{lem:big-or-small} implies that $n - \vert \SP(g) \vert
  \leq k'$.
  
  We now construct a sufficiently large useful and independent set of triples
  which, using Lemma \ref{lem:useful-independant-set}, allows us to place a
  lower bound on the orbit size of $g$. Divide $[n]$ into $\lfloor \frac{n}{k' +
    2} \rfloor$ disjoint sets $S_i$ of size $k' + 2$ and ignore the elements
  left over. It follows that for each $i$ there is a permutation $\sigma_i$
  which fixes $[n] \setminus S_i$ pointwise but moves $g$. Suppose there was no
  such $\sigma_i$, but then every permutation that fixes $[n]\setminus S_i$
  pointwise fixes $g$. Thus the partition of all the singletons in $[n]\setminus
  S_i$ and $S_i$ is a supporting partition of $g$. As $\SP(g)$ is the coarsest
  such partition it follows that $\vert \SP(g) \vert \leq n - (k'+2) + 1 = n -
  k' - 1$, which contradicts the inequality $n - \vert \SP(g) \vert \leq k'$.

  Since $g$ is moved by each $\sigma_i$, and $C$ has unique labels, it follows
  that $\sigma_i$ does not act like an automorphism at $g$. Thus, from Lemma
  \ref{lem:isostab-compatible}, and the fact that the circuit has unique labels,
  there exists $(h_i, h_i') \in H_g$ such that $(h_i, h_i')$ is not consistent
  with $sigma_i$, and so the triple $(\sigma_i, h_i, h_i')$ is useful.

  % AD: I haven't changed this below in case I'm just confused. But, isn't
  % \SP(h)^* just a new notation for \sp(h)?
  % I defined sp(h) for the case where the largest part is larger than
  Note that our choice of $g$ guarantees that for all $h \in H_g$, $\vert h
  \vert \leq \frac{n}{2}$, and so, from Lemma \ref{lem:small-means-support} and
  the hypothesis of this theorem, $h$ has small support. Let $Q_i = \consp(h_i)
  \cup \consp(\sigma_i h_i) \cup \consp(h_i') \cup \consp(\sigma_i h_i')$. Then
  note that if $\sigma_j$ fixes $Q_i$ pointwise then by construction we have
  that $\sigma_j \in \stab(\SP(h_i)) \cap \stab(\SP(\sigma_i h_i)) \cap
  \stab(\SP(h_i')) \cap \stab(\SP(\sigma_i h_i'))$

  Define a directed graph $K$ with vertices given by the sets $S_i$ and an edge
  from $S_i$ to $S_j$ (with $i \neq j$) if, and only if, $Q_i \cap S_j \neq
  \emptyset$. It follows then that if there is no edge from $S_i$ to $S_j$ then
  $Q_i \subseteq [n]\setminus S_j$, and so $\sigma_j$ fixes $Q_i$ pointwise,
  giving us that $(\sigma_i, h_i, h_i'$ and $(\sigma_j, h_j, h_j')$ are mutually
  independent. It remains to argue that $K$ has a large independent set. This is
  possible as the out-degree of $S_i$ in $K$ is bounded by
  \begin{align*}
    \vert Q_i \vert \leq \|\SP(h_i) \| + \|\SP(\sigma_i h_i) \| + \|\SP(h_i') \| + \|\SP(\sigma_i h_i') \leq 4 \cdot \frac{33\log s}{\epsilon \log n}.
  \end{align*}
  These inequalities follow from the fact that the sets $S_i$ are disjoint and
  we may apply Lemma \ref{lem:small-means-support} to each of the child gates.
  From these inequalities we have that the average total degree (in + out
  degree) of $K$ is at most $2 \cdot \vert Q_i \vert \leq 34 \cdot k'$. Now
  greedily select a maximal independent set in $K$ by repeatedly selecting $S_i$
  with the lowest total degree and eliminating it and its neighbours. This
  action does not affect the bound on the average total degree of $K$ and hence
  determines an independent set $I$ in $K$ of size at least
  \begin{align*}
    \frac{\lfloor \frac{n}{k' + 2} \rfloor}{34k' + 1} \geq \frac{n - (k'+2)}{34k'+1k'+2} \geq \frac{n\frac{7}{16}}{34k'^2 + 69k' +2} \geq \frac{n}{(16k')^2}.
  \end{align*}

  Take $S = \{(\sigma_i, h_i, h_i') : S_i \in I \}$. Then from the above
  argument we have that $S$ is useful and independent.
  
  Moreover, from Lemma \ref{lem:useful-independant-set}, we have that $s \geq
  \vert \orb(g) \vert \geq 2^{\vert S \vert} \geq 2^{\frac{n}{(16k')^2}}$ then
  $n^{1-\epsilon} \geq \log s \geq n \cdot (\frac{128}{\epsilon}\frac{\log
    s}{\log n})^{-2} > n \cdot (n^{1-\epsilon})^{-2} = n^{2\epsilon -1} \geq
  n^{1-\epsilon}$. This is a contradiction, and the result follows.
\end{proof}
 
Let $\mathcal{C} = (C_n)_{n \in \nats}$ be a polynomial-size family of symmetric
circuits with unique labels. Then $s(n) := \max_{g \in C_n} \vert \orb (g)\vert$
must be polynomially bounded, and so the theorem implies that there exists $k
\in \nats$ such that for all $n$ large enough, for all $g \in C_n$, $\vert
\consp(g) \vert \leq k$.

\begin{cor}
  Let $\mathcal{C} := (C_n)_{n \in \nats}$ be a polynomial-size family of
  symmetric circuits with unique labels. Then $n \mapsto \SP(C_n) \in O(1)$.
  \label{cor:constant-size-support}
\end{cor}

% If $\mathcal{C} := (C_n)_{n \in \mathbb{N}}$ with bijective labels, we can
% extend the action of $\sigma \in \sym_n$ on the gates of $C_n$ to the sorts of
% the indexes of those gates. Let $g \in C_n$ and $(\tau, A) := \type(g)$ and
% let $A_1, \ldots, A_s$ be the sorts of $A$. Note that for any $h_1, h_2 \in
% H_g$, and $i \in [r_i]$ $L(g)(h_1)(i, R_j)$ For all $i \in [s]$, we can define
% the action of $\sigma \in \sym_n$ on $A_i$ by $\sigma (a) = L(g)()$

% $a_i \in A_$

Let $C$ be a symmetric circuit of order $n$ with unique labels and $g$ be a gate
in the circuit. Let $\tau$ and $D$ be the vocabulary and universe of $g$,
respectively. We have defined an action $\sym_n$ on the input gates, and, since
this circuit is symmetric and has unique labels, we know that each permutation
extends uniquely to an action on the whole circuit. We have also defined an
action of $\setstab_n(H_g) \leq \sym_n$ on $\ind(\tau, D)$. We have also noted
that $\sigma \in \stab_n(g)$ if, and only if, $\sigma in \setstab_n(H_g)$ and
$\sigma$ acts like an isomorphism at $g$. We can thus associate with each
permutation $\sigma \in stab_n(g)$ a unique element $\pi_\sigma \in \sortsymsub$
such that $\sigma \cdot \vec{x} = \pi_{\sigma} (\vec{x})$. This fact allows us
to define an action of $\stab_n(g)$ on $D$ by $\sigma \cdot a = \pi_\sigma(a)$
for each $a \in D$.

We use $\stab_{\stab(g)}(a)$ and $\orb_{\stab(g)}(a)$ to denote the stabiliser
group and orbit of $a \in D$ with respect to this action. We often abbreviate
these two groups to $\stab_{g}(a)$ and $\orb_{g}(a)$ when no ambiguity would
arise. We also let $\SP_g(a)$ and $\consp_g(a)$ denote the canonical supporting
partition and canonical support of $\stab_g(a)$. When no ambiguity would arise
we drop the subscript gate.

Let $a \in D$, and $h \in H_g$ such that $a \in \vec{a} := (a_1, \ldots , a_r)
:= L(g)^{-1}(h)$ then $stab_n(h) \cap \stab_n(g) = \stab_g(h) = \bigcap_{i \in
  [r]}\stab_g(a_i)$. From the Support Theorem and the fact that
$\stab_n(\consp(h) \cup \consp(g)) \leq \stab_n(h) \cap \stab_n(g)$, we have
that for large enough $n$, $\stab_n(h) \cap (\stab_n(g))$ must have small
support. Thus, from Lemma \ref{lem:row-column-supports-well-behaved} we have
that $\stab_g(h)$ must have canonical support $\consp(h) \cup \consp(g)$.
Moreover, by repeated application of Lemma
\ref{lem:row-column-supports-well-behaved}, it follows that each $a_i$ also has
small support for large enough $n$ and $\consp(a) \subseteq \bigcup_{i \in
  [r]}\consp(a_i) = \consp(h) \cup \consp(g)$ for each $i \in [r]$. We summarise
this observation in the following lemma.

\begin{lem}
  Let $C$ be a symmetric circuit with unique labels and let $n_0$ be a constant
  sufficient for application of the Support Theorem. Let $g$ be a gate in $C$,
  let $h \in H_g$ and let $(a_1, \ldots, a_r) := L(g)^{-1}(h)$. Then $\consp(h)
  \cup \consp(g) = \bigcup_{i \in [r]} \consp(a_i)$.
  \label{lem:row-column-supports}
\end{lem}

We may apply Lemma \ref{lem:row-column-supports} in order to generalise
Corollary \ref{cor:constant-size-support}.

\begin{cor}
  Let $\mathcal{C} := (C_n)_{n \in \nats}$ be a polynomial-size family of
  symmetric circuits with unique labels and let $n_0$ be the constant from the
  Support Theorem. Then there exists $k$ such that for all $n > n_0$, $g$ a gate
  in $C_n$, and $a$ in the universe of $g$, $\vert \consp_g(a) \vert \leq 2*
  \SP(C) \leq k$.
  \label{col:constant-size-support-for-everything}
\end{cor}





% Let $C_n$ be a rigid symmetric circuit with bijective labels. We now extend
% the given action of $\sym_n$ on the gates of $C_n$ to the indexes. Let $g$ be
% a gate in $C_n$, and let $(\tau, D) := \type(g)$. Note that the action of any
% permutation in $\stab(g)$ on the circuit fixes $H_g$ setwise. Therefore the
% action of $\stab(g)$ on $H_g$ induces an action of $\stab(g)$ on $\ind(\tau,
% D)$. Moreover, since $\stab(g) = \sortsym_n(D)$, it follows that $\stab(g)$
% acts on $\ind(\tau, D)$ as a sorted permutation.

% For $x \in D$ let $\stab_g(x) = \{\sigma \in \stab(\consp(g)) : \sigma (x) =
% x\}$ and let $\consp_g(x)$ be the canonical support of $\stab_g(x)$. We call
% $\consp_g(x)$ the canonical support of $x$ with respect to $g$. In the event
% that the gate $g$ is clear from context we omit the subscript. If $h \in H_g$
% and $(x_1, \ldots ,x_r) := L(g)^{-1}(h)$ then $\stab(h) \cap \stab(g) =
% \stab_{\stab(g)}(h) = \bigcap_{i \in [r]} \stab_g(x_i)$. If $\stab(h) \cap
% \stab(g)$ has small support, then from Lemma
% \ref{lem:row-column-supports-well-behaved} it has canonical support $\consp(h)
% \cup \consp(g)$. Moreover, if $\stab(h) \cap \stab(g)$ has small support, then
% $\stab_g(x_i)$ for all $i \in [r]$ and $\consp(g) \cup \consp(h) = \bigcup_{i
% \in [r]}\consp_g(x_i)$. This follows from repeated application of Lemma
% \ref{lem:row-column-supports-well-behaved}. As such, we may apply the support
% theorem to the elements of $D$ for large enough $n$.

% REVIEW THIS BIT, MORE WORK MAY BE NEEDED.

% It follows that for each gate $g$ and $h \in H_g$, $\stab(h) \subseteq
% \stab(L(g)^{-1}(h))$. Thus all supports and supporting partitions of $h$ are
% also supports or supporting partitions of $L(g)^{-1} (h)$, which allows us to
% translate the support theorem to elements of the index of $g$. Suppose
% $\Sigma(g)$ is a $(\tau, D)$-structured function. Notice that $\stab
% (\consp(g)) \subseteq \stab (g) = \sortsym_n(D)$, and so each $\sigma \in
% \stab(g)$ may be thought of as a sorted-permutation of $D$, defining an action
% of $\stab(g)$ on $D$. Furthermore, if $h \in H_g$ and $L(g)^{-1}(h) = (x_1,
% \ldots , x_{r_i}) \in \ind(\tau, D)$ then $\stab_{\stab(g)}(h) =
% \stab_{\stab(g)}(x_1) \cap \ldots \cap \stab_{\stab(g)}(x_k)$


% there exists $\pi_{\sigma} \in \sortsym(D)$ such that $\pi_\sigma \cdot
% \vec{x} = \sigma \cdot \vec{x}$ for all $\vec{x} \in \ind(\tau, D)$. It
% follows that we can define an action of $\stab(\consp(g))\leq \sym_n$ on $D$
% defined for $\sigma \in \stab(g)$ by $\sigma \cdot a := \pi (a)$ for all $a
% \in D$. Mo


% Thus there is a well-defined action of $\sym_n$ on the set of all elements in
% the universe of $\mathcal{D}$ that appears in some relation. It follows that
% $\sigma$ defines a action on the elements of the universe of $\mathcal{D}$
% that appear in some relation, and also this action extends to an automorphism
% of $\mathcal{D}$. Thus for each $a \in \mathcal{D}$ we may speak For any
% $\sigma \in \stab(\consp(g)) \subseteq \aut_n(\mathcal{D})$, $\sigma$ fixes
% $g$ and hence permutes $H_g$ and acts as an automorphism. Then $\sigma$
% $\mathcal{D}$

\end{document}
