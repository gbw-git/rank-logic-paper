\documentclass[../paper.tex]{subfiles}
\begin{document}
Recall that each gate $g$ in a cricuit  is associated with a structure
$D$ with the elements of the relations in $D$, i.e.\ $\ind(\Sigma(g))$
labelled by the children of $g$.  Many of the properties of circuits
that are central to our construction, and we wish to be able to decide
efficiently, particularly those that reference circuit automorphisms or
syntactic-equivalence, depend on the existence of isomorphisms that agrees with a
given permutation of the gates labelling the structure.  This introduces a
potential difficulty as there is no known polynomial-time algorithm for the
general isomorphism problem, but we we require many of these circuit properties
to be polynomial-time decidable in order to define our translation from circuits
to formulas (see Section~\ref{sec:circuits-to-formulas}).  This is not a problem
if we restrict our attention to circuits with symmetric gates, as
in~\cite{AndersonD17}, as in this case the structures of interest are
sets, and set equivalence is clearly decidable in polynomial-time.  When we
allow for circuits to be defined over bases including non-symmetric functions it
is not obvious that these properties can be decided in polynomial-time.

This is the reason we introduced the notion of a transparent circuit. The idea
is that for transparent circuits the structures associated with each
non-symmetric gate have the property that each element of each relation is
labelled by a `unique' gate (i.e.\ such that no elements are labelled by gates
from the same syntactic-equivalence class). In this case a permutation of the
gates in the circuit defines exactly one function between the elements of the
relations of these structures, and so checking for the existence of an
isomorphism that agrees with the permutation is reduced to the problem of
determining if a given function is in fact an isomorphism. This problem is
polynomial-time tractable.

In the first part of this section we prove that the requisite circuit properties
are indeed polynomial-time decidable for transparent circuits. We then use these
results to define a polynomial-time computable translation from transparent
circuits to equivalent circuits with unique labels. As discussed in
Section~\ref{sec:symm-circ}, this translation allows us to restrict our
attention from transparent circuits to circuits with unique labels when working
with families of circuits without a loss of generality. This restriction is
important for two reasons. First, circuits with unique labels have unique
extensions, which enables us to apply the support theorem. Second, as we
show in this section, all relevant symmetry-related circuit properties are
polynomial-time decidable for circuits with unique labels. We use all of these
properties in order to define our translation from circuits to formulas in
Section~\ref{sec:circuits-to-formulas}.

In Section~\ref{sec:necessity} we discuss more formally the relationship
between the problem of deciding many of these natural circuit properties and the
graph-isomorphism problem. In particular, we present reductions from the
graph-isomorphism problem to the problems of deciding each of these circuit
properties for general circuits. It follows that deciding most of these circuit
properties is as hard as the graph isomorphism problem---a problem not known to be
in $\PT$, showing that some condition like transparency is necessary.  We also show that most of these hardness results are quite robust, in
that even if we restrict our attention to other natural classes of circuits
(e.g.\ circuits with unique children or circuits with injective labels) these
decision problems remain at least as hard as the graph-isomorphism problem.
In this sense, while the first part of this section provides evidence in favour of the
sufficiency of the restriction to transparent circuits, the second part provides
evidence in favour of its necessity.

% In Section~\ref{sec:circuits-to-formulas} we use the polynomial-time
% decidability of these properties, along with the Immerman Vardi theorem, in
% order to define a translation from circuit families to formulas of $\FPR$. The
% results in this section thus justify the restriction to trans


% the results in this section are useful both are useful needed for proving the
% main result and help explain why it is that we need to restrict ourselves to
% transparent circuits, rather than working with general circuits.


% Since the proof of the main result makes use of the polynomial-time
% decidability of many of these properties, these results help explain both why
% transparent circuits suffice for the proof of our main result and why general
% circuits

% The restriction to transparent circuits is not found in the analogous circuit
% characterisation of $\FPR$ by Anderson and Dawar~\ref{AndersonD17}.




% In the first part of this section we show that a number of natural, and
% useful, circuit properties (e.g. symmetry, syntactic-equivalence) are
% polynomial-time decidable for transparent circuits. In
% Section~\ref{sec:circuits-to-formulas} we use the polynomial-time decidability
% of these properties, along with the Immerman-Vardi theorem, in order to define
% a translation from families of circuits to formulas. We show in
% Section~\ref{sec:formulas-to-circuits} that we can translate formulas to
% families of transparent circuits. It follows that $\PT$-uniform families of
% circuits suffice for our purposes.


% In the second part of this section we justify the necessity of this
% restriction, showing that most of these circuit properties for general
% circuits (with non-symmetric gates) are at least as hard as the
% graph-isomorphism problem. Since the proof of the main theorem makes use of
% the polynomial-time decidability of many of these properties, these results
% together justify the inclusion of the transparency restriction.


% The second part of this

% used to translate circuit families

% Importantly, our proof of the main result makes use of the polynomial-time
% decidability of these properties.

% many natural show that a great number of


% justify this restriction to transparent circuits, first showing that In this
% section we justify this restriction, showing first that the a great number of
% very useful circuit properties (e.g. syntactic-equivalence) are
% polynomial-time decidable for transparent circuits


% The transparency condition is a restriction on how non-symmetric gates are
% wired into the circuit, and so all circuits with symmetric gates are
% transparent. The circuit we have introduced includes

% We have thought of a gate $g$ with a vocabulary $\tau$ in a circuit $C$ as
% labelling its children using elements of the $\ind(g)$ (i.e\ the elements of
% the relations of the $\tau$-structure defined at $g$). We could invert this
% thinking, and instead think of the children of $g$ as labelling the elements
% of $ind(g)$, and so defining at $g$ a $\tau$-structure with a labelling on the
% elements of its relations. In particular, if $g$ is a rank-gate then $g$
% defines a complete bipartite graph labelled by the children of $g$.

% The idea is that a gate $g$ with a vocabulary $\tau$ in a circuit $C$ defines
% a labelled $\rho$-structure, where the labels are the syntactic-equivalence
% classes of the children of $g$.


% the restriction to transparency enables us to decide many natural circuit
% properties in polynomial-time (e.g.\ the orbit of a gate, whether the circuit
% is symmetric, etc.). important point is that in order to decide many
% properties of the circuit that we need in order to prove the main result
% (e.g.\ )

% In this section we justify this restriction, showing first that the a great
% number of very useful circuit properties (e.g. syntactic-equivalence) are
% polynomial-time decidable for transparent circuits and, second, that deciding
% most of these circuit properties for general circuits (with non-symmetric
% gates) is at least as hard as the graph-isomorphism problem. Since the proof
% of the main theorem makes use of the polynomial-time decidability of many of
% these properties, these results together justify the inclusion of the
% transparency restriction


\subsection{Tractable Properties of Transparent Circuits}
In this subsection we show that many useful circuit properties are
polynomial-time decidable for transparent circuits. First, we prove that the
syntactic-equivalence relation is polynomial-time computable for transparent
circuits. We use this result to show that transparent circuits can be
transformed in polynomial-time into equivalent circuits with unique labels. We
show that for circuits with unique labels we can compute in polynomial-time the
action of a given automorphism on the circuit, the orbits and supporting
partitions of each gate, as well as the orbits and supporting partitions of each
element of the universe of each gate. We make use of all of these results in
order to define a translation from circuit families to formulas of $\FPR$ in
Section~\ref{sec:circuits-to-formulas}.

% The purpose of this section in then to show that we may transform tranparent
% circuits to circuits with unique labels, and since circuits with unique
% extension

% the function that computes circuits with unique labels

% We show that the set of transparent circuits, the set of circuits with unique
% labels, and the set of symmetric transparent circuits are all polynomial-time
% decidable. Moreover, we show that for circuits with unique labels

% and hence that the the action of a and the orbit and supporting partition of a
% gate are polynomial-time computable, . We also present polynomial-time
% algorithms for computing the action of a permutation on a symmetric circuit,
% as well as for computing the orbits and supports of gates, and elements of
% universes of gates, in a circuit.

% We use the polynomial-time decidability of many of these properties throughout
% this paper, and particularly for our translation of circuits into formulas.
% For example, the polynomial-time decidability of the syntactic-equivalence
% relation enables us to transform transparent circuits into circuits with
% unique labels (and so unique extensions) in polynomial-time. This result
% allows us, when working with $\PT$-uniform families of transparent circuits,
% to assume without a loss of generality that these circuits have unique labels
% and unique extensions. This is a crucial step in the proof of our main result,
% as the unique labels requirement is needed to apply the support theorem, and
% the unique extensions property is necessary for applying (and even defining) a
% great many technical tools (e.g. supports and supporting partitions) used
% extensively throughout this paper.

We now show that the syntactic-equivalence relation can be computed in
polynomial time for transparent circuits.

\begin{lem}
  There is an algorithm that takes as input a transparent circuit $C$ and
  outputs the syntactic-equivalence relation on the gates of $C$. The algorithm
  runs in time polynomial in the size of $C$.
  \label{lem:transparent-syntactic-equiv}
\end{lem}
\begin{proof}
  Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a transparent
  $(\mathbb{B}, \rho)$-circuit of order $n$. We define the syntactic-equivalence
  relation on $G$ by induction on the depth of a gate. We note that this
  definition by induction can be implemented as a construction, with the
  induction defining a dynamic program.
  
  Suppose $g$ and $h$ are gates in $C$ such that $\Sigma (g) = \Sigma(h)$ and
  either both $g$ and $h$ are output gates and $\Omega^{-1}(g) = \Omega^{-1}(h)$
  or neither are output gates. Let $g$ and $h$ be input gates, then set $g
  \equiv h$ if, and only if, both $g$ and $h$ are constant gates or both are
  relational gates and $\Lambda(g) = \Lambda (h)$. Let $g$ and $h$ be internal
  gates and suppose we have defined the syntactic-equivalence relation for all
  gates of depth less than the depth of either $g$ or $h$. Then $g \equiv h$ if,
  and only if, $L(g)$ and $L(h)$ are isomorphic up to $\equiv$.

  The above algorithm can be implemented by a dynamic program with the number of
  iterations bounded by the number of pairs of gates in $C$, i.e.\ ${\vert C
    \vert} \choose{2}$. It remains to show that there is an algorithm that runs
  in time polynomial in the size of the circuit and takes as input two gates $g$
  and $h$ in $C$ and the syntactic-equivalence relation for all gates of depth
  less than either $g$ or $h$ and returns whether or not $g \equiv h$. We now
  sketch a definition of this algorithm.
  
  Let $g$ and $h$ be two internal gates in $C$ and suppose we have defined the
  syntactic-equivalence relation for all gates of depth less than the depth of
  either $g$ or $h$. We check all of the conditions for syntactic-equivalence
  with the exception of the isomorphism condition, and any of them fail to hold
  we halt and output that $g \not\equiv h$.

  We now define a function $f: \ind(g) \rightarrow \ind(h)$ as follows. Let
  $\{x_1, \ldots, x_{\vert \ind(g)\vert}\}$ be an ordering of $\ind(g)$. For
  each $i \in \vert \ind(g) \vert$ select $y_i \in \ind(h)$ such that $y_i \neq
  y_j$ for all $j \in [i-1]$ and $L(g)(x_i) \equiv L(h)(y_i)$. If at any point
  we cannot select an appropriate $y_i$, halt and output that $g \not\equiv h$.
  For each $i \in \vert \ind(g) \vert$ let $f(x_i) = y_i$. From the definition
  of the function $f$ is injective. Check if $f$ is surjective. If not, halt and
  output that $g \not\equiv h$. We thus have that $f$ is a bijective function
  and for all $x \in \ind(g)$, $L(g)(x) \equiv L(h)(f(x))$. Check if $g$
  and $h$ are both symmetric gates. If so, $f$ witnesses the required
  isomorphism-equivalence and so we halt and output that $g \equiv h$.

  We thus have that $g$ and $h$ are non-symmetric gates. Then, since $C$ is
  transparent, both $g$ and $h$ have unique labels. In that case the function
  $f$ is the only function such that for all $x \in \ind(g)$, $L(g)(x) \equiv
  L(h)(f(x))$. It follows that $g \equiv h$ if, and only if, $f$ defines an
  isomorphism from $\str{g}$ to $\str{h}$. This is easy to check.
\end{proof}

 We now define what it means to take a
quotient of a circuit by the syntactic-equivalence relation. Intuitively, we
think of a quotient of a given circuit as being formed by `merging' each
syntactic-equivalence class into a single gate and including a wire between two
gates in the quotient circuit if, and only if, there is a wire between an
element of each equivalence class.

\begin{definition}
  Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a $(\BB,
  \rho)$-circuit. A \emph{quotient of $C$} is a $(\BB, \rho)$-circuit $C_\equiv
  := \langle G_\equiv , \Omega_\equiv, \Sigma_\equiv , \Lambda_\equiv, L_\equiv
  \rangle$, where $G_\equiv = G /_\equiv$, $\Omega_\equiv = \Omega /_\equiv$,
  $\Sigma = \Sigma /_\equiv$, $(\Lambda_\equiv)_R = \Lambda_R /_\equiv$ for all
  $R \in \rho$, and for all $[g] \in G_\equiv$ there exists $g' \in [g]$ such
  that, $L_\equiv$ associates with $[g]$ a function $L_\equiv([g]) : \ind(g')
  \rightarrow G_\equiv$ where $L_\equiv([g]) = L(g')/_\equiv$.
\end{definition}

We should note that the there is no obvious quotienting operation that
associates with each circuit a unique quotient circuit. However, it is easy to
see that if $C$ and $C'$ are distinct quotients of a given circuit then the only
point where they differ is in the definition of their respective labelling
functions. But it is not hard to see that for every gate $g$ in $C$, $L(g)$ and
$L'(g)$ are isomorphic.  It follows that these two circuits are
isomorphic in the precise sense alluded to right after Definition~\ref{defn:automorphism}.

We now show that taking the quotient of a circuit preserves important
properties, including the function computed by the circuit, the symmetry of the
circuit, and whether the circuit has unique labels. We also show that the
quotient of a circuit is reduced, and hence has unique children (and so, from
Proposition~\ref{prop:unique-children-unique-extensions}, unique extensions).

\begin{lem}
  Let $C := \langle G, \Omega, \Sigma, \Lambda, L\rangle$ be a $(\BB,
  \rho)$-circuit of order $n$ and $C_{\equiv} = \langle G_\equiv ,
  \Omega_\equiv, \Sigma_\equiv , \Lambda_\equiv, L_\equiv \rangle$ be a quotient
  of $C$. Then $C_\equiv$ is reduced and $C$ and $C_{\equiv}$ compute the same
  function. Moreover, if $C$ is symmetric then $C_{\equiv}$ is symmetric, and
  for all $g \in G$, $g$ has unique labels in $C$ if, and only if, $[g]$ has
  unique labels in $C_{\equiv}$.  Indeed, for all $\sigma \in \sym_n$ if there
  exists $\pi \in \aut(C)$ extending $\sigma$ then $\pi /_\equiv$ is an
  automorphism of $C_\equiv$ extending $\sigma$.
  \label{lem:quotient-circuits-preserve}
\end{lem}
\begin{proof}
  We first prove that $C_\equiv$ and $C$ compute the same function. Let
  $\mathcal{A}$ be a $\rho$-structure of size $n$ and let $\gamma$ be a
  bijection from $U$ to $[n]$. We now show that for all $g \in G$, $C_\equiv
  [\gamma \mathcal{A}]([g]) = C[\gamma \mathcal{A}](g)$. We do this by induction
  on the depth of a gate. Suppose $g \in G$ has depth $0$. In this case $g$ is
  an input gate and the result follows trivially. Suppose $g$ is an internal
  gate and suppose for all $h$ of depth less than $g$ we have that
  $C_\equiv[\gamma \mathcal{A}]([h]) = C[\gamma \mathcal{A}](h)$. We have that
  there exists $g' \in [g]$ such that $L_\equiv ([g]) = L(g') /_\equiv$ and
  $\Sigma_\equiv([g]) = \Sigma (g) = \Sigma (g')$. We have from
  Lemma~\ref{lem:syntactic-equivalence-equal-function} and the inductive
  hypothesis that there exists $\lambda \in \aut(g)$ such that $L_\equiv ([g]) =
  L(g') = L(g) \lambda$. It follows from the fact that $\Sigma(g)$ is a
  structured function that $C_\equiv[\gamma \mathcal{A}]([g]) = \Sigma_\equiv
  ([g])(L^{\gamma \mathcal{A}}_\equiv([g])) = \Sigma (g') (L^{\gamma
    \mathcal{A}}(g')) = \Sigma (g)(L^{\gamma \mathcal{A}}(g) \lambda) = \Sigma
  (g) (L^{\gamma \mathcal{A}}(g)) = C[\gamma \mathcal{A}](g)$.
  
  We now show that $C_\equiv$ is reduced. Suppose $[g], [h] \in G_\equiv$ and
  suppose $[g] \equiv [h]$. If $[g]$ and $[h]$ are both input or output gates
  then $[g] = [h]$. Suppose $[g]$ and $[h]$ are internal gates that are not
  output gates. Then $\Sigma (g) = \Sigma_\equiv ([g]) = \Sigma_\equiv([h]) =
  \Sigma(h)$. There exists $g', h' \in G$ such that $g' \equiv g$ and $h' \equiv
  h$, and $L_\equiv ([g]) = L(g') /_\equiv$ and $L_\equiv ([h]) = L(h')
  /_\equiv$. It follows from $[g] \equiv [h]$ that $L(g') /_\equiv$ is
  isomorphism-equivalent to $L(h') /_\equiv$. It follows that $g' \equiv h'$,
  and so $[g] = [h]$.

  Let $\sigma \in \sym_n$ and suppose there exists $\pi \in \aut(C)$ extending
  $\sigma$. Let $\pi_\equiv = \pi /_\equiv$. We now show that $\pi_\equiv$ is an
  automorphism of $C_\equiv$ extending $\sigma$. It is easy to see that
  $\pi_\equiv$ is a bijection from $G_\equiv$ to $G_\equiv$ that preserves
  syntactic-equivalence, and is thus is a well-defined function. Let $[g] \in
  G_\equiv$. We have that $\Sigma_\equiv (\pi_\equiv [g]) = \Sigma_\equiv ([\pi
  g]) = \Sigma (\pi g) = \Sigma (g) = \Sigma_\equiv ([g])$. It is easy to check
  the automorphism conditions for input gates. Suppose $[g]$ is an internal
  gate. Let $g' \in [g]$ be such that $L_\equiv([g]) = L(g') /_\equiv$ and $h
  \in [g]$ be such that $L_\equiv(\pi_\equiv[g]) = L_\equiv ([\pi h]) = L(\pi h)
  /_\equiv$. We have that $\pi L(g')$ is isomorphism-equivalent to $L(\pi g')$,
  and it follows that $(\pi L(g'))/_\equiv$ is isomorphism-equivalent to $L(\pi
  g') /_\equiv$. We then have $(\pi L(g'))/_\equiv = \pi_\equiv (L(g') /_\equiv)
  = \pi_\equiv L_\equiv ([g])$ and, since $g' \equiv h$ and so $\pi g' \equiv
  \pi h$, we have that $L(\pi g')/_\equiv$ is isomorphism-equivalent to $L(\pi
  h) /_\equiv = L_\equiv(\pi_\equiv[g])$. It follows that $\pi_\equiv L_\equiv
  ([g])$ is isomorphism-equivalent to $L_\equiv(\pi_\equiv [g]) /_\equiv$.
  Suppose $[g]$ is an output gate. Then for $\vec{a} \in \dom (\Omega)$,
  $\pi_\equiv \Omega_\equiv (\vec{a}) = [\pi \Omega (\vec{a})] = [\Omega (\sigma
  \vec{a})] = \Omega_\equiv (\sigma \vec{a})$. It follows that if $C$ is
  symmetric then $C_\equiv$ is symmetric.

  Let $g \in G$. Suppose $[g]$ has unique labels. There exists $h \in [g]$ such
  that $L_\equiv([g]) = L(h) /_\equiv$. Since $L_\equiv([g])$ is injective,
  $L(h) /_\equiv$ must be injective and so $L(h)$ must be injective and no two
  child gates of $L(h)$ must be syntactically-equivalent. It follows that $h$
  has unique labels. Since $h \equiv g$ and $h$ has unique labels, it follows
  that $g$ has unique labels. Suppose $g$ has unique labels. Let $h \in [g]$ be
  such that $L_\equiv([g]) = L(h) /_\equiv$. Since $h \equiv g$ and $g$ has
  unique labels $h$ has unique labels and so $L_\equiv([g])$ has injective
  labels. Since each equivalence class in $C_\equiv$ is a singleton it follows
  that $[g]$ has unique labels.
\end{proof}

In is not hard to show that there is a polynomial-time computable function that
maps a transparent circuit to a quotient of that circuit. To see this, recall
that from Lemma~\ref{lem:transparent-syntactic-equiv} we can compute the
syntactic-equivalence classes of a transparent circuit in polynomial-time. We
can thus define a quotient circuit by picking representatives from each
syntactic-equivalence class and then applying the definition of a quotient
circuit in the obvious manner.

We now show that transparent circuits can be transformed in polynomial time into
equivalent circuits with unique labels, and hence unique extensions, and that
this transformation preserves important properties.

\begin{lem}
  Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a transparent
  $(\mathbb{B}, \rho)$-circuit. There is an algorithm that takes in such a
  circuit and outputs a $(\mathbb{B} \cup \mathbb{B}_{\std}, \rho)$-circuit $C'$
  such that $C$ and $C'$ compute the same function, $C'$ has unique labels, and
  if $C$ is symmetric then $C'$ is symmetric. Moreover, this algorithm runs in
  time polynomial in the size of the input circuit.
  \label{lem:transparent-unique}
\end{lem}
\begin{proof}
  Let $C_0 := \langle G_0, \Omega_0, \Sigma_0, \Lambda_0, L_0 \rangle$ be the
  quotient of $C$. If $C_0$ does not contain the constant gates $g_0$ and $g_1$
  such that $\Sigma(g_0) = 0$ and $\Sigma (g_1) = 1$ we construct a new circuit
  from $C_0$ by adding gates. We abuse notation and also call this new circuit
  $C_0$. The addition of these constant gates to the circuit does not alter the
  function computed by the circuit, nor does it effect the symmetry of the
  circuit or weather it has unique labels.

  The proof proceeds by first defining a circuit $C_1$ from $C_0$ and then
  defining $C'$ from $C_1$. We then show that each of these constructions
  preserves the relevant circuit properties and that $C'$ has unique labels.

  We now define the circuit $C_1$. Let $C_1 := \langle G_1, \Omega_1, \Sigma_1 ,
  \Lambda_1, L_1 \rangle$ be defined as follows. Let $G_1 = G_0 \uplus \{
  g_\lor\}$. Let $\Omega_1 = \Omega_0$ and $\Lambda_1 = \Lambda_0$. Let $g \in
  G_1$. If $g = g_\lor$ then $\Sigma_1 (g) = \OR[2]$ with $L_1(g)(1) = g_0$ and
  $L_1(g)(2) = g_1$. If $g \in G_0$, $\Sigma(g) = \OR[2]$ and $H_g = \{g_0,
  g_1\}$, then $\Sigma_1 (g) = \OR[3]$, $L_1(g)(1) = L_0(g)(1)$, $L_1(g)(2) =
  L_0(g)(2)$, and $L_1(g)(3) = g_\lor$. If $g \in G_0$ and $g = \AND[k]$ for
  some $k \in \nats$ then $\Sigma_1(g) = \AND[k+1]$ and $L_1(g)(i) = L_0(g)(i)$
  for all $i \in [k]$ and $L_1(g)(k+1) = g_\lor$. Otherwise let $\Sigma_1(g) =
  \Sigma_0(g)$ and $L_1(g) = L_0(g)$.

  Stated more informally, we define $C_1$ from $C_0$ by adding in an $\OR$-gate
  $g_\lor$ that always evaluates to one, and then adding a wire from that gate
  to all $\AND$-gates in the circuit (and also a wire from $g_\lor$ to any
  similar gate that may already exist in the circuit in order to ensure that
  $g_\lor$ is part of a singleton syntactic-equivalence class in $C_1$). The
  important point to note is that each $\AND$-gate in $C_1$ has fan-in at least
  two. We construct $C'$ from $C_1$ by adding in a number of $\AND$-gates
  with fan-in one. Therefore, since all of the $\AND$-gates in $C_1$ have fan-in
  two, it follows that none of these new gates are syntactically-equivalent
  to any gate in $C_1$. We now show that $C_1$ and $C_0$ compute the same
  function and if $C_0$ is symmetric then $C_1$ is symmetric.
  
  % We have defined $C_1$ from $C_0$ by in a gate $g_\lor$ that always evaluates
  % to $1$ and then adding a wire from that gate to each $\AND$-gate in the
  % circuit. This process ensures that each $\AND$-gates in $C_1$ has a fan-in
  % of at least two. The construction of $C'$ from $C_1$ involves adding in a
  % number of single-input $\AND$-gates, and so the construction of $C_1$ will
  % allow us to distinguish these new gates from those in $C_1$.

  % We have constructed $C_1$ from $C_0$ by adding in a gate $g_\lor$ and then
  % adding a wire from $g_\lor$ to each $\AND$-gate in the circuit and each gate
  % two-input $\OR$-gate with the same children as $g_\lor$. Since $g_\lor$
  % always evaluates to $1$, adding as an input to each $\AND$-gate (or the
  % $\OR$-gate) has no effect on the evaluation of the circuit.

  
  It is easy to see that if $C$ has order $n$ then $C_0$ has order $n$ and so
  $C_1$ has order $n$. Let $\mathcal{A}$ be a $\rho$-structure of size $n$ and
  let $\gamma$ be a bijection from the universe of $\mathcal{A}$ to $[n]$. We
  have that $C_1[\gamma \mathcal{A}](g_\lor) = 1$. We constructed $C_1$ from
  $C_0$ by adding a single wire from $g_\lor$ to each $\AND$-gate and each
  two-input $\OR$-gate with only the two constant gates as children. Notice that
  if $g$ is a two-input $\OR$ gate in $C_0$ with the two constant gates as
  children, then since $g$ has $g_1$ as a child and $g$ is an $\OR$-gate
  $C_0[\gamma \mathcal{A}](g) = C_1[\gamma \mathcal{A}](g) = 1$. It can be shown
  by induction that if $g \in G_1 \setminus \{g_\lor\}$ then $C_0 [\gamma
  \mathcal{A}](g) = C_1[\gamma \mathcal{A}](g)$. Since $\Omega_1 = \Omega_0$, it
  follows that $C_0$ and $C_1$ compute the same function. We thus have from
  Lemma~\ref{lem:quotient-circuits-preserve} that $C$ and $C_1$ compute the same
  function.

  Suppose $C$ is symmetric. From Lemma~\ref{lem:quotient-circuits-preserve} it
  follows that $C_0$ is symmetric. Let $\sigma \in \sym_n$ and let $\pi_0 \in
  \aut(C_0)$ be an extension of $\sigma$. Let $\pi_1 : G_1 \rightarrow G_1$ such
  that $\pi_1 (g) = \pi_0(g)$ for all $g \in G_0$ and $\pi_1 (g_\lor) = g_\lor$.
  It is easy to see that $\pi_1$ is an automorphism of $C_1$ extending $\sigma$.
  It follows that $C_1$ is symmetric.

  We now show that $C_1$ is reduced. We have from
  Lemma~\ref{lem:quotient-circuits-preserve} that $C_0$ is reduced. Since
  $g_\lor$ is the only two input $\OR$-gate with exactly the two constant gates
  as children, $g_\lor$ is contained in a singleton syntactic-equivalence class.
  It can be shown by induction that if $g, g' \in G_0$ are syntactically
  equivalent in $C_1$ then they must be syntactically-equivalent in $C_0$. It
  follows from these two observations that if $g, g' \in G_1$ are
  syntactically-equivalent in $C_1$ then $g = g'$. We thus have that each
  syntactic-equivilence class in $C_1$ is a singleton, and so $C_1$ is reduced.

  Let $C' := \{G', \Omega', \Sigma' \Lambda' L'\}$ be defined as follows. For
  each $g, h \in G_1$ let $c^h_g := \vert L^{-1}(\{h\}) \vert$. For each $h \in
  G_1$ let $c^h = \max_{g \in G_1} c^h_g$. For each $h \in G_1$ if $c^h > 1$ we
  define for each $i \in [c_h-1]$ a distinct gate $g^h_i$ and let $G_h :=
  \{g^{h}_{1}, \ldots, g^h_{c_h-1}\}$, and otherwise let $G_h := \emptyset$. Let
  $G_{\land} := \biguplus_{h \in G_1} G_h$ and $G' = G_{\land} \uplus G_1$. Let
  $\Omega' = \Omega_1$ and $\Lambda' = \Lambda_1$. For $g \in G'$ if $g \in G_1$
  let $\Sigma'(g) = \Sigma_1(g)$ and otherwise let $\Sigma'(g) = \AND[1]$. For
  each $g \in G_1$ and $h \in H_g$ let $x^{h,g}_0, \ldots, x^{h,g}_{c^g_h - 1}$
  be a ($0$-based) ordering of $L_1(g)^{-1}(\{h\})$. For each $g \in G'$ and $x
  \in \ind(g)$ we define $L'(g)(x)$ as follows. If $g \in G_1$ then there exists
  unique $h \in H_g$ and $i \in \{0, \ldots, c^h_g - 1\}$ such that $x =
  x^{h,g}_i$, and we let $L'(g)(x) = h$ if $i = 0$ and $L'(g) (x) = g^h_i$
  otherwise. If $g \in G_{\land}$ then $g = g^h_i$ for some $h \in G_1$ and $i
  \in [c^h-1]$, and we let $L'(g)(x) = h$ if $i = 1$ and $L'(g)(x) = g^h_{i-1}$
  otherwise.

  The construction ensures that $C'$ has injective labels. Let $g \in G_1$. In
  order to avoid confusion we let $H_g$ be the set of children of $g$ in $C_1$
  and $H_g'$ be the set of children of $g$ in $C'$. If $g' \in G_1$ we let $g
  \equiv g'$ denote syntactic-equivalence in $C_1$ and $g \equiv' g'$ denote
  syntactic-equivalence in $C'$.

  We now prove that $C'$ has all of the requisite properties.
  
  \begin{claim}
    $C'$ is reduced
  \end{claim}
  \begin{proof}
    We prove this result by induction on depth. Let $g \in G'$. If $g$ has depth
    $0$ then $g$ is an input gate and so $[g] = \{g\}$. Let $g \in G'$ be an
    internal gate in $C'$ and suppose for each gate $h$ of depth less than $g$
    we have that $[h] = \{ h \}$. Let $g' \in G'$ and suppose $g \equiv' g'$. We
    now show that $g = g'$, and so $[g] = \{g\}$, breaking down the argument by
    case. We first make a few useful observations. Note that, since $g \equiv'
    g'$, it follows that $\Sigma (g) = \Sigma(g')$ and both $g$ and $g'$ have
    the same depth. Moreover, from the inductive hypothesis and the fact that $g
    \equiv' g'$, we have that there exists $\lambda \in \aut(g)$ such that for
    all $x \in \ind(g)$, $L'(g) (\lambda x) = L'(g')(x)$. It follows that
    $H_{g}' = H_{g'}'$. We also have from the inductive hypothesis that each
    child of $g$ and $g'$ must be contained in a singleton equivalence class.
    Since $C'$ has injective labels it follows that $g$ and $g'$ have unique
    labels.

    % Suppose $g = g_\lor$. Then $H_g = H_g' = \{g_0, g_1\} = H_{g'}'$ and
    % $\Sigma' (g) = \Sigma'(g') = \lor[2]$. But from the construction the only
    % two-input $\OR$-gate in $C_1$, and so $C'$, with children $\{g_0 , g_1\}$
    % is
    % $g$. It follows that $g = g'$.
    
    Suppose $g \in G_{\land}$. Then there exists $h \in G_1$ and $i \in [c^h -
    1]$ such that $g = g^h_i$. Suppose $g' \in G_1$. Then $\Sigma'(g) =
    \AND[1]$. But, from the construction of $C_1$, there are no single-input
    $\AND$-gates in $G_1$. It follows $\Sigma'(g') \neq \Sigma'(g)$ and so $g'
    \not\equiv' g$, a contradiction, and so we must have $g' \in G_{\land}$. If
    $i = 1$ then $\{ h \} = H_g' = H_{g'}'$.  Since the only gate in $G_\land$
    that has $h$ as a child is $g^h_1$, it follows that $g = g^h_1 = g'$.
    If $i > 1$ then $\{g^{h}_{i-1}\} = H_g' = H_{g'}'$. Since $g^h_i$ is the
    only gate in $G_\land$ that has $g^h_{i-1}$ as a child, we have $g =
    g^h_i = g'$. It follows that if $g \in G_\land$ then $g = g'$.

    Suppose $g \in G_1$. We have already shown that if $g' \in G_\land$ then $g
    \not\equiv' g'$, a contradiction, and so we must have $g' \in G_1$. Since $g
    \equiv' g'$ there exists $\lambda \in \aut(g)$ such that for all $x \in
    \ind(g)$, $L'(g)(\lambda x) = L'(g')(x)$. From the construction, we have
    that for all $x \in \ind(g)$ and $h \in G_1$, $L'(g)(x) \in \{h, g^h_1 ,
    \ldots, g^h_{c^h_g -1}\}$ if, and only if, $L_1(g)(x) = h$. Suppose $g$ is
    not a symmetric gate. Since $C$ is transparent, $C_0$ is transparent and so
    $C_1$ is transparent. We thus have that $g$ and $g'$ have unique labels in
    $C_1$ and so $c^h_g = 1 = c^h_{g'}$ and so for all $x \in \ind(g)$,
    $L_1(g)(x) = L'(g)(x)$ and $L_1(g')(x) = L'(g)(x)$. It follows that for all
    $x \in \ind(g)$, $L_1(g')(x) = L'(g')(x) = L'(g)(\lambda x) = L_1(g)(\lambda
    x)$. We thus have that $g \equiv g'$ and so $g = g'$. Suppose instead that
    $g$ is a symmetric gate. Let $x \in \ind(g)$ and $h := L_1(g)(\lambda x)$.
    Then $L' (g')(x) = L'(g)(\lambda x) \in \{h, g^h_1, \ldots , g^h_{c^h_g -
      1}\}$. It follows that $L_1(g')(x) = h$. Putting this together we have
    that for all $x \in \ind(x)$, $L_1(g) (\lambda x) = L_1(g')(x)$, and so $g
    \equiv g'$ and thus $g = g'$.
    
    % Suppose $g \in G_0$. If $g$ is a non-symmetric gate then $g$ has unique
    % labels in $C_0$ and so has unique labels in $C_1$. It follows that for all
    % $h \in H_g$, $c^h_g = 1$, $g$ has injective labels in $C'$ and so, using
    % the
    % inductive hypothesis, $g$ has unique labels. Since $g \equiv' g'$ we also
    % have that $g'$ has unique labels.

    % It is easy to show that for all $h, g \in G_1$, if $W_t(h,g)$ in $C_1$
    % then
    % $W_t(h,g)$ in $C'$. We prove this result by induction on depth. Suppose
    % $g$
    % and $g'$ have depth $0$ in $C'$ then $g$ and $g'$ are input gates, and so
    % $g
    % \equiv' g'$ if, and only if, $g = g'$ if, and only if, $g \equiv g'$.
    % Suppose $g, g' \in G_1$ are internal symmetric gates and for all $h , h'
    % \in
    % G_1$ of depth less than $g$ or $g'$ in $C'$ $h \equiv h'$ if, and only if,
    % $h \equiv' h'$. Suppose $g \equiv g'$. Then there exists $\lambda \in
    % \aut(g)$ such that for all $x \in \ind(g)$, $L_1(g)(x) \equiv
    % L_1(g')(\lambda x)$. If $H_g'\cup \H_{g'}' \subseteq G_1$ then the result
    % follows obviously from the inductive hypothesis. For each $h \in H_g$ and
    % $x
    % \in L(g)^{-1}(h)$ if $c^h_g = 1$ then let $\lambda' x = x$ and if $c^h_g >
    % 1$ and if $x = x^{h,g}_i$ for some $i \in [c^h_g - 1]$ then $\lambda' x =
    % x^{h', g'}_i$ where $h' = L_1(g')(\lambda x)$. It can be shown that
    % $\lambda'$ is a bijection on $\ind(g)$. Since $g$ and $g'$ are symmetric
    % gates it follows that $\lambda' \in \aut(g)$...
  \end{proof}
  
  Since $C'$ has injective labels and is reduced it follows $C'$ has unique
  labels. We have already shown that if $C$ is symmetric then $C_1$ is
  symmetric. We now show that if $C_1$ is symmetric then $C'$ is symmetric.
  Suppose $C_1$ is symmetric. Let $\sigma \in \sym_n$ and let $\pi_1 \in
  \aut(C_1)$ be an extension of $\sigma$. We define the function $\pi' : G'
  \rightarrow G'$ as follows. Let $g \in G'$. If $g \in G_1$ let $\pi'(g) :=
  \pi_1(g)$. If $g \not\in G_1$ then $g \in G_\land$, and so there exists $h \in
  G_1$ and $i \in [c^h - 1]$ such that $g = g^h_i$. Let $\pi'(g) := g^{\pi_1
    h}_i$. It is easy to show that $\pi'$ is an automorphism of $C'$ extending
  $\sigma$.

  \begin{claim}
    Let $g \in G_1$, $\mathcal{A}$ be a $\rho$-structure of size $n$, and
    $\gamma$ be a bijection from the universe of $\mathcal{A}$ to $[n]$. Then
    $C'[\gamma \mathcal{A}](g) = C_1[\gamma \mathcal{A}](g)$.
  \end{claim}
  \begin{proof}
    It is easy to see that for all $h \in G_1$ and $i \in [c^h-1]$ we have that
    $C'[\gamma \mathcal{A}](g^h_i) = C'[\gamma \mathcal{A}](h)$. Suppose $g \in
    G_1$. We now prove the result by induction on the depth of a gate. Suppose
    $g$ has depth $0$. In this case $g$ is an input gate, and the result follows
    trivially. Suppose $g$ is an internal gate, and for all $h$ of depth less
    than $g$ we have that if $h \in G_1$ then $C'[\gamma \mathcal{A}](h) =
    C_1[\gamma \mathcal{A}](h)$. Let $x \in \ind(g)$. Recall that $C'$ is
    constructed such that if $g \in G_1$ then for all $x \in \ind(g)$ and $h \in
    H_g$, $L_1(g)(x) = h$ if, and only if, $L'(g)(x) \in \{h, g^h_1, \ldots ,
    g^h_{c^h_g - 1}\}$. But, from the construction, we have that all of the
    gates in $\{h, g^h_1, \ldots, g^h_{c^h_g -1}\}$ evaluate to the same value
    for a given input to the circuit. Thus, from the inductive hypothesis, we
    have that if $L'(g)(x) \in G_1$ then $ {L'}^{\gamma \mathcal{A}}(g)(x) =
    C'[\gamma \mathcal{A}](L(g)(x)) = C_1[\gamma \mathcal{A}](L_1(g)(x)) =
    L^{\gamma \mathcal{A}}_1(g)(x) $. If $L'(g)(x) \not\in G_1$ then $L'(g)(x)
    \in G_{\land}$ and so $L'(g)(x) = g^h_i$, where $h = L_1(g)(x)$ and some $i
    \in [c^h_g -1]$. But then ${L'}^{\gamma \mathcal{A}}(g)(x) = C'[\gamma
    \mathcal{A}](g^h_i) = C'[\gamma \mathcal{A}](h) = C_1[\gamma \mathcal{A}](h)
    = L^{\gamma \mathcal{A}}_1(g)(x)$. The penultimate equality follow from 
    the inductive hypothesis. The final equality follows from the fact that $h =
    L_1 (g)(x)$. We thus have $C'[\gamma \mathcal{A}](g) = \Sigma'({L'}^{\gamma
      \mathcal{A}}(g)) = \Sigma_1 (L^{\gamma \mathcal{A}}_1(g)) = C_1[\gamma
    \mathcal{A}](g)$.
  \end{proof}

  Since $\Omega' = \Omega_1$, we have that $C'$ and $C_1$ compute the same
  function. It follows that, since $C_1$ and $C$ compute the same function, $C$
  and $C'$ compute the same function. Since $C$ is transparent, we may construct
  the quotient circuit $C_0$ in time polynomial in $\vert C \vert$. Since $C_1$
  is constructed by adding in a single gate and then adding at most $\vert C_0
  \vert$ wires, we may construct $C_1$ from $C_0$ in time polynomial in $\vert C
  \vert$. It is easy to see that $C'$ can be constructed in time polynomial
  in $\vert C_1 \vert$ and hence polynomial in $\vert C \vert$. The result
  follows.
  %
  % It is easy to see that $C'$ has injective labels. Let $g$ be an internal
  % gate
  % in $C'$ and suppose each gate of depth less than $g$ has unique labels. Let
  % $h, h' \in H_g$ such that $h \equiv h'$. If $h, h' \in G_1$ it follows $h =
  % h'$. Suppose $h, h' \in G_{\land}$. Then there exists $d, d' \in G_1$ and
  % $i,
  % j$ such that $g^d_i \equiv g^{d'}_j$. If $j = i$ then $d \equiv d'$ and so
  % $d
  % = d'$ and $h = h'$. Suppose, without a loss of generality, that $i > j$. It
  % follows that $g^d_{i-j} \equiv d'$. But then $d'$ is a single-input
  % $\AND$-gate, which is impossible, as from the construction $d'$ must have at
  % least two inputs. Suppose

  % Thus $g \equiv g'$ if, and only if, $g = g'$
  % Let $C'':= \langle G'', \Omega'', \Sigma'', \Lambda'', L'' \rangle$ be a
  % quotient of $C$. We have from Lemma~\ref{lem:quotient-circuits-preserve}
  % that
  % $C''$ is transparent, i.e. all the non-symmetric gates have unique labels,
  % and
  % that no two input gates to any one gate are syntactically-equivalent. We now
  % construct a circuit $C'$ from $C''$ that leaves the non-symmetric gates
  % unchanged but such that each symmetric gate in $C'$ has unique labels. We
  % construct $C'$ by taking each symmetric gate $g$ in $C''$ and each gate $h
  % \in
  % H_g$ and adding in a sequence of single-input $\AND$-gates, one for each
  % wire
  % from $h$ to $g$, such that the first $\AND$-gate in this sequence has $h$ as
  % its input and each successive $\AND$-gate has the previous one as an input.
  % We
  % then remove all but one of the wires from $h$ to $g$ and add a wire from
  % each
  % $\AND$-gate in this sequence to $g$. We now construct $C'$ formally.

  
  % Let $C_i = \langle G_i, \Omega_i, \Sigma_i, \Lambda_i, L_i \rangle$ be a
  % transparent circuit of order $n$. We construct $C_{i+1} := \langle G_{i+1},
  % \Omega_{i+1}, \Sigma_{i+1}, \Lambda_{i+1}, L_{i+1} \rangle$ as follows. For
  % each $g \in G_i$ and $h \in H_g$ let $s^g_h = \{x \in \ind(g) : L(g)(x)
  % \equiv
  % h\}$ and let $c_h$ be the maximum $\vert c^g_h \vert$ for all $g \in G_i$.
  % Let
  % $G_{\land} := \{g^h_\land : h \in G_i, \, c_h > 1\}$. Let $G_{i}' := G_i
  % \cup
  % G_{\land}$. Let $\Omega_{i}' := \Omega_i$. For $g \in G_i$ let $\Sigma_{i}'
  % (g) := \Sigma_i (g)$ if $g \in G_i$ and $\Sigma_{i}'(g) := \land[1]$
  % otherwise. Let $\Lambda_{i}' := \Lambda_i$. We now define $L_{i}'(g)$ for
  % each
  % $g \in G_{i}'$. If $g \in G_{i}$ and $g$ is not a symmetric gate then
  % $L_{i}'(g) = L_i(g)$. If $g \in G_{\land}$ and $g = g^h_\land$ for some $h
  % \in
  % G_i$ let $L(g)(1) = h$. Suppose $g \in G_{i}$ and $g$ is a symmetric gate.
  % For
  % each $h \in H_g$ select one $x_h \in \ind(g)$. For $x \in \ind(g)$ let
  % $L_{i+1}(g) (x) = h$ if $x = x_h$ and $L_{i}'(g)(x) = g^h_\land$ otherwise.
  % Let $F(C_i) := C_{i+1} := \langle G_{i+1}, \Omega_{i+1}, \Sigma_{i+1},
  % \Lambda_{i+1}, L_{i+1} \rangle$ be a quotient of $C_i'$.
  
  % Let $C_0' := C$ and $C_1$ be a quotient of $C_0$. For each natural number
  % $i>
  % 0$ we define a circuit $C_{i+1}$ from $C_{i} := \langle G_{i}, \Omega_{i},
  % \Sigma_{i}, \Lambda_{i}, L_{i} \rangle$ as follows. We first define $C_i' =
  % \langle G_i', \Omega_i', \Sigma_i', \Lambda_i', L_i' \rangle$ as follows.
  % For
  % each $g, h \in G_i$ let $c^g_h = \vert L_i(g)^{-1}(h) \vert$ and let $c_h$
  % be
  % the maximum $c^g_h$ for all $g \in G_i$. Let $G_{\land} := \{g^h_\land : h
  % \in
  % G_i, \, c_h > 1\}$. Let $G_{i}' := G_i \cup G_{\land}$. Let $\Omega_{i}' :=
  % \Omega_i$. For $g \in G_i$ let $\Sigma_{i}' (g) := \Sigma_i (g)$ if $g \in
  % G_i$ and $\Sigma_{i}'(g) := \land[1]$ otherwise. Let $\Lambda_{i}' :=
  % \Lambda_i$. We now define $L_{i}'(g)$ for each $g \in G_{i}'$. If $g \in
  % G_{i}$ and $g$ is not a symmetric gate then $L_{i}'(g) = L_i(g)$. If $g \in
  % G_{\land}$ and $g = g^h_\land$ for some $h \in G_i$ let $L(g)(1) = h$.
  % Suppose
  % $g \in G_{i}$ and $g$ is a symmetric gate. For each $h \in H_g$ select one
  % $x_h \in \ind(g)$. For $x \in \ind(g)$ let $L_{i}'(g) (x) = h$ if $x = x_h$
  % and $L_{i}'(g)(x) = g^h_\land$ otherwise. Let $C_{i+1} = F(C_i) := C_{i+1}
  % :=
  % \langle G_{i+1}, \Omega_{i+1}, \Sigma_{i+1}, \Lambda_{i+1}, L_{i+1} \rangle$
  % be a quotient of $C_i'$.

  % Let $i \in \nats$. For $g \in G_i$, in order to avoid ambiguity we let $H_g$
  % denote the set of children of $g$ in $C_i$ and $H_g'$ denote the set of
  % children of $g$ in $C_i'$. We let $\equiv$ be the syntactic-equivalence
  % relation in $C_i$ and $\equiv'$ be the syntactic-equivalence relation in
  % $C_i'$.

  % If $C_i$ has order $n$ then $C_i'$ is has order $n$ and so $C_{i+1}$ has
  % order
  % $n$. We first show that $C_{i+1}$ and $C_i$ compute the same function. Let
  % $\mathcal{A}$ be a $\rho$-structure of size $n$ and let $\gamma$ be a
  % bijection
  % from the universe of $\mathcal{A}$ to $[n]$. The construction of $C_i'$ from
  % $C_i$ by identifying those gates $h, g \in G_i$ such that $h \in H_g$ and
  % $\vert L_i(g)^{-1}(h) \vert > 1$ and then replacing all but one of the wires
  % from $h$ to $g$ with a wire from $g^h_\land$ to $g$. Since $g^h_\land$ is a
  % single-input $\AND$-gate with input $h$, we have that $C_i[\gamma
  % \mathcal{A}](h) = C_{i}'[\gamma \mathcal{A}](h) = C_i'[\gamma
  % \mathcal{A}](g^h_\land)$. It follows that $C_i [\gamma \mathcal{A}](g) =
  % C_i'
  % [\gamma \mathcal{A}](g)$. We thus have that $C_i$ and $C_i'$ compute the
  % same
  % function and so, using Lemma~\ref{lem:quotient-circuits-preserve}, $C_{i+1}$
  % computes the same function as $C_i$.

  % Suppose $C_i$ is symmetric. Let $\sigma \in \sym_n$ and $\pi \in \aut(C)$ be
  % an extension of $\sigma$. It can be shown that $c_h = c_{\pi h}$. As such,
  % we
  % can extend $\pi$ to $G_i'$, defining $\pi' : G_i' \rightarrow G_i'$ by $\pi'
  % g
  % = \pi g$ if $g \in G_i$ and letting $\pi' g^h_\land = g^{\pi h}_\land$ if
  % $g^h_\land \in G_{\land}$. It can be shown that $\pi'$ is an automorphism of
  % $G_i'$ extending $\sigma$, and so $C_i'$ is symmetric. It follows from
  % Lemma~\ref{lem:quotient-circuits-preserve} that $C_{i+1}$ is symmetric.

  % It can be shown that for all $g, g' \in G_i$, $g \equiv g'$ if, and only if,
  % $g \equiv' g'$.

  % % It follows that for $g^h_\land, g^{h'}_\land \in G_\land$ if
  % % $g^h_\land \equiv' g^{h'}_\land$ then $h \equiv' h'$ and so $h \equiv h'$.
  
  % Suppose $C_i$ has unique labels. It follows that $c_h = 1$ for all $h \in
  % G_i$
  % and so $C_i = C_{i}'$. We thus have, using
  % Lemma~\ref{lem:quotient-circuits-preserve}, that $C_{i+1}$ has unique
  % labels.
  % Suppose $C_i$ does not have unique labels. For $g \in G_{i}$ and $h \in H_g$
  % let $s^h_g := \vert \{x \in \ind(g): L_i(g)(x) \equiv h\} \vert$. In other
  % words $s^h_g$ is the number of wires to $g$ from either $h$ or a gate
  % syntactically-equivalent to $h$. For $g \in G_i$ let $d_g$ be the minimum
  % depth of a gate $h \in H_g$ in $C_i$ such that $s^h_g > 1$ and let $d_g
  % :=\infty$ if no such gate exists. In other words $d_g$ is the depth of the
  % minimum-depth gate witnessing that $g$ does not have unique labels. For $g
  % \in
  % G_i'$ we define $d_g'$ similarly for $C_i'$. For $g \in G_i$ let $S^i_g :=
  % \{h
  % \in H_g : \depth(C_i, h) < d_g \}$ be a set of gates in $C_i$. For $g \in
  % G_i'$ we define $S^i_g'$ similarly for $C_i'$.

  % Since $C_i$ does not have unique labels, there exists $g \in G_i$ such that
  % $d^i_g \neq \infty$. Let $H^d_g := \{h \in H_g : \depth (C_i, h) = d_g\}$ be
  % a
  % set of gates in $C_i$. We now prove that $H^d_g \cup S^i_g \subseteq
  % S^i_g'$.
  % It can be shown that for all $h, h' \in H_g$, if $\depth(C_i, h) <
  % \depth(C_i,
  % h')$ then $\depth(C_i', h) < \depth(C_i', h')$. Since the construction
  % preserves the `child of' relation, we have for all $h \in H_g$ that
  % $\depth(C_i, h) \leq \depth(C_i', h)$. Let $h \in S^i_g$. Since $s^h_g = c_h
  % =
  % 1$ we have that $\vert L_{i}'(g)^{-1}(g) \vert = 1$. From
  % Lemma~\ref{lem:quotient-circuits-preserve} we have that $h \not\equiv h'$
  % for
  % all $h' \in H_g$. So suppose $h \equiv' g^{h'}_{\land}$ for some $g^h'_\land
  % \in G_\land$. It follows that $h'$ must be syntactically-equivalent to the
  % single child of $h$ in $C_i$ and so $\depth(C_i',h') < \depth(C_i', h)$

  % It follows that $h' \in H_{h}'$ (since $C_i$ is a quotient) Suppose there
  % exists a gate $h' \in G_i'$ such that $h \equiv h'$ in $C_i'$. Since $C_i$
  % has
  % trivial symmetric-equivalence classes, it follows that $h' = g^{h''}_\land$
  % for

  % Let $d$ be the maximum depth in $C_i'$ of a gate in $H^d_g \cup S^i_g$.
  % Suppose $h \in G_i'$ such that $\depth (C_i', h) \leq d$ and $s^h_g' > 1$.
  
  % We have from the construction that $\vert L_i'(g)^{-1}(h) \vert = 1$. It
  % follows that there exists $h' \in H_g'$, $h' \neq h$ such that $h' \equiv' h
  % $. Moreover, since $G_i$ has singleton-equivalence classes we have that $h'
  % \not\in G_i$. So there exists $h'' \in H_g$ such that $c^g_{h''} > 1$ and
  % $h'
  % = g^{h''}_i \equiv' h'$. Since $C_i$ is a quotient we have that $h''$ is the
  % only child of $h'$ in $C_i$, and so $\depth(C_i, h'') < \depth(C_i, h')$.
  % Moreover, since $\depth(C_i, h') \leq \depth(C_i', h') \leq d \leq d_g$ We
  % thus have that $d_g \leq \depth(C_i, h'') < \depth(C_i, h') \leq \depth(C_i,
  % h) \leq d_g$

  % If $d < d_g'$ we are done. Suppose $d \geq d_g'$. Then there exists $h \in
  % H^d_g \cup S^i_g$ such that $d_g' \leq d(C_i', h) \leq d$

  % and suppose there exists $h \in H_g'$ such that $\depth(C_i, h) < d$
  

  % Since $C_i$ does not have unique labels there exists $g \in G_i$ and $h \in
  % H_g$ such that $d(C_i, g) \neq \infty$. If $h \in s(C_i, g)$ and $c_h = 1$
  % then $s(C_i', g)$.

  % Let $H^{d}_g \subseteq H_g$ be the set of children of $g$ of depth
  % $d(C_i,g)$.

  % We have for each $h \in G_i$ such that $c_h > 1$ that $g^h_i$ has a depth in
  % $C_i'$ strictly greater than $h$ ensures that $d_g \leq d_g'$

  % For $g \in G_{i}$ and $h \in H_g$ let $s^h_g := \vert \{x \in \ind(g):
  % L_i(g)(x) \equiv h\} \vert$. Let $d_g$ be the minimum depth of a gate $h \in
  % H_g$ in $C_i$ such that $s^h_g > 1$ and let $d_g :=\infty$ if no such gate
  % exists. It follows that $d_g = \infty$ for all $g \in G_i$ if, and only if,
  % $C_i$ has unique labels.

  % Suppose $C_i$ does not have unique labels. Let $g \in G_i$ such that $d_g
  % \neq
  % \infy$ and let $H^{d}_g \subseteq H_g$ be the set of children of $g$ of
  % depth
  % $d_g$. We notice that for all $h, h' \in H^d_g$, $h'$ and $g^h_\land$ have
  % different depths in $C_i'$ and so $h' \no\equiv g^h_\land$ in $C_i'$.
  % Moreover,

  

  % For $g \in G_i$ let $s_g := s^h_g$ where $h$ is the minmimal-depth where $h
  % \in H_g$ is the

  % be the minimum depth the is minimum depth child such that $\vert H_g
  % /_\equiv
  % \vert > 1$, and $s_g = 0$ if no such gate exists. Let $S(C_i)$ be the
  % maximum
  % of $s_0$.

  % Notice that $s_i = 0$ if, and only if, $C_i$ has unique labels. Suppose
  % $S(C_i) \neq 0$. Let $H^s_g = \{ h \in H_g : c^h_g > 1\}i$. Let $h$ be the
  % gate of minimal depth in $H^s_g$. Then $h$ is not syntactically-equivalent
  % to
  % $g^h_\land$
  
  % Suppose $C_i$ does not have unique labels. Then

  % Suppose $C_i$ is symmetric.
  
  % % Let $H \subseteq G''$ be the set of all symmetric gates. For each $h \in
  % % G''$
  % % let $c_h$ be the maximum of $\vert L(g)^{-1}(h) \vert$ for $g \in H$ such
  % % that
  % % $h \in H_g$. For each $h \in G''$ let $G_{h, \land} := \{g^h_1, \ldots,
  % % g^h_{c_h - 1}\}$. Let $G_\land := \bigcup_{h \in G''} G_{h, \land}$. Let
  % % $G'
  % % := G'' \cup G_{\land}$. Let $\Omega' := \Omega''$. For $g \in G''$ let
  % % $\Sigma' (g) := \Sigma'' (g)$ if $g \in G$ and $\Sigma'(g) := \land[1]$
  % % otherwise. Let $\Lambda' := \Lambda''$. We now define $L'(g)$ for each $g
  % % \in
  % % G'$. If $g \in G' \setminus (H \cup G_\land)$ let $L'(g) = L''(g)$. If $g
  % % \in
  % % G_\land$ and $g = g^h_i$ for some $h \in G''$ and $i \in [c_h]$, if $i =
  % % 1$
  % % let $L(g)(1) = h$ otherwise let $L(g)(1) = g^h_{i-1}$. Suppose $g \in H$.
  % % For
  % % each $h \in H_g$ let $\{x^h, x^h_1, \ldots, x^h_k\} := L(g)^{-1}(h)$, and
  % % notice that $\vert L(g)^{-1}(h) \vert \leq c_h$. For each $x \in \ind(g)$
  % % let
  % % $h = L(g)(x)$ and let $L'(g) (x) = h$ if $x = x^h$ and $L'(g)(x) = g^h_i$
  % % if
  % % $x = x^h_i$ for some $i \in [\vert L(g)^{-1} \vert - 1]$.

  % e have from Lemma~\ref{lem:quotient-circuits-preserve} that $C''$ has unique
  % labels if $C$ has unique labels, $C''$ is symmetric if $C$ is symmetric and
  % $C''$ and $C$ compute the same function. Since $C''$ is constructed from
  % $C'$
  % by replacing some of the wires from $h$ to the symmetric gate $g$ with
  % $\AND$-gates that evaluate to the same value as $h$, it is not hard to see
  % that $C'$ computes the same function as $C''$, and hence $C'$. Moreover, the
  % construction also ensures that each symmetric gate (and so each internal
  % gate)
  % in $C'$ has injective labels. It is easy to see that for a fixed $h \in G''$
  % no two gates in $G_{h,\land} \uplus \{h\}$ are syntactically-equivalent.
  % Suppose $h, h' \in G''$ and $g^h_i \equiv g^{h'}_j$ for some $i \in [c_h -
  % 1]
  % $ and $j \in [c_{h'} -1]$. If $j = i$ then it can be shown that $h \equiv
  % h'$
  % and so $h = h'$. If $i > j$ then it can be shown that $g^h_{i-j} \equiv h'$,
  % but then $W_T(h', h)$ in $C''$
  

  

  % Let $C/_{\equiv} := \langle G /_{\equiv}, \Omega/_{\equiv},
  % \Sigma/_{\equiv},
  % \Lambda/_{\equiv}, L/_{\equiv}$ be the quotient of $C$ by
  % syntactic-equivalence. Since each gate that is an input or output gates is a
  % member of a singleton equivalence class, we have that $C/_{\equiv}$ is
  % indeed
  % a circuit.

  % We have that no two gates in $G /_{\equiv}$ are syntactically-equivalent.
  % Suppose $C$ is symmetric. We have from For $\sigma \in \sym_n$ let $\pi \in
  % \aut(C)$ be an extension of $\sigma$. It can be shown that $\pi$ preserves
  % $\equiv$, and hence we can define $\pi /_{\equiv}$. We note that each gate
  % that is either an input or output gate is a member of a singleton
  % equivalence
  % class. Moreover, if $g$ is an internal gate then $\pi /_{\equiv} L
  % /_{\equiv}([g]) (x) = [\pi L(g) (x)] = [L(\pi g) (\lambda x)] = L([\pi g])
  % (\lambda x) = L(\pi /_{\equiv} [g]) (\lambda x)$ for some $\lambda \in
  % \aut(g)$. It follows that $\pi /_{\equiv}$ is an automorphism of
  % $C_{\equiv}$
  % extending $\sigma$, and so $C_{\equiv}$ is symmetric.

  

  % are each members of singleton equivalence classes $\pi /_{\equiv}$ is an
  % automorphism of $C /_{\equiv}$ extending We first define a circuit $C''$ by
  % quotienting $C$ by the syntactic-equivalence relation. Let $H_1, \ldots,
  % H_q$
  % be the syntactic-equivalence classes of $C$, and let $H_i = \{h^i_1, \ldots
  % h^i_{\vert H_i \vert}\}$ for all $i \in [q]$. We now define a circuit $C''$.
  % Let $G'' := G \setminus (\bigcup_{i \in [q]} (H_i \setminus \{h^i_1\}))$. We
  % notice that each input and output gate in $C$ is in a singleton
  % syntactic-equivalence class. Let $\Omega'' := \Omega$ and $\Lambda'' :=
  % \Lambda$. Let $\Sigma'' (g) = \restr{\Sigma}{G''}$. For all $g \in G''$ and
  % $x
  % \in \ind(g)$, if $L(g)(x) \in H_i$ for some $i \in [q]$ then let $L''(g) =
  % h^i_1$. Let $C'' := \langle G'', \Omega'', \Sigma'', \Lambda'', L''
  % \rangle$.
  % Notice that $C''$ is just the process
  
  % Let $q : G \rightarrow G''$ be defined for $g \in G$ by $q(g) = g'$ if, and
  % only if, $g'$ and $g$ are syntactical-equivalent in $C$.

  % For $\sigma \in \sym_n$ let $\pi_\sigma\in \aut(C)$ be an extension of
  % $\sigma$ and let $\pi_\sigma'': G'' \rightarrow G''$ be defined by
  % $\pi_{\sigma}'' (g) = q(\pi_{\sigma}g))$. It can be shown that
  % $\pi_{\sigma}''$ is an automorphism of $C''$ that extends
  
  

  

  % Given a circuit $g$ Let $C' := \op{make-injective-all}(\op{merge-all} (C,
  % G))$
  % (see Definition~\ref{def:make-injective} and~\ref{def:merge-all} for the
  % definitions of these functions). It follows that if $C$ is symmetric then
  % $C'$
  % is symmetric. We have from Lemma~\ref{lem:unique-labels-syntactic-equiv}
  % that
  % the syntactic-equivalence relation can be computed in polynomial time for
  % transparent circuits. It follows that the construction of $C'$ from $C$ can
  % be
  % implemented so as to run in time polynomial in the size of $C$. Clearly
  % every
  % gate $g$ in $C'$ belongs to a singleton syntactic-equivalence equivalence
  % class, and as such $C'$ has unique labels.
\end{proof}

We now show that there is an algorithm that runs in polynomial time and takes as
input a circuit with unique labels and an appropriate permutation and outputs
the action of the automorphism extending the permutation (if it is defined) on the
gates of the circuit.

% \begin{lem}
%   There is an algorithm that takes as an input a circuit $C$ of order $n$
% \end{lem}

% \begin{lem}
%   There is an algorithm takes as input a $(\BB, \rho)$-circuit $C$ of order
%   $n$ with unique labels and $\sigma \in \sym_n$ and outputs for each gate $g$
%   the image of $g$ under the action of the unique automorphism extending
%   $\sigma$ (if it exists). This algorithm runs in time polynomial in the
%   combined size of the input circuit and the encoding of the permutation.
%   \label{lem:compute-automorphisms}
% \end{lem}
% \begin{proof}
%   Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$. We first construct
%   a circuit $C^\sigma$ from $C$ by adding in the image of each gate in $C$
%   under the action of $\sigma$. We now define this circuit formally.
  
%   Let $C^\sigma := \langle G^\sigma, \Omega^\sigma, \Sigma^\sigma,
%   \Lambda^\sigma, L^\sigma \rangle$. For each internal gate $g$ in $G$ we
%   define a new gate $g^\sigma$ and let $G'$ be the set of all of these new
%   gates. Let $G^\sigma = G \ucup G'$. Let $\Lambda^\sigma = \Lambda$ and
%   $\Omega^\sigma = \Omega$. Let $\Sigma^\sigma (g) = \Sigma(g)$ for all $g \in
%   G$ and $\Sigma^\sigma (g^\sigma) = \Sigma (g)$ for all $g^\sigma \in G'$.
%   For each $g \in G$ let $L^\sigma(g) = L(g)$. For each $g^\sigma \in G'$ and
%   $x \in \ind(g^\sigma)$ let $h = L(g)(x)$. If $h$ is an input gate then there
%   is an obvious action of $\sigma$ on $h$ and we let $L^\sigma(g^\sigma)(x) =
%   \sigma h$. If $h$ is an internal gate there there exists $h^\sigma \in G'$
%   and we let $L^\sigma(g^\sigma)(x) = h^\sigma$.

%   We should note that $C^{\sigma}$ does have redundant gates. Let $E, E'
%   \subseteq {G^{\sigma}}^2$ be an equivalence relation defined as follows. Let
%   $(g, g') \in E'$ if, and only if, $g,g' \in G$ and $g \equiv g'$ or there
%   exists $h, h' \in G$ such that $g = h^\sigma$ and $g' = {h'}^\sigma$, and $h
%   \equiv h'$. Let $(g,g') \in E$ if, and only if, $(g, g') \in E'$ or

%   Let $g, g' \in G^{\sigma}$. If $g, g' \in G$ then $g \equiv g'$ if, and only
%   if,$E(g,g')$, and if $g, g' \in G'$ then $E(g, g')$ if

%   It is easy to see that $C^\sigma$ has unique labels and $\vert C^\sigma
%   \vert \leq \vert C \vert$. We may thus use the algorithm from Lemma~\ref{}
%   to compute the syntactic-equivalence classes of $C^\sigma$. We now have the
%   following claim.

%   \begin{claim}
%     Let $\pi \in \aut(C)$ extending $\sigma$. If $g$ and $g'$ are internal
%     non-output gates in $C$ and $g' = \pi (g)$ then $g'$ and $g^\sigma$ are
%     syntactically-equivalent in $C^\sigma$.
%   \end{claim}
%   \begin{proof}
%     We prove this claim by induction on the depth of a gate in the circuit.
%     Let $g$ and $g'$ be internal non-output gates in $C$ and $g' = \pi (g)$.
%     Suppose $g$ and $g'$ have depth $1$ i n $C$. It is clear that both $g$ and
%     $g'$ are non-output internal gates, that $\Sigma (g) = \Sigma (g')$, and
%     that there exists $\lambda \in \aut(g)$ such that $\pi L(g) = L(g')
%     \lambda$. But, since $g$ and $g'$ have depth $1$ and so all of their
%     children are input gates, we have for all $x \in \ind(g)$, that
%     $L^\sigma(g^\sigma)(x) = \pi L(g)(x) = L(g') \lambda = L^\sigma(g')
%     \lambda$. It follows that $g^\sigma$ and $g'$ are syntactically-equivalent
%     in $C^\sigma$.

%     Suppose $g$ and $g'$ have depth $i > 1$ and the result holds for all pairs
%     of gates of depth less than $i$. It follows that there exists $\lambda \in
%     \aut(g)$ such that $\pi L(g) = L(g') \lambda$. Let $x \in \ind(g)$ and let
%     $h = L(g)(x)$. If $h$ is an input gate then $L^\sigma(g^\sigma)(x) = \pi
%     L(g)(x) = L(g')(\lambda x) = L^\sigma(g')(\lambda x)$. If $h$ is not an
%     input gate then $L^\sigma (g^\sigma)(x) = h^\sigma$. We have that $\pi (h)
%     = \pi L(g)(x) = L(g')(\lambda x)$ and, from the inductive hypothesis, we
%     have that $\pi(h)$ is syntactically-equivalent to $h^\sigma$ in
%     $C^\sigma$. But then $L^\sigma (g^\sigma)(x) = h^\sigma \equiv \pi(h) =
%     L(g')(\lambda x) = L^\sigma(g')(\lambda x)$. The claim follows.
%   \end{proof}

%   each point in this construction, when extending the mapping by a single
%   gate, we notice that in each case there is only one choice of possible
%   gate.If at some point in the recursive construction we arrive at a point
%   where no mapping for $h$ can be found we halt at that point and return that
%   no automorphism exists.

%   For each gate $h$ in $C$ let $Q(h)$ be the maximum length of a path from $h$
%   to an output gate. Let $h$ be a gate in $C$. Suppose $Q(h) = 0$. Then $h$ is
%   an output gate. We recall that $\Omega$ is an injection. Let $\vec{a} =
%   \Omega^{-1}(g)$ and let $h' \in G$ be such that $h' = \Omega (\sigma
%   \vec{a})$ and $\Sigma (h) = \Sigma (h')$. Let $\pi (h) = h'$. Note that
%   there is no other partial-automorphism extending $\sigma$ on the output
%   gates of $C$, so if at this point we have failed to construct $\pi$ then
%   there is indeed no automorphism extending of $\sigma$.

%   Suppose $h$ is a gate in the circuit with $Q(h) > 0$ and for all $g$ with
%   $Q(g ) < Q(h)$ we have defined $\pi (g)$ and that $\pi$ is a partial
%   automorphism extending $\sigma$. Let $H = \bigcap_{g \in W(h, \cdot)}
%   H_{\pi(g)}$. Notice that if there is an automorphism extending $\sigma$ then
%   the image of $h$ under the action of that automorphism is in $H$. As such,
%   if $H$ is empty we halt and output that no extension exists. Suppose that
%   $H$ is non-empty. If $h$ is an input gate then there is an obvious action of
%   $\sigma$ on $h$, and we let $h' = \sigma h$. If $h$ is an output gate, let
%   $\vec{a} = \Omega^{-1}(g)$ and let $h' \in G$ be such that $h' = \Omega
%   (\sigma \vec{a})$ and $\Sigma (h) = \Sigma (h')$. If $h' \not\in H$ we halt
%   and output that no extension exists, and otherwise we let $\pi (h) = h'$.
%   Notice that in the case that $h$ is an output gate or an input gate there is
%   at most one choice of $h'$. Suppose $h$ is an internal non-output gate. Let
%   $h' \in H$ such that $h'$ is syntactically-equivalent to $h^\sigma$ in
%   $C^\sigma$. If not such $h'$ exists then, from the claim, there is no
%   extension of $\sigma$ to an automorphism of the circuit, and so we halt and
%   output accordingly. Suppose that $h'$ does exist. We now show that $h'$ is
%   unique. Let $h'' \in H$ such that $h''$ is syntactically-equivalent to
%   $h^\sigma$ in $C^\sigma$. It follows that there exists $g \in W(h, \cdot)$
%   such that $h', h'' \in H_g$ and $g$ has unique labels. Moreover, $h'$ and
%   $h''$ are syntactically-equivalent in $C^\sigma$ and so, from the
%   construction of $C^\sigma$, $h'$ and $h''$ are syntactically-equivalent in
%   $C$. But then $h' \equiv h''$ and so, since $g$ has unique labels, $h' =
%   h''$. Let $\pi (h) = h'$. Notice that in each case there is at most one
%   possible extension of $\pi$ to $h$.

%   \begin{claim}
%     There is an automorphism extending $\sigma$ if, and only if, $\pi$ is an
%     automorphism extending $\sigma$.
%   \end{claim}
%   \begin{proof}
%     `$\Rightarrow$': trivial `$\Leftarrowrrow$' : Let $\pi'$ be an
%     automorphism extending $\sigma$. We show by induction on the structure of
%     the circuit that for all $h \in G$, $\pi'(h) = \pi(h)$. Let $h \in G$. If
%     $Q(h) = 0$ then $h$ is an output gate. Let $\vec{a} = \Omega(h)$. We have
%     from the definition of $\pi$ and the definition of an automorphism that
%     $\pi(h) = \Omega(\sigma \vec{a}) = \pi'(\Omega(\vec{a})) = \pi' (h)$.
    

%     Suppose $Q(h) > 0 $ and for all gates $g \in G$ with $Q(g) < Q(h)$, $\pi
%     (g) = \pi'(g)$. If $h$ is an output gate then the above argument suffices
%     to show that $\pi(h) = \pi'(h)$. If $h$ is is easy to see that $\pi (g) =
%     \pi'(g)$. Suppose that $h$ is a non-output internal gate. We have from the
%     previous claim that $\pi'(h)$ is syntactically-equivalent to $h^\sigma$ in
%     $C^\sigma$. We already have that $\pi(h)$ is syntactically-equivalent to
%     $h^\sigma$. It follows that $\pi (h)$ and $\pi'(h)$ are
%     syntactically-equivalent. Let $g \in W(h, \cdot)$. We have that $\pi(h)
%     \in H_{\pi(g)}$ and $\pi'(h) \in H_{\pi'(g)}$. From the inductive
%     hypothesis $\pi (g) = \pi'(g)$, and so $\pi' (h) \in H_{\pi(g)}$. But
%     $\pi(g)$ has unique labels and $\pi(h)$ and $\pi'(h)$ are
%     syntactically-equivalent. It follows that $\pi (h) = \pi'(h)$.
%   \end{proof}
  
%   It remains to check that $\pi$ is an automorphism extending $\sigma$. It
%   suffices to check that for each $g \in G$, there exists $\lambda \in
%   \aut(C)$ such that $\pi L(g) = L(\pi g) \lambda$. But this is equivalent to
%   testing if for each $g \in G$, $L(\pi g) \pi L(g)^{-1}$ acts like an
%   automorphism. This is easy to check. We check if $\Sigma (h) = \Sigma (h')$
%   and check that both
 

%   If there is no such $h'$ then either $\bigcap_{g \in W(h, \cdot)}
%   H_{\pi(g)}$ is empty or it is non-empty but th


%   $g' \in W(\pi(h), \cdot)$


%   (g)(x) = \$

%   Then for all $x \in \ind(g)$, $L(g)(x)$


%   We should note that $C^\pi$ has unique labels.


%   Let $C_0 = C$. Let $i \in [\depth(g)]$. Let $C_i := \langle G_i, \Omega_i,
%   \Sigma_i, \Lambda_i, L_i\rangle$ be defined from $C_{i-1} := \langle
%   G_{i-1}, \Omega_{i-1}, \Sigma_{i-1}, \Lambda_{i-1}, L_{i-1} \rangle$ as
%   follows. For each internal gate $h \in G$ such that $\depth(h) = i$ and
%   either $W_T(h,g)$ or $h = g$ we define a new gate $h^\pi$. Let $G_i'$ be the
%   set of all these new gates and let $G_i = G_{i-1} \uplus G_i'$. Let
%   $\Omega_i = \Omega_{i-1}$ and $\Lambda_i = \Lambda_{i-1}$. Let $h' \in G_i$.
%   If $h' \in G_{i-1}$ then $\Sigma_i(h') = \Sigma_{i-1}(h')$ and $L_i(h') =
%   L_{i-1}(h')$. If $h' \not\in G_i$ then $h' \in G_i'$ and so $h' = h^\pi$ for
%   some appropriate $h \in G$. Let $\Sigma_i(h') = \Sigma_{i-1} (h)$. Let $x
%   \in \ind(h')$ and let $h_x := L(h)(x)$. If $h_x$ is an input gate let
%   $L(h')(x) = \sigma L(h)(x)$. Otherwise, $h_x$ is an internal gate and,
%   moreover, $W_T(h_x,g)$ and the depth of $h_x$ is less than $i$. We thus have
%   that there exists $h^\pi_x \in G_i$ corresponding to $h^\pi_x$.

%   \begin{claim}
%     For each $g' \in W(\cdot, \pi(h))$, $g'$ is the image of $g$ under the
%     action of $\sigma$ if, and only if, $g'$ is syntactically-equivalent to
%     $g^\pi$ in $C_g$.
%   \end{claim}
%   \begin{proof}
%   \end{proof}
%   Let $L(h')(x) = h^{\pi}_x$.

%   Let $C_g = C_{\depth(g)}$. Let



%   otherwise let $L(h')(x) = h^\pi_x$.

%   $L(h')(x) =.

%   let $g_h' = L(h)^{-1}(g)$

 
%   Let $h$ be any gate in the circuit. Suppose $h$ is an input gate. If $h$ is
%   a constant gate then let $\pi (h) = h'$. If $h$ is a relational gate such
%   that $R := \Sigma(h)$, then check if there exists $h'$ such that $\Sigma
%   (h') = R$, $\sigma \Lambda_R(h) = \Lambda_R(h')$, and either both $h$ and
%   $h'$ are output gates or neither are. If no such $h'$ exists then halt and
%   output that no automorphism exists. If neither $h$ nor $h'$ are output gates
%   then set $\pi (h) = h'$. If both $h$ and $h'$ are output gates then check if
%   $\sigma \Omega^{-1}(h) = \Omega^{-1}(h')$. If the equality holds set $\pi(h)
%   = h'$, otherwise halt and output that no automorphism exists. We have from
%   Proposition~\ref{prop:unique-children-unique-extensions} that there is at
%   most one gate $h'$ that meets the above criteria, and so $\pi(h)$ is well
%   defined.

%   Let $h$ be an internal gate in the circuit and assume we have defined $\pi
%   (g)$ for every gate $g$ of depth less than $h$. Let $h'$ be a gate in the
%   circuit such that $\Sigma(h) = \Sigma (h')$, $\pi L(h)$ is
%   isomorphism-equivalent to $L(h')$ and, if $h$ is an output gate then $h'$ is
%   an output gate such that $\sigma \Omega^{-1}(h) = \Omega^{-1}(h')$. Since
%   $C$ has unique labels (and so unique extensions) we have that $\pi L(h)$ is
%   isomorphism-equivalent to $L(h')$ if, and only if, $L(h')^{-1}\pi L(h)$ acts
%   on $\ind(h)$ like an automorphism of $\str{h}$. This can be determined
%   easily. If no such $h'$ exists halt and output that there is no automorphism
%   extending $\sigma$. Since $C$ has unique labels it has unique extensions,
%   and so there is at most one such $h'$. We thus let $\pi (h) = h'$.

%   This recursive approach can be implemented as an algorithm that runs in time
%   polynomial in the combined size of the inputs and outputs the required
%   automorphism if it exists.
% \end{proof}

\begin{lem}
  There is an algorithm takes as input a $(\BB, \rho)$-circuit $C$ of order $n$
  with unique labels and $\sigma \in \sym_n$ and outputs for each gate $g$ the
  image of $g$ under the action of the unique automorphism extending $\sigma$
  (if it exists). This algorithm runs in time polynomial in the combined size of
  the input circuit and the encoding of the permutation.
  \label{lem:compute-automorphisms}
\end{lem}
\begin{proof}
  Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$. Let $C_\equiv =
  \langle G_\equiv, \Omega_\equiv, \Sigma_\equiv, \Lambda_\equiv, L_\equiv
  \rangle$ be a quotient of $C$. We recursively build up the mapping $\pi' \in
  \aut(C_\equiv)$ extending $\sigma$. If at some point in the recursive
  construction we arrive at a point where no mapping for $g$ can be found we
  halt at that point and return that no automorphism exists.

  Let $h$ be any gate in $C_\equiv$. Suppose $h$ is an input gate. If $h$ is a
  constant gate then let $\pi' (h) = h$. If $h$ is a relational gate such that
  $R := \Sigma_\equiv(h)$, then check if there exists $h'$ such that
  $\Sigma_\equiv (h') = R$ and $\sigma \Lambda_\equiv(h) = \Lambda_\equiv(h')$,
  and also check that either both $h$ and $h'$ are output gates or neither are
  output gates. If no such $h'$ exists then halt and output that no automorphism
  exists. If neither $h$ nor $h'$ are output gates then set $\pi'(h) = h'$. If
  both $h$ and $h'$ are output gates then check if $\sigma \Omega^{-1}_\equiv(h)
  = \Omega^{-1}_\equiv(h')$. If the equality holds set $\pi'(h) = h'$, otherwise
  halt and output that no automorphism exists. We note that, from the definition
  of an automorphism, there is at most once such $h'$ meeting this criteria, and
  so $\pi'(h)$ is well-defined.

  Let $h$ be an internal gate in the circuit and assume we have defined
  $\pi'(g)$ for every gate $g$ of depth less than $h$. Let $h'$ be a gate in the
  circuit such that $\Sigma_\equiv(h) = \Sigma_\equiv (h')$, $\pi' L(h)$ is
  isomorphism-equivalent to $L_\equiv(h')$ and, if $h$ is an output gate then
  $h'$ is an output gate such that $\sigma \Omega^{-1}_\equiv(h) =
  \Omega^{-1}_\equiv(h')$. Suppose there is another gate $h''$ in the circuit
  that meets all of those criteria as well. But then it follows that $h'' \equiv
  h'$. Since $C_\equiv$ is reduced, we then have that $h'' = h'$.  We thus have
  that the choice of $h'$, if it exists, is unique. Note that, since $C$ has
  unique labels $C_\equiv$ has unique labels, and so unique extensions, and so
  we have that $\pi' L_\equiv(h)$ is isomorphism-equivalent to $L_\equiv(h')$
  if, and only if, $L_\equiv(h')^{-1}\pi'L_\equiv(h)$ acts on $\ind(h)$ like an
  automorphism of $\str{h}$. This is easy to determine. If no such $h'$ exists,
  halt and output that there is no automorphism extending $\sigma$. Otherwise,
  let $\pi'(h) = h'$.

  It is easy to see that if there is an automorphism of $C_\equiv$ extending
  $\sigma$ then this construction must have been successful and $\pi'$ is the
  unique automorphism of $C_\equiv$ extending $\sigma$. Thus, if we have thus
  far halted and returned that no automorphism exists, then indeed there is no
  automorphism of $C_\equiv$ extending $\sigma$ and so, from
  Lemma~\ref{lem:quotient-circuits-preserve}, no automorphism of $C$ extending
  $\sigma$. We suppose the algorithm has not halted, and thus that $\pi'$ is an
  automorphism of $C_\equiv$ extending $\sigma$.

  We say that a function $\pi : G \rightarrow G$ is a \emph{pseudo-automorphism}
  extending $\sigma$ if (i) $\pi$ acts like an automorphism extending $\sigma$
  on the input and output gates, (ii) $\Sigma (\pi (h)) = \Sigma(h)$ for all $h
  \in G$, (iii) $\pi(h) \in H_{\pi(g)}$ for all $h \in G$ and $g \in W(h,
  \cdot)$, and (iv) $\pi (h) \in \pi'([h])$.

\begin{claim}
  If $\pi$ is an automorphism of $C$ extending $\sigma$ then $\pi$ is a
  psudo-automorphism extending $\sigma$.
\end{claim}
\begin{proof}
  Suppose $\pi$ is an automorphism of $C$ extending $\sigma$. It is easy to see
  that conditions (i), (ii) and (iii) are satisfied. We now show that (iv) is
  satisfied as well. Notice that, since $C_\equiv$ is reduced and so has unique
  extensions, $\pi'$ is the unique automorphism of $C_\equiv$ extending
  $\sigma$. We have from Lemma~\ref{lem:quotient-circuits-preserve} that there
  exists $\pi_\equiv \in \aut(C_\equiv)$ extending $\sigma$ such that
  $\pi_\equiv ([g]) = [\pi(g)]$. It follows that for all $h \in G$, $\pi(h) \in
  \pi_\equiv([h]) = \pi'([h])$.
\end{proof}

We now recursively build up the pseudo-automorphism $\pi$ extending $\sigma$. If
at any point in this construction we assert that an object exists when it does
not, we halt and output that there is no automorphism extending $\sigma$.
Importantly, this construction is defined such that $\pi$, if it exists, is the
\emph{unique} pseudo-automorphism extending $\sigma$.

For each gate $h$ in $C$ let $Q(h)$ be the maximum length of a path from $h$ to
an output gate. Let $h$ be a gate in $C$. Suppose $Q(h) = 0$. Then $h$ is an
output gate. Let $h' \in G$ be such that $h' = \Omega (\sigma \Omega^{-1}(h))$
and $\Sigma (h) = \Sigma (h')$. From the definition of an automorphism if $h'$
exists it is the unique gate satisfying these criteria. We let $\pi (h) = h'$.

Suppose $h$ is a gate in the circuit with $Q(h) > 0$ and for all $g$ such that
$Q(g ) < Q(h)$ we have defined $\pi (g)$. Let $H = \bigcap_{g \in W(h, \cdot)}
H_{\pi(g)}$. If $H$ is empty then we cannot satisfy condition (iii) in the
definition of a pseudo-automorphism, and so we halt and output that no extension
exists. Suppose that $H$ is non-empty. If $h$ is an input gate then there is an
obvious action of $\sigma$ on $h$, and we let $h' = \sigma h$. If $h$ is an
output gate, let $h' \in G$ be such that $h' = \Omega (\sigma \Omega^{-1} (h))$
and $\Sigma (h) = \Sigma (h')$. If $h' \not\in H$ we halt and output that no
extension exists, and otherwise we let $\pi (h) = h'$. Notice that in the case
that $h$ is an output gate or an input gate then from the definition of an
automorphism $h'$ is the unique gate satisfying these criteria. Suppose $h$ is
an internal non-output gate. Let $h_\equiv \in G_\equiv$ be such that $h_\equiv
= [h]$. Let $h' \in \pi_\equiv (h_\equiv)$ be such that $h' \in H$. We now show
that $h'$, if it exists, is the unique gate satisfying these criteria. Let $h''
\in \pi_\equiv (h_\equiv)$ and $h'' \in H$. Then $h'' \equiv h'$ and for all $g
\in W(h, \cdot)$, $h' \in H_g$ and $h'' \in H_g$. But then, since every $g \in
W(h, \cdot)$ has unique labels, $h'' = h'$. Let $\pi (h) = h'$.

It is easy to see that if there is a pseudo-automorphism of $C$ extending
$\sigma$ then this construction must have been successful, and $\pi$ is the
unique pseudo-automorphism extending $\sigma$. It follows that if the algorithm
has halted, then there is no pseudo-automorphism extending $\sigma$ and so, from
the claim, there is indeed no automorphism extending $\sigma$. We suppose then
that the algorithm has not halted and we have constructed $\pi$ successfully. It
follows from the claim and the uniqueness of $\pi$ that if there is an
automorphism extending $\sigma$ than it must be equal to $\pi$, and so $\pi$ is
an automorphism. We thus have that there is an automorphism extending $\sigma$
if, and only if, $\pi$ is an automorphism.  It remains to check that $\pi$ is an
automorphism.  It suffices to check that $\pi$ is a bijection and that for each
$h \in G$, $\pi L(h)$ is isomorphic to $L(h')$. It is easy to check
that $\pi$ is a bijection.  Notice that $\pi L(h)$ is isomorphic to
$L(\pi(h))$ if, and only if, $L(\pi(h))^{-1}\pi L(h)$ is an automorphism. This
condition is also easy to check.  If either of these checks fail, halt and output
that there is no automorphism extending $\sigma$.  Otherwise, output $\pi (g)$
for all $g \in G$.

We note that, since $C$ has unique labels, we can compute $C_\equiv$ in
polynomial-time. Moreover, it is easy to see that the construction of $\pi'$ and
$\pi$ can be completed in polynomial-time. We thus have that the algorithm
described may be implemented so as to run in polynomial-time.
\end{proof}


% \begin{lem}
%   There is an algorithm takes as input a $(\BB, \rho)$-circuit $C$ of order
%   $n$ with unique labels and $\sigma \in \sym_n$ and outputs for each gate $g$
%   the image of $g$ under the action of the unique automorphism extending
%   $\sigma$ (if it exists). This algorithm runs in time polynomial in the
%   combined size of the input circuit and the encoding of the permutation.
%   \label{lem:compute-automorphisms}
% \end{lem}
% \begin{proof}
%   Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$. We recursively
%   build up the mapping $\pi$ extending $\sigma$. If at some point in the
%   recursive construction we arrive at a point where no mapping for $g$ can be
%   found we halt at that point and return that no automorphism exists.

%   Let $h$ be any gate in the circuit. Suppose $h$ is an input gate. If $h$ is
%   a constant gate then let $\pi (h) = h'$. If $h$ is a relational gate such
%   that $R := \Sigma(h)$, then check if there exists $h'$ such that $\Sigma
%   (h') = R$, $\sigma \Lambda_R(h) = \Lambda_R(h')$, and either both $h$ and
%   $h'$ are output gates or neither are. If no such $h'$ exists then halt and
%   output that no automorphism exists. If neither $h$ nor $h'$ are output gates
%   then set $\pi (h) = h'$. If both $h$ and $h'$ are output gates then check if
%   $\sigma \Omega^{-1}(h) = \Omega^{-1}(h')$. If the equality holds set $\pi(h)
%   = h'$, otherwise halt and output that no automorphism exists. We have from
%   Proposition~\ref{prop:unique-children-unique-extensions} that there is at
%   most one gate $h'$ that meets the above criteria, and so $\pi(h)$ is well
%   defined.

%   Let $h$ be an internal gate in the circuit and assume we have defined $\pi
%   (g)$ for every gate $g$ of depth less than $h$. Let $h'$ be a gate in the
%   circuit such that $\Sigma(h) = \Sigma (h')$, $\pi L(h)$ is
%   isomorphism-equivalent to $L(h')$ and, if $h$ is an output gate then $h'$ is
%   an output gate such that $\sigma \Omega^{-1}(h) = \Omega^{-1}(h')$. Since
%   $C$ has unique labels (and so unique extensions) we have that $\pi L(h)$ is
%   isomorphism-equivalent to $L(h')$ if, and only if, $L(h')^{-1}\pi L(h)$ acts
%   on $\ind(h)$ like an automorphism of $\str{h}$. This can be determined
%   easily. If no such $h'$ exists halt and output that there is no automorphism
%   extending $\sigma$. Since $C$ has unique labels it has unique extensions,
%   and so there is at most one such $h'$. We thus let $\pi (h) = h'$.

%   This recursive approach can be implemented as an algorithm that runs in time
%   polynomial in the combined size of the inputs and outputs the required
%   automorphism if it exists.
% \end{proof}

We now use Lemma~\ref{lem:compute-automorphisms} to define an algorithm that
computes in polynomial-time the image of a given element of the universe of a
gate under the action of a given permutation.

\begin{lem}
  There is an algorithm that takes as input a $(\mathbb{B}, \rho)$-circuit $C$ with
  unique labels of order $n$, a gate $\sigma \in \sym_n$, $g$ a gate in $C$, and
  $a \in \universe{g}$ and, if there exists an automorphism of $C$ extending
  $\sigma$ such that $\sigma \in \stab(g)$, outputs $\sigma a$.
  The algorithm runs in time polynomial in the size of $C$ and the encoding of
  $\sigma$.
  \label{lem:compute-automorphisms-labels}
\end{lem}
\begin{proof}
  Let $C = \langle G, \Omega, \Sigma, \Lambda, L \rangle$. We use the algorithm
  from Lemma \ref{lem:compute-automorphisms} to check if $\sigma$ extends to an
  automorphism on $C$. We also check if $\sigma \in \stab(g)$. If either of
  these checks fail, halt and return that no such automorphism exists. Let $h
  \in H_g$ and $\vec{b}_R := L(g)^{-1}(h)$ be such that $a \in \vec{b}_R$, and
  let $i$ be the index of $a$ in $\vec{b}_R$. Halt and output $\sigma a =
  (L(g)^{-1}(\sigma h))(i)$.
\end{proof}

We aim to show that it is possible to compute in polynomial-time the orbits and
canonical supporting partitions of the gates, and elements of the universes of
the gates, of a given circuit with unique labels. In order to prove this, we
first prove a more general result which shows that there is a polynomial-time
algorithm that takes as input a set $X$, an element $x \in X$, and a
polynomial-time computable group action on $X$, and computes the orbit and
canonical supporting partition of $x$.

\begin{lem}
  \label{lem:computing-support-orbit}
  Let $p$ be a polynomial. There is an algorithm that takes as input a set $S
  \subseteq [n]$, a set $X$, an element $x \in X$, and a Turing machine $T$
  computing the action of $\stab(S)$ on $X$ that runs in time bounded by $p(n +
  \vert X \vert)$, and outputs $\orb_{\stab(S)} (x)$ and $\SP_{\stab(S)}(x)$.
  This algorithm runs in time polynomial in $n + \vert X \vert + \vert T \vert$.
\end{lem}
\begin{proof}
  Let $(u, v) \in \sym_{[n] \setminus S}$ be a transposition. We note that
  $(u,v) \in \stab(S)$ and there are ${n - \vert S \vert}\choose{2}$ many such
  transpositions. For a transposition $(u, v) \in \sym_{[n] \setminus S}$, let
  \begin{align*}
    \mathcal{P}_{(u,v)} := \{ \{u,v\}\} \cup \bigcup_{w \in [n] \setminus \{ u,v \}} \{ \{ w \} \}
  \end{align*}
  be a partition of $[n]$. Then $\mathcal{P}_{(u,v)}$ supports
  $\stab_{\stab(S)}(x)$ if, and only if, $(u,v) \cdot x = x$.

%  Let $\mathcal{P}$ be the partition formed by applying $\mathcal{E}$ to every
%  $\mathcal{P}_{(u,v)}$ with $(u,v) \cdot x = x$ in succession. 

Let  $\mathcal{P}$ be the partition that is the coarsest common
refinement of the partitions $\mathcal{P}_{(u,v)}$, for all $u,v$ with $(u,v) \cdot x = x$.
From
  Proposition~\ref{prop:combining-supporting-patitions} we have that
  $\mathcal{P}$ supports $\stab_{\stab(S)}(x)$. Suppose that $\mathcal{P}$ is
  not the coarsest supporting partition of $\stab_{\stab(S)}(x)$. Then there
  exists a partition $\mathcal{P}'$ supporting $\stab_{\stab(S)}(x)$ such that
  $\mathcal{P}' \preceq \mathcal{P}$ and $\mathcal{P}' \neq \mathcal{P}$. And so there
  exists $P \in \mathcal{P}$ and $P' \in \mathcal{P}'$ such that $P \subsetneq
  P'$. But then there exists $a , b \in P'$ such that $a \not\in P$. Note that
  $(a,b)$ fixes $\mathcal{P}'$ and, since $\mathcal{P}'$ supports
  $\stab_{\stab(S)}(x)$, it follows that $(a,b) \in \stab_{\stab(S)}(x)$ and $a
  \not\in S$ and $b \not\in S$. But then we have that $(a,b) \cdot x = x$, and
  so $\mathcal{P}_{(a,b)}$ supports $\stab_{\stab(S))}(x)$ and thus, from the
  construction of $\mathcal{P}$, $\mathcal{P}$ is fixed by $(a,b)$. But we
  selected $a$ and $b$ such that $\mathcal{P}$ is not fixed by $(a,b)$, and so
  we have a contradiction. We thus have that $\mathcal{P}$ is the coarsest
  supporting partition of $\stab_{\stab(S)}(x)$.

  It remains to compute $\orb_{\stab(S)}(x)$. Let $M_0 := \{x\}$ and for each $i
  \geq 0$ let $M_{i+1} := M_i\cup (\bigcup_{(u,v) \in \sym_{[n] \setminus S}}
  ((u,v) \cdot M_i))$. Let $M \subseteq X$ be the union of this sequence. It is
  easy to see that $M \subseteq \orb_{\stab(S)}(x)$ as every element of $M$ is
  equal to the action of some finite sequence of transpositions acting on $x$.
  Moreover, if $y \in \orb_{\stab(S)}(x)$, then there exists $\pi \in \stab(S)$
  such that $y = \pi \cdot x$. But then, since $\sym_{[n] \setminus S}$, is
  generated by the set of all transpositions in $\sym_{[n] \setminus S}$, it
  follows that $\pi$ can be written as a sequence of $t$ transpositions for some
  $t \in \nats$. Thus $y \in M_t \subseteq M$, and hence $\orb_{\stab(S)}(x)
  \subseteq M$, and so $\orb_{\stab(S)}(x) = M$.

  Note that the set of all transpositions in $\sym_{[n] \setminus S}$ can be
  computed in time $\mathcal{O}(n^{2})$, and we can check if a given
  transposition fixes $x$ by simulating $T$ with the given transposition and $x$
  as inputs. Moreover, since it is easy to show that $\mathcal{E}$ can be
  computed in time polynomial in $n$, it follows that $\mathcal{P}$ can be
  computed in $\mathcal{O} (n^2 \vert T \vert p(\vert X \vert +n)^2 q(\vert X
  \vert + n))$, for some polynomial $q$.

  Furthermore, when computing the orbit, we construct $M_i$
  iteratively and obtain the orbit after at most $\vert X \vert$
  iterations. Since each iteration requires at
  most $\mathcal{O} (n^{2})$ applications of the group action, it follows that
  this part of the procedure runs time $\mathcal{O}(n^2\vert X \vert \vert T
  \vert p (\vert X \vert + n)^2)$. We thus have that the entire algorithm runs
  in polynomial-time, and the result follows.
\end{proof}

We now apply Lemma~\ref{lem:computing-support-orbit} and show that there is a
polynomial-time algorithm that takes as input a circuit with unique labels and
decides if the circuit is symmetric and, if it is, outputs the orbit and
canonical supporting partition of each gate in the circuit.

\begin{lem}
  There is an algorithm that takes in a circuit $C$ with unique labels and
  outputs if the circuit is symmetric. If it is symmetric then it outputs the
  orbit and coarsest supporting partition of each gate. This algorithm runs in
  time polynomial in the size of the circuit.
  \label{lem:computing-support-orbit-gate}
\end{lem}

\begin{proof}
  Let $n$ be the order of $C$. We have from
  Lemma~\ref{lem:compute-automorphisms} that there is a Turing machine $T'$ that
  takes as input a circuit with unique labels and a permutation and outputs the
  image of each gate (if it exists) in polynomial-time. We define a Turing
  machine $T$ that takes as input a permutation $\sigma \in \sym_n$ and a gate
  $g$ in $C$, runs $T'$ with inputs $C$ and $\sigma$ and outputs the image of
  $g$ under the action of $\sigma$ (if it exists).

  For each transposition $(u,v) \in \sym_n$ and each gate $g$ in $C$ we use $T$
  to check if the image of $g$ under the action of $(u,v)$ exists. If for any
  transposition and gate $T$ returns that no image exists then we halt and
  output that the circuit is not symmetric.

  We note that if every gate has an image under the action of every
  transposition then, since $\sym_n$ is generated by the set of transpositions,
  we have that $C$ is symmetric.

  For each gate $g$ in $C$ we run the algorithm from
  Lemma~\ref{lem:computing-support-orbit} with $S := \emptyset$, $X := G$ (where
  $G$ is the set of gates in $C$), $x := g$, and Turing machine $T$, and output
  the result of this computation.
  
  We note that there are ${{n}\choose{2}} \leq n^2$ transpositions in $\sym_n$
  and so, since from Lemma~\ref{lem:compute-automorphisms} the action of a
  transposition on the gates of the circuit can be computed in polynomial-time,
  the initial symmetry check can be completed in polynomial-time. Moreover, from
  the polynomial-time bounds in Lemmas~\ref{lem:compute-automorphisms}
  and~\ref{lem:computing-support-orbit}, we have that the rest of the algorithm
  also runs in time polynomial in the size of the circuit.
\end{proof}

We now extend Lemma~\ref{lem:computing-support-orbit-gate} and construct a
polynomial-time algorithm that computes the orbit and canonical supporting
partition of each element of the universe of each gate in a circuit.

\begin{lem}
  There is an algorithm that takes in a circuit $C$ of order $n$ with unique
  labels, a gate $g$ in $C$ with small support, and $a \in \universe{g}$, and
  outputs if the circuit is symmetric. If $C$ is symmetric it outputs the orbit
  $\orb_{\consp(g)} (a)$ and coarsest supporting partition $\SP_{\consp(g)}(a)$.
  This algorithm runs in time polynomial in the size of the circuit.
  \label{lem:computing-support-orbit-index}
\end{lem}
\begin{proof}
  We first use the algorithm from Lemma~\ref{lem:computing-support-orbit-gate}
  to compute the canonical support of $g$. If the algorithm returns that $C$ is
  not symmetric, output that $C$ is not symmetric.

  We have from Lemma~\ref{lem:compute-automorphisms-labels} that there is a
  Turing machine $T'$ that takes as input a circuit with unique labels, a gate,
  an element of the universe of that gate, and a permutation, and outputs the
  image of the given element under the action of the given permutation (if it
  exists). We define a Turing machine $T$ that takes as input an element $b \in
  \consp(g)$ and a permutation $\sigma \in \spstab{g}$ outputs the result of
  running $T'$ with inputs $C$, $\sigma$, $g$ and $b$.

  We then use the algorithm from Lemma~\ref{lem:computing-support-orbit}, with
  inputs $S := \consp(g)$, $X := \universe{g}$ and $x:= a$, and the Turing
  machine $T$, and output the results.

  We have from the bounds in Lemmas~\ref{lem:compute-automorphisms-labels}
  and~\ref{lem:computing-support-orbit} that this algorithm runs in time
  polynomial in the size of the circuit.
\end{proof}

We have so far shown that transparent circuits, and circuits with unique labels,
have all of the requisite algorithmic properties needed to prove our main
result. However, since transparency is defined in terms of
syntactic-equivalence, and testing syntactic-equivalence seems to require an
isomorphism test, it is not at all obvious that transparency itself is a
polynomial-time decidable property of circuits. Indeed, if transparency is not
polynomial-time decidable, it would suggest this restriction to transparent
circuits is quite unnatural, and it may undermine the usefulness of the
characterisation presented in this paper. We now show that the class of
transparent circuits is polynomial-time decidable.

\begin{prop}
  There is an algorithm that takes as input a circuit and decides if that
  circuit is transparent. This algorithm runs in time polynomial in the size of
  the circuit.
  \label{prop:transparent-polynomial-time}
\end{prop}
\begin{proof}
  Let $C = \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a $(\mathbb{B},
  \rho)$-circuit. We first check that, for each non-symmetric gate $g \in G$,
  $L(g)$ is an injection. If not, we return that $C$ is not transparent.

  For each $p \in \nats$ let $G^p \subseteq G$ be the set of all gates of depth
  $p$ and let $G^{\leq p} = \bigcup_{0 \leq i \leq p}G^i$. Since no two input
  gates are syntactically-equivalent, a gate in $G^1$ has unique labels if, and
  only if, it has injective labels. We thus check if there exists a
  non-symmetric gate in $G^1$ that does not have injective labels, and if we
  find such a gate we halt and output that the circuit is not transparent. We
  then run the following iterative algorithm. We initialise a variable $i$ to
  $1$. We have that all of the non-symmetric gates in $G^{\leq i}$ have unique
  labels. We can thus compute the syntactic-equivalence classes of $G^{\leq i}$
  using the algorithm given in Lemma~\ref{lem:transparent-syntactic-equiv}. We
  test if every non-symmetric gate in $G^{i+1}$ has unique labels, i.e.\ if
  it has injective labels and no two of its children are elements of the same
  syntactic-equivalence class. If this test fails, we halt and output that the
  circuit is not transparent, and if it succeeds we increment the variable $i$ and
  continue as above. If $i$ is ever set to the value $\depth(C)$, we halt and
  output that the circuit is transparent.

  It is easy to see that the above algorithm can be implemented so as to run in
  polynomial time.
\end{proof}

We can similarly show that the class of circuits with unique labels is
polynomial-time decidable.

\begin{cor}
  There is an algorithm that takes in a circuit and decides if that circuit has
  unique labels and runs in time polynomial in the size of the circuit.
  \label{cor:unique-labels-polynomial-time}
\end{cor}
\begin{proof}
  Let $C$ be the input circuit. From
  Proposition~\ref{prop:transparent-polynomial-time} we may check if $C$ is
  transparent in time polynomial in the size of $C$. If $C$ is not transparent
  halt and output that $C$ does not have unique labels. If $C$ is transparent
  then from Lemma~\ref{lem:transparent-syntactic-equiv} we may compute the
  syntactic-equivalence relation for the gates of $C$ in time polynomial in the
  size of $C$. Note that $C$ has unique labels if, and only if, for each gate
  $g$ in $C$, $\vert \ind(g) \vert = \vert H_g /_\equiv \vert$. We may thus
  check if $C$ has unique labels by iterating through the gates of $C$.
\end{proof}

% Anderson and Dawar~\cite{AndersonD17}, in their study of circuits with
% symmetric gates, show that such circuits may be transformed in polynomial time
% into equivalent circuits with unique extensions. They do this by showing that
% a circuit with symmetric gates may be transformed into an equivalent
% \emph{rigid} circuit in polynomial time, and that all rigid circuits have
% unique extensions. Moreover, they also prove the existence of polynomial-time
% algorithms computing the action of a permutation on a rigid circuit, and the
% orbits and coarsest supporting partitions of gates in a rigid circuits. We
% have shown that transparent circuits can be translated into equivalent
% circuits with unique labels in polynomial time, and that circuits with unique
% labels have unique extensions (see
% Proposition~\ref{prop:unique-children-unique-extensions}). Moreover, we have
% similarly shown that, for circuits with unique labels, the action of a
% permutation, as well as the coarsest supporting partition and orbit of a gate
% (or element of the universe of a gate), can be computed in polynomial-time.
% Since all circuits with symmetric gates are transparent, this is direct
% generalisation of the results of Anderson an Dawar.

\subsection{The Necessity of Transparency}\label{sec:necessity}
% The reader will notice that while we have included a specific requirement that
% each non-symmetric internal gate in a circuit have unique labels (i.e. that
% the circuit be transparent) no similar condition In this section we discuss
% the transparency condition on circuits. It is worth noting that, since the
% symmetric circuits of Anderson and Dawar~\cite{AndersonD17} have no
% non-symmetric internal gates, these circuits are transparent.

% we provide evidence f (which from lemma~\ref{} may be assumed to have unique
% extensions)or necessity of the transparency condition, presenting reductions
% from the graph-isomorphism problem to the problem of deciding some of this
% important properties (e.g. symmetry, syntactic-equivalence, computing the
% orbit of a gate, etc.) over general, not necessarily transparent, circuits. we
% note that in all of these cases the decision problem restricted to transparent
% circuits is polynomial-time decidable.

% we further argue that, since most natural algorithms for transforming an
% arbitrary symmetric circuit into an equivalent transparent circuit make use of
% the polynomial-time decidability of these properties, we should consider these
% hardness results evidence that computing this transformation may be as hard as
% the graph-isomorphism problem.

% In this first part of this section we showed that a number of useful
% properties of circuits are polynomial-time decidable for transparent circuits.
% We used these results to define a polynomial-time translation from transparent
% circuits to equivalent circuits with unique labels. Finally, we showed that
% for a given circuit with unique labels we can compute in polynomial-time many
% important symmetry related properties of the circuit (e.g.\ the orbits and
% supports of elements of the circuits, whether a circuit is symmetric, etc.).

We have shown then that key properties of transparent circuits are
tractable and, using these results, we have shown that
transparent circuits can be transformed in polynomial time into circuits with
unique labels. We have also shown that circuits with unique labels have all of
the requisite algorithmic properties needed in order to define our translation
from circuits to formulas. In the remainder of this section we prove that most
of these properties, and particularly those used to define this translation to
circuits with unique labels, are all at least as hard to decide as the graph
isomorphism problem. In particular, we present reductions from the
graph-isomorphism problem to most of the important decision problems addressed
in the first part of this section, including: deciding if a circuit is
symmetric, deciding if a gate has unique labels, deciding if two gates are
syntactically-equivalent, deciding if two gates are in the same orbit, etc.
Moreover, we show that many of these hardness results still hold even if we
restrict ourselves to other natural classes of circuits (e.g.\ the class of
circuits with injective labels, the class of circuits with unique children).

These results together suggest the necessity of the restriction to transparent
circuits. Moreover, while we do not show that there is no polynomial-time
computable transformation from a general circuit to an equivalent transparent
circuit (or equivalent circuit with unique labels), the difficulty associated
with computing these basic circuit properties that seem essential for defining
such a transformation should be considered evidence that, at the very least, it
is not easy to define an algorithm computing such a translation.

% As a final point, while we present evidence against the ability to transform
% arbitrary circuits into transparent circuits in polynomial-time, we also show
% that the class of transparent circuits is polynomial-time decidable. In
% contrast, we show that deciding the class of circuits with unique extensions
% is at least as hard as the graph-isomorphism problem.


\begin{remark}
  In this section we present a number of polynomial-time reductions from the
  graph-isomorphism problem to various circuit-related problems. In each case we
  present a reduction from the bipartite-isomorphism problem to a
  circuit-related problem. This suffices as, from~\cite{Zemlyachenko1985}, there
  is a polynomial-time reduction from the graph-isomorphism problem to the
  bipartite-isomorphism problem. We recall that the bipartite-isomorphism
  problem is the problem of deciding if for a given pair of bipartite graphs
  $B_1 := (U_1, V_1, E_1)$ and $B_2 := (U_2, V_2, E_2)$ there exists a (graph)
  isomorphism $\pi : B_1 \rightarrow B_2$ such that $\restr{\pi}{U_1} = U_2$ and
  $\restr{\pi}{V_1} = V_2$. We usually assume, without a loss of generality,
  that the two input graphs have the property that $[a] = U_1 = U_2$ and $[b] =
  V_1 = V_2$ for some $a,b \in \nats$.
\end{remark}

We now present a reduction from the graph-isomorphism problem to the problem of
deciding if two gates in a circuit are syntactically-equivalent. In fact, we
prove a stronger result, presenting a reduction from the graph-isomorphism
problem to the problem of computing the syntactic-equivalence relation over a
more constrained class of circuits.

\begin{prop}
   There is a polynomial-time reduction from the graph isomorphism problem to the
  problem of determining if a given pair of gates in a given circuit are
  syntactically-equivalent.
  \label{prop:syntactic-graph-iso}
\end{prop}
\begin{proof}
 Let $\rho$ be any non-empty relational vocabulary and let $r, p \in \nats$,
  with $p$ prime.  We reduce the bipartite-isomorphism problem to the
  problem of deciding whether two given gates are syntactically
  equivalent in a symmetric rank-circuit taking $\rho$-structures as
  input where the circuit (i) has
  injective labels, (ii) contains no constant gates, and (iii) contains at most
  two rank gates with bound $r$ and prime $p$.

  Suppose we are given two partitioned bipartite graphs $B_1 := (U_1, V_1, E_1)$
  and $B_2 := (U_2, V_2, E_2)$. We assume, without a loss of generality, that
  there exists $a, b \in \nats$ such that $U_1 = U_2 = [a]$ and $V_1 = V_2 =
  [b]$.

  The idea is to construct a circuit with $n$ inputs, and with two designated
  gates used to encode the presence or absence of an edge, and two rank gates
  wired up so as to encode the two graphs. We wire the circuit such that, for a
  given rank gate $g_\rank$, the child of $g_\rank$ labelled by $(p,q)$ has
  exactly one of the two designated gates as a child, with the choice of which
  one depending on whether $(p,q)$ is an edge in the associated graph. In this
  sense the circuit encodes the two bipartite graphs at the rank gates, and the
  two rank gates are syntactically-equivalent if, and only if, the two graphs
  are bipartite-isomorphic. We now present this construction formally.

  Let $R$ be a relation symbol in $\rho$ and let $k := \arty(R) > 0$. Let $G_{R}
  := \{g_{R, \vec{c}} : \vec{c} \in [n]^k\}$, $G_{\text{mid}} := \{g_{\lor},
  g_{\land}, g_{\text{out}} \}$, $G_{\rank} : = \{ g^1_{\rank}, g^2_{\rank}\}$,
  and $G_{\text{nodes}} := \{g_{i, (u,v)} : i \in [2] ,\, (u,v) \in [a] \times
  [b] \}$. Let $C = \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a
  $(\{\RANK^{r}_p\} \cup \BS, \rho)$-circuit of order $n$ defined as follows.
  Let $G = G_R \cup G_{\text{mid}} \cup G_{\rank} \cup G_{\text{nodes}}$ and
  $\Omega$ be the $0$-ary function $g_{\text{out}}$. For each $\vec{c} \in
  [n]^{\arty(R)}$ let $\Lambda_R(\vec{c}) = g_{R, \vec{c}}$. Define $\Sigma$ as
  follows. For each $g \in G$,
  \begin{myitemize}
  \item if $g = g_{\text{out}}$ then $\Sigma(g) = \AND[2]$,
  \item if $g \in G_\rank$ then $\Sigma(g) = \RANK^r_p [a,b]$,
  \item if $g \in G_{\text{nodes}}$ then $\Sigma(g) = \AND[1]$,
  \item if $g = \AND[n^k]$, $\Sigma (g) = \AND[n^k]$ and if $g = g_{\lor}$ then
    $\Sigma(g) = \OR[n^k]$, and
  \item if $g \in G_R$ then $\Sigma(g) = R$.
  \end{myitemize}
  Define $L$ as follows. For each $g \in G$,
  \begin{myitemize}
    \setlength\itemsep{0mm}
  \item if $g = g_{\text{out}}$ then for each $i \in [2]$, $L(g)(i) :=
    g^i_{\rank}$,
  \item if $g \in G_\rank$ and $g = g^i_{\rank}$ then for all $(p,q) \in
    \ind(g)$, $L(g)(p,q) = g_{i, (p,q)}$,
  \item if $g \in G_{\text{nodes}}$ and $g = g_{i, (p,q)}$ then if $(p, q) \in
    E_i$ then $L(g)(1) = g_{\land}$, otherwise $L(g)(1) = g_\lor$, and
  \item if $g = g_\land$ or $g = g_\lor$ then for all $q \in [n^k]$ we have that
    $L(g)(q) =\Lambda^{-1}(\vec{c}_q)$, where $\vec{c}_q$ is the $q$th element
    of $[n]^k$ in the lexicographical ordering on $[n]^k$.
  \end{myitemize}

  We note that for $i \in [2]$, the child of $L(g^i_{\rank})(p,q)$ is $g_\land$
  if, and only if, $(p,q)$ is an edge in in $B_i$ and the child of
  $L(g^i_\rank)(p,q) $ is $g_\lor$ if, and only if, $(p,q)$ is not an edge in
  $B_i$. We thus have that $B_1$ and $B_2$ are bipartite-isomorphic if, and only
  if, there exists $\lambda \in \sym_{a} \times \sym_{b}$ such that for all
  $(u,v) \in [a] \times [b]$, $L(g^1_{\rank})((u,v)) = g_{1, (u,v)} \equiv g_{2,
    \lambda (u,v)} = L(g^2_{\rank})(\lambda (u,v))$. It follows that $B_1$ and
  $B_2$ are bipartite-isomorphic if, and only if, $g^1_{\rank} \equiv
  g^2_{\rank}$.

  Since the construction of $C$ can be implemented in time polynomial in the
  combined sizes of the input graphs, the mapping of $(B_1, B_2)$ to the tuple
  $(C, (g^1_{\rank}, g^2_{\rank}))$ is a reduction, and the result follows.
\end{proof}

Proposition~\ref{prop:syntactic-graph-iso} gives us that computing the
syntactic-equivalence relation for a given circuit remains hard even if we
restrict ourselves to circuits with injective labels. In fact, every gate but
the two rank gates (and, possibly, the output gate) have unique labels,
indicating that even if we restrict ourselves to circuits with injective labels
and such that each non-symmetric gates has the property that all of its input
gates have unique labels, the syntactic-equivalence relation remains hard to
compute.

We now show that the syntactic-equivalence relation remains hard to compute if
we restrict ourselves to the class of circuits such that each non-symmetric gate
has unique children.

\begin{lem}
  There is a polynomial-time reduction from the graph-isomorphism problem to the
  problem of deciding if two gates in a given circuit with the property that
  each non-symmetric gate has unique children are syntactically-equivalent.
  \label{lem:syntactic-equivalence-unique-gates-hard}
\end{lem}
\begin{proof}
  We use a similar approach as in the proof of
  Proposition~\ref{prop:syntactic-graph-iso}. The idea is to use the circuit
  constructed in Proposition~\ref{prop:syntactic-graph-iso} but with the row of
  gates between the two designated gates that encode the existence or absence of
  an edge and the two rank gates deleted and replaced with direct wires. We now
  present this reduction formally.
  
  Suppose we are given two partitioned bipartite graphs $B_1 := (U_1, V_1, E_1)$
  and $B_2 := (U_2, V_2, E_2)$. We assume, without a loss of generality, that
  there exists $a, b \in \nats$ such that $U_1 = U_2 = [a]$ and $V_1 = V_2 =
  [b]$.

  Let $C = \langle G, , \Omega, \Sigma, \Lambda, L \rangle$ be the circuit
  defined in the proof of Proposition~\ref{prop:syntactic-graph-iso}. Let $C' =
  \langle G', \Omega', \Sigma', \Lambda', L'\rangle$ be defined as follows. Let
  $G' = G \setminus G_{\text{nodes}}$, $\Omega' = \Omega$, $\Lambda' = \Lambda$,
  and $\Sigma' = \restr{\Sigma}{G'}$. For all $g \in G' \setminus G_{\rank}$ let
  $L'(g) = L(g)$. For $i \in [2]$ and $(p,q) \in [a] \times [b]$, let
  $L(g^i_{\rank})(p,q) = g_{\land}$ if $(p,q) \in E_i$ and $L(g^i_{\rank})(p,q)
  = g_{\lor}$ otherwise.

  We have defined $C'$ from $C$ by deleting the gates in $G_{\text{nodes}}$ and
  for each $g \in G_{\text{nodes}}$ adding a wire directly from the child of $g$
  in to the parent of $g$. Using an argument similar to that of
  Proposition~\ref{prop:syntactic-graph-iso} we have that $B_1$ and $B_2$ are
  bipartite-isomorphic if, and only if, $g^1_{\rank} \equiv g^2_{\rank}$. Since
  the construction of $C$, and so $C'$, can be implemented in time polynomial in
  the combined sizes of the input graphs, the mapping of $(B_1, B_2)$ to the
  tuple $(C', (g^1_{\rank}, g^2_{\rank}))$ is a reduction, and the result
  follows.
\end{proof}

We recall that a circuit $C$ is transparent if, and only if, every non-symmetric
gate in $C$ has injective labels and unique children. We have shown that
computing the syntactic-equivalence relation is at least as hard as the
graph-isomorphism problem if we restrict ourselves to either the class of
circuits in which non-symmetric gates have injective labels
(Proposition~\ref{prop:syntactic-graph-iso}) or the class of circuits in which
each non-symmetric gate has unique children
(Lemma~\ref{lem:syntactic-equivalence-unique-gates-hard}). It would seem then
that, while the conjunction of these two properties is sufficient, each of these
properties is insufficient alone.

We now present a reduction from the problem of computing the
syntactic-equivalence relation to the problem of deciding if a given gate in a
circuit has unique labels. From the transitivity of polynomial-time many-one
reductions and Proposition~\ref{prop:syntactic-graph-iso}, this gives us a
reduction from the graph-isomorphism problem to the problem of deciding if a
gate has unique labels.

\begin{lem}
  There are a polynomial-time reduction from the problem of determining if a
  given pair of gates in a given circuit are syntactically equivalent to the
  problems of determining if a given gate in a given circuit has unique labels.
  \label{lem:syntactically-equivalent-unique-labels}
\end{lem}

\begin{proof}
  Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a circuit of order
  $n$ and let $g_1, g_2 \in G$. Let $D$ be the circuit formed from $C$ by
  removing every gate $g \in G \setminus\{g_1, g_2\}$ such that $\neg W_t(g,
  g_1) \land \neg W_t(g, g_2)$, where $W_t$ is the transitive closure of the $W$
  relation (i.e. we remove all those gates in the circuit such that there is no
  path from the gate to either $g_1$ or $g_2$). Let $C'$ be the circuit formed
  from $D$ by adding in a single two-input $\AND$-gate $g'$ and connecting the
  outputs of $g_1$ and $g_2$ to the inputs of $g'$. Moreover, we let this $g'$
  be the single output gate of $C'$.

  It follows that $g_1$ and $g_2$ are syntactically-equivalent in $C$ if, and
  only if, $g'$ has unique labels in $C'$. Since the construction of $C'$ from
  $C$ can be completed in polynomial time, the mapping of $(C, (g_1, g_2))$ to
  $(C', g')$ is a reduction.
\end{proof}

We can construct a similar argument for reducing the problem of deciding if two
gates are syntactically-equivalent in a circuit with injective labels to the
problem of deciding if a given gate $g$ in a circuit $C$ with injective labels
does not have \emph{unique extensions}. We say a gate $g$ has unique extensions
if there is no permutation such that two automorphisms of the circuit extend the
permutation and disagree with each other on $g$ (i.e.\ $g$ is not a
counterexample to $C$ having unique extensions). From the transitivity of
polynomial-time many-one reductions and
Proposition~\ref{prop:syntactic-graph-iso}, this gives us a reduction from the
graph-isomorphism problem to the problem of deciding if a gate has unique
extensions.

\begin{lem}
  There is a polynomial-time reduction from the problem of determining if a
  given pair of gates gates in a given $(\mathbb{B}, \rho)$-circuit with
  injective labels are syntactically-equivalent to the problem of determining if
  for a given pair $(C, g)$, where $C$ is a circuit of order $n$ with injective
  labels, $g$ is a gate in $C$, that there exists $\sigma \in \sym_n$ and
  automorphisms $\pi, \pi' \in \aut(C)$ extending $\sigma$ such that $\pi (g)
  \neq \pi' (g)$.
  \label{lem:syntactically-equivilent-unique-extensions}
\end{lem}
\begin{proof}
  Let $C$ be a circuit of order $n$ and let $g_1$ and $g_2$ be two gates in $C$.
  Note that for any gate $g$ in $\sigma \in \sym_n$, if $\pi, \pi' \in \aut(C)$
  both extend $\sigma$ and $\pi_e := \pi'\pi^{-1}$ then $\pi(g) \neq \pi'(g)$
  if, and only if, $\pi_e (g) \neq g$. We thus have that there exists $\sigma
  \in \sym_n$ and $\pi, \pi' \in \aut(C)$ extending $\sigma$ such that $\pi (g)
  \neq \pi'(g)$ if, and only if, there exists $\pi_e \in \aut(C)$ extending the
  trivial permutation such that $\pi (g) \neq g$.

  Let $C'$ be the circuit constructed from $C$ as in the proof of
  Lemma~\ref{lem:syntactically-equivalent-unique-labels}. We now prove that the
  mapping $(C, g_1, g_2)$ to $(C', g_1)$ is a reduction. Let $\pi_e$
  be a
  bijection from the gates of $C'$ to the gates of $C'$ that swaps $g_1$ and
  $g_2$ and fixes all other gates. It follows that if $g_1$ and $g_2$ are
  syntactically-equivalent in $C$, then they are syntactically-equivalent in
  $C'$, and so $\pi_e$ is a non-trivial automorphism extending the trivial
  permutation, and thus $g_1$ does not have unique extensions in $C'$. We now
  prove the other direction. Suppose $g_1$ does not have unique extensions in
  $C'$. Then there exists an automorphism $\pi_e \in \aut(C')$ extending the
  trivial permutation and such that $\pi_e(g_1) \neq g_1$. But $g_1$ is a child
  of the single output gate $g'$ (which must be fixed by any automorphism), and
  the only other child of $g'$ is $g_2$. It follows $\pi_e$ swaps $g_1$ and
  $g_2$, and so $g_1$ and $g_2$ are syntactically-equivalent in $C'$. The result
  follows.
\end{proof}

We now show that there is a reduction from the graph-isomorphism problem to the
problem of deciding if a given circuit is symmetric. In fact, we prove a
stronger result, showing that this reduction holds even if we restrict ourselves
to the class of reduced circuits in which all but two gates in the circuit have
injective labels. We might think of this as the class of circuits that
\emph{almost} have unique labels -- in that all but two gates have unique labels
and the remaining two have unique children.

\begin{prop}
  The graph-isomorphism problem is polynomial-time reducible to the problem of
  deciding if a circuit is symmetric. 
  \label{prop:graph-iso-symmetric}
\end{prop}
\begin{proof}
In fact, we reduce the graph-isomorphism problem is to the problem of
deciding symmetry of a reduced circuit in
  which all but two gates have unique labels.

  We use an approach similar to that in the proof of
  Proposition~\ref{prop:syntactic-graph-iso}. In this case we construct a
  circuit with two inputs, and each input is connected to an approximate copy of
  the circuit defined in the proof of
  Lemma~\ref{lem:syntactic-equivalence-unique-gates-hard}. We now define this
  reduction formally.
 
  Suppose we are given two partitioned bipartite graphs $B_1 := (U_1, V_1, E_1)$
  and $B_2 := (U_2, V_2, E_2)$. We assume, without a loss of generality, that
  there exists $a, b \in \nats$ such that $U_1 = U_2 = [a]$ and $V_1 = V_2 =
  [b]$.

  Let $\rho:= \{R\}$ be a relational vocabulary, where $R$ is a unary relational
  symbol. Fix any number $r$ and prime $p$. We define a $(\RB, \rho)$-circuit $C
  := \langle G, \Omega, \Sigma, \Lambda, L \rangle$ of order two as follows. Let
  $G_{R} := \{g^1_{R}, g^2_{R}\}$ and $G_{\text{mid}} := \{g^1_{\land},
  g^2_\land, g^1_\lor, g^2_\lor , g_{\text{out}}\}$, and $G_{\rank} : = \{
  g^1_{\rank}, g^2_{\rank}\}$. Let $G = G_R \cup G_{\text{mid}} \cup G_{\rank}$
  and $\Omega$ be the $0$-ary function $g_{\text{out}}$. Let $\Lambda(1) :=
  g^1_{R}$ and $\Lambda(2) := g^2_{R}$. Define $\Sigma$ as follows. For each $g
  \in G$,
  \begin{myitemize}
  \item if $g$ equals $\land_{\text{out}}$ then $\Sigma(g) = \AND[2]$,
  \item if $g \in G_\rank$ let $\Sigma(g) = \RANK^r_p [a,b]$,
  \item if $g \in G_{\text{mid}}$ and $g = g^i_s$ for $ \in [2]$ and symbol $s$
    then $\Sigma(g) = s[1]$, and
  \item if $g \in G_R$ then $\Sigma(g) = R$.
  \end{myitemize}
  Define $L$ as follows. For each $g \in G$,
  \begin{myitemize}
  \item if $g = g_{\text{out}}$ then for each $i \in [2]$, $L(g)(i) :=
    g^i_{\rank}$,
  \item if $g \in G_\rank$ and $g = g^i_{\rank}$ for some $i \in [2]$ then for
    $(p,q) \in [a]\times [b]$, $L(g)(p,q) = g^i_\land$ if $(p,q) \in E_i$ and
    $L(g)(p,q) = g^i_\lor$ otherwise, and
  \item if $g = g^i_\land$ or $g = g^i_{\lor}$ for some $i \in [2]$, then
    $L(g)(1) = \Lambda^{-1}(i)$.
  \end{myitemize}

  We note that for $i \in [2]$, $L(g^i_{\rank})(p,q)= g^i_\land$ if, and only
  if, $(p,q)$ is an edge in $B_i$ and $L(g^i_{\rank})(p,q) g^i_\lor$ if, and
  only if, $(p,q)$ is not an edge in $B_i$. Let $\pi_{(1,2)} : G \rightarrow G$
  be the function that fixes the output gate, and for each symbol $s$ swaps the
  gate $g^1_s$ with the gate $g^2_s$. It is easy to see that $\pi_{(1,2)}$ is a
  bijection. Moreover, $C$ is symmetric if, and only if, $\pi_{(1,2)}$ is an
  automorphism of the circuit extending the transposition $(1,2)$, if and only
  if, $(1,2) (L(g^1_{\rank}))$ is isomorphism-equivalent to $L(g^2_{\rank})$ if,
  and only if, $B_1$ and $B_2$ are bipartite-isomorphic.
 
  It is easy to see that all gates in the circuit are part of a singleton
  syntactic-equivalence class and that all of the gates in the circuit but the
  two rank gates have have unique labels. Since the construction of $C$ can be
  implemented in time polynomial in the combined sizes of the input graphs, the
  mapping of $(B_1, B_2)$ to $C$ is a reduction, and the result follows.
\end{proof}

We note that Proposition~\ref{prop:graph-iso-symmetric} gives us that deciding
if a circuit is symmetric, even if we restrict ourselves to reduced circuits or
circuits with unique children, is as hard as the graph-isomorphism problem.
Moreover, it is possible to alter this reduction, using a construction analogous
to the one used in the proof of Proposition~\ref{prop:syntactic-graph-iso}, in
order to reproduce this hardness result with an additional restriction to
circuits with injective labels.  In contrast, we have from
Lemma~\ref{lem:computing-support-orbit-index} that we can decide if a
transparent circuit is symmetric in polynomial-time. These observations again
suggest both the robustness of this hardness result and the importance of the
transparency condition.

In Lemma~\ref{lem:compute-automorphisms} we showed that for circuits with unique
labels, we can compute in polynomial-time the action of an automorphism on the
gates of a circuit. In Proposition~\ref{lem:computing-support-orbit-gate} we
show that we can also compute the orbit and supports of gates in
polynomial-time. These results play a very central role in our translation from
families of circuits to formulas, and hence in the proof of our main result. We
now show that deciding the orbit of a gate in a general circuit is at least as
hard as the graph isomorphism problem. We show that this result holds even if we
restrict our attention to circuits with unique extensions or circuits with
injective labels.

\begin{lem}
  There is a polynomial-time reductions from the graph-isomorphism problem to the
  problem of deciding if two given gates in a given circuit are in the same
  orbit.
  \label{lem:graph-iso-to-orbit}
\end{lem}
\begin{proof}
 In fact, we construct the reduction to circuits
  with unique extensions, circuits with unique children, or to circuits with
  injective labels.

  Let $B_1$ and $B_2$ be bipartite graphs. Let $C$ be the circuit constructed in
  Lemma~\ref{lem:syntactic-equivalence-unique-gates-hard}. The mapping of $(B_1,
  B_2)$ to $(C, g^1_{\rank}, g^2_{\rank})$ is a reduction from the graph
  isomorphism problem to the problem of deciding if two gates in a circuit with
  unique children (and so unique extensions) are in the same orbit. A similar
  reduction using the circuit constructed in
  Proposition~\ref{prop:syntactic-graph-iso} gives a reduction to the problem of
  deciding if two gates in a given circuit with injective labels are in the same
  orbit.
\end{proof}

We have from Propositions~\ref{prop:syntactic-graph-iso},
and~\ref{prop:graph-iso-symmetric}, and
Lemmas~\ref{lem:syntactically-equivalent-unique-labels},~\ref{lem:syntactic-equivalence-unique-gates-hard},~\ref{lem:graph-iso-to-orbit},
and~\ref{lem:syntactically-equivilent-unique-extensions}, that a number of basic
circuit properties are at least as hard for general circuits -- and circuits
with unique extensions, rigid circuits, and circuits with injective labels -- as
the graph-isomorphism problem.  In contrast, as proved in the first part of this
section, all of these properties are known to be polynomial-time decidable for
transparent circuits.

The hardness results for computing syntactic-equivalence and deciding if a gate
has unique labels are particularly worth noting, as many natural algorithms for
translating a circuit into an equivalent transparent circuit (or circuit with
unique labels) make use of the polynomial-time decidability of these properties.
Indeed, the translation defined by Anderson and Dawar~\cite{AndersonD17} from
circuits with symmetric gates to equivalent circuits with unique labels, and the
translation we define in Lemma~\ref{lem:transparent-unique} for transparent
circuits, make explicit use of the polynomial-time computability of the
syntactic-equivalence relation for circuits from this class. As such, these
hardness results, along with the hardness results for many other basic circuit
properties, should be considered evidence against the existence of an
easily-definable polynomial-time translation from general circuits to
transparent circuits, or to circuits with unique labels.

% While we have provided evidence against the ability to efficiently transform a
% circuit into an equivalent transparent circuit, we now show that, in contrast,
% there is a polynomial-time algorithm for checking if a circuit is transparent.
% This has a certain significance, as we now have transparency is not some
% unverifiable condition on circuits, further motivating the usefulness of this
% definition.


% GW: This final result may be unnecessary.


From Proposition~\ref{prop:transparent-polynomial-time} and
Corollary~\ref{cor:unique-labels-polynomial-time} we have that both the class of
transparent circuits and the class of circuits with unique labels are
polynomial-time decidable. These results suggest that, while it may be hard to
transform a circuit into an equivalent transparent circuit or a circuit with
unique labels, verifying that a circuit has these properties is at least
tractable. We now show that many other seemingly natural classes of circuits are
at least as hard to decide as the graph-isomorphism problem.

\begin{lem}
  There are polynomial-time reductions from the graph isomorphism problem to
  the problem of deciding if a circuit does not have unique extensions and the
  problem of deciding if a circuit does not have unique children.
  \label{lem:unique-extensions-hard}
\end{lem}
\begin{proof}
  In both cases the circuit constructed in the proof of
  Lemma~\ref{lem:syntactic-equivalence-unique-gates-hard} suffices for the
  reduction.
\end{proof}

% \begin{proof}
%   We use a similar approach as in Proposition~\ref{prop:syntactic-graph-iso},
%   again arguing using a reduction from the graph-isomorphism problem to
%   bipartite-graph isomorphism problem. Suppose we are given two partitioned
%   bipartite graphs $B_1 := (U_1, V_1, E_1)$ and $B_2 := (U_2, V_2, E_2)$. We
%   assume, without a loss of generality, that there exists $a, b \in \nats$
%   such that $U_1 = U_2 = [a]$ and $V_1 = V_2 = [b]$.

%   Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a $(\RB,
%   \{R\})$-circuit of order one defined as follows. Let $G_R := \{g_R\}$, $G_1
%   := \{ g_{\lor}, g_{\land} \}$, $G_{\rank} := \{ g^1_{\rank}, g^2_{\rank}
%   \}$, and $G = G_R \cup G_1 \cup G_1 \cup G_{\rank} \cup \{ g_{\text{out}}
%   \}$. Let $\Omega = g_{\text{out}}$ and $\Lambda_R (g_R) = 1$. Let $\Sigma
%   (g_R) = R$, $\Sigma (g_\lor) = \OR[1]$, $\Sigma (g_\land) = \AND[1]$,
%   $\Sigma (g_{\text{out}}) = \AND[2]$ and for all $g \in G_{\rank}$, $\Sigma
%   (g) = \RANK[a,b]$. Let $L(g_\lor)(1) = L(g_\land)(1) = g_R$, for all $i \in
%   [2]$, $L(g_{\text{out}})(i) = g^i_{\rank}$ and for all $(u, v) \in \ind(g)$,
%   $L(g^i_{\rank})(u,v) = g_{\land}$ if $(u, v) \in E_i$ and $L(g^i_{\rank}
%   (u,v) = g_{\lor}$ otherwise.

%   Suppose $B_1$ and $B_2$ are bipartite-isomorphic. Then there exists $\lambda
%   \in [a] \times [b]$ such that $(u,v) \in E_1$ if, and only if, $\lambda
%   (u,v) \in E_2$. It follows that $L(g^1_{\rank})((u,v)) =
%   L(g^2_{\rank})(\lambda(u,v))$. Let $\pi_{\lambda}: G \rightarrow G$ be
%   defined such that if $g = g^i_{\rank}$ for $i \in [2]$, $\pi_{\lambda} g =
%   g^j_{\rank}$ where $j \in [2] \setminus \{i\}$ and otherwise $\pi_{\lambda}
%   g = g$. It is easy to see that $\pi_{\lambda}$ is a bijection. Moveover, for
%   $(u,v) \in \sym_a \times \sym_b$ $\pi_{\lambda} L(g^1_{\rank})((u,v)) =
%   L(g^2_{\rank})(\lambda (u,v)) = L(\pi_\lambda g^1_{\rank})(\lambda (u,v))$.
%   Similarly, $\pi_\lambda L(g^2_{\rank})((u,v)) =
%   L(\pi_{\lambda}g^2_{\rank})(\lambda^{-1}(u,v))$. It follows that
%   $\pi_\lambda$ is a non-trivial automorphism of $C$ extending the trivial
%   permutation, and so $C$ does not have unique extensions.

%   Suppose $C$ does not have unique extensions. Then there exists an
%   automorphism $\pi$ of the circuit extending the trivial permutation such
%   that $\pi g^1_{\rank} = g^2_{\rank}$. But then there exists $\lambda \in
%   \sym_a \times \sym_b$ such that for all $(u,v) \in [a]\times [b]$, $\pi
%   L(g^1_{\rank})((u,v)) = L(g^1_{\rank})((u,v)) = L(g^2_{\rank})(\lambda
%   (u,v))$. But then $(u,v) \in E_1$ if, and only if, $L(g^1_{\rank})((u,v)) =
%   g_{\land}$, if and only if, $L(g^2_{\rank})(\lambda(u,v)) = g_{\land}$ if,
%   and only if, $\lambda (u,v) \in E_2$. It follows $B_1$ and $B_2$ are
%   bipartite-isomorphic.
% \end{proof}
% \begin{proof}
%   We use a similar approach as in Proposition~\ref{prop:syntactic-graph-iso},
%   again arguing using a reduction from the graph-isomorphism problem to
%   bipartite-graph isomorphism problem. Suppose we are given two partitioned
%   bipartite graphs $B_1 := (U_1, V_1, E_1)$ and $B_2 := (U_2, V_2, E_2)$. We
%   assume, without a loss of generality, that there exists $a, b \in \nats$
%   such that $U_1 = U_2 = [a]$ and $V_1 = V_2 = [b]$.

%   Let $C := \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a $(\RB,
%   \{R\})$-circuit of order one defined as follows. Let $G_R := \{g_R\}$, $G_1
%   := \{ g_{\lor}, g_{\land} \}$, $G_{\rank} := \{ g^1_{\rank}, g^2_{\rank}
%   \}$, and $G = G_R \cup G_1 \cup G_1 \cup G_{\rank} \cup \{ g_{\text{out}}
%   \}$. Let $\Omega = g_{\text{out}}$ and $\Lambda_R (g_R) = 1$. Let $\Sigma
%   (g_R) = R$, $\Sigma (g_\lor) = \OR[1]$, $\Sigma (g_\land) = \AND[1]$,
%   $\Sigma (g_{\text{out}}) = \AND[2]$ and for all $g \in G_{\rank}$, $\Sigma
%   (g) = \RANK[a,b]$. Let $L(g_\lor)(1) = L(g_\land)(1) = g_R$, for all $i \in
%   [2]$, $L(g_{\text{out}})(i) = g^i_{\rank}$ and for all $(u, v) \in \ind(g)$,
%   $L(g^i_{\rank})(u,v) = g_{\land}$ if $(u, v) \in E_i$ and $L(g^i_{\rank}
%   (u,v) = g_{\lor}$ otherwise.

%   Suppose $B_1$ and $B_2$ are bipartite-isomorphic. Then there exists $\lambda
%   \in [a] \times [b]$ such that $(u,v) \in E_1$ if, and only if, $\lambda
%   (u,v) \in E_2$. It follows that $L(g^1_{\rank})((u,v)) =
%   L(g^2_{\rank})(\lambda(u,v))$. Let $\pi_{\lambda}: G \rightarrow G$ be
%   defined such that if $g = g^i_{\rank}$ for $i \in [2]$, $\pi_{\lambda} g =
%   g^j_{\rank}$ where $j \in [2] \setminus \{i\}$ and otherwise $\pi_{\lambda}
%   g = g$. It is easy to see that $\pi_{\lambda}$ is a bijection. Moveover, for
%   $(u,v) \in \sym_a \times \sym_b$ $\pi_{\lambda} L(g^1_{\rank})((u,v)) =
%   L(g^2_{\rank})(\lambda (u,v)) = L(\pi_\lambda g^1_{\rank})(\lambda (u,v))$.
%   Similarly, $\pi_\lambda L(g^2_{\rank})((u,v)) =
%   L(\pi_{\lambda}g^2_{\rank})(\lambda^{-1}(u,v))$. It follows that
%   $\pi_\lambda$ is a non-trivial automorphism of $C$ extending the trivial
%   permutation, and so $C$ does not have unique extensions.

%   Suppose $C$ does not have unique extensions. Then there exists an
%   automorphism $\pi$ of the circuit extending the trivial permutation such
%   that $\pi g^1_{\rank} = g^2_{\rank}$. But then there exists $\lambda \in
%   \sym_a \times \sym_b$ such that for all $(u,v) \in [a]\times [b]$, $\pi
%   L(g^1_{\rank})((u,v)) = L(g^1_{\rank})((u,v)) = L(g^2_{\rank})(\lambda
%   (u,v))$. But then $(u,v) \in E_1$ if, and only if, $L(g^1_{\rank})((u,v)) =
%   g_{\land}$, if and only if, $L(g^2_{\rank})(\lambda(u,v)) = g_{\land}$ if,
%   and only if, $\lambda (u,v) \in E_2$. It follows $B_1$ and $B_2$ are
%   bipartite-isomorphic.
% \end{proof}

% \begin{remark}
%   It's interesting to note that the circuit used in the reduction does not
%   have injective labels. If we instead ask about a reduction from GI to the
%   problem of deciding if a circuit has unique extensions and injective labels,
%   then I can reduce from to the problem of deciding if two rigid graphs are
%   isomorphic. It is unknown if this decision problem is as hard as the full
%   graph isomorphism problem. After looking around a bit I discovered that it's
%   a very important open problem in quantum computation. Is this worth
%   mentioning?
% \end{remark}


% \begin{proof}
%   We use a similar argument as for Proposition~\ref{prop:syntactic-graph-iso}.
%   We again argue using a reduction from the bipartite isomorphism problem. Let
%   $B_1 := (U_1, V_1, E_1)$ and $B_2 := (U_2, V_2, E_2)$, and let $C = \langle
%   G, \Omega, \Sigma, \Lambda, L\rangle$ be the associated circuit defined in
%   the proof of Proposition~\ref{prop:syntactic-graph-iso}. We recall that we
%   may assume, without a loss of generality, that there exists $a, b \in \nats$
%   such that $[a] = U_1 = U_2$ and $[b] = V_1 = V_2$ and $B_1$ and $B_2$ are
%   not identical. Recall that $B_1$ and $B_2$ are bipartite-isomorphic if, and
%   only if, there exists $\lambda \in \sym_{a} \times \sym_{b} = \aut(g_{\rank,
%   1}) = \aut(g_{\rank, 2})$ such that for all $(u,v) \in [a] \times [b] =
%   \ind(g_{\rank, 1})$, $L(g_{\rank_,1})((u,v)) = g_{1, (u,v)} \equiv g_{2,
%   \lambda (u,v)} = L(g_{\rank, 2})(\lambda (u,v))$.

%   Suppose $B_1$ and $B_2$ are bipartite-isomorphic. Then there exists $\lambda
%   \in \sym_{a} \times \sym_b$ be such that for all $(u,v) \in [a] \times [b]$,
%   $L(g_{\rank_,1})((u,v)) \equiv L(g_{\rank, 2})(\lambda (u,v))$. Let
%   $\pi_\lambda : G \rightarrow G$ be defined as follows. Let $g \in G$. If $g
%   \not\in G_{\rank} \cup G_{nodes}$ let $\pi_\lambda g = g$. If $g \in
%   G_{nodes}$ then $g = g_{i, (u,v)}$ for some $i \in [2]$ and $(u,v) \in [a]
%   \times [b]$, and let $\pi_{\lambda} g = g_{j, \lambda (u,v)}$, where $\{i,
%   j\} = [2]$. If $g \in G_{\rank}$ then $g = g_{\rank, i}$ for some $i \in
%   [2]$, and let $\pi_\lambda g = g_{\rank, j}$, where $\{i, j\} = [2]$. It is
%   easy to see that $\pi_\lambda$ is a bijection and $\pi_\lambda$ fixes the
%   input gates. Moreover, for $i, j \in [2]$ distinct, $(u,v) \in
%   \ind(g_{\rank, i})$, $\pi_\lambda L(g_{\rank, i}))((u,v)) = \pi_\lambda
%   g_{i, (u,v)} = g_{j, \lambda (u,v)} = L( \pi_\lambda g_{\rank, i})(\lambda
%   (u,v))$. It follows that $\pi_\lambda$ is an automorphism of $C$ extending
%   the trivial permutation. Moreover, if $\lambda$ is not the identity
%   automorphism then $\pi_\lambda$ is not the identity automorphism, and so $C$
%   does not have unique extensions.

%   It $C$ does not have unique extensions then there is no permutation that
%   maps $g_{\rank, 1}$ to $g_{\rank, 2}$. In other words there exists


%   there exists $\lambda \in \sym_{a} \times \sym_{b} = \aut(g_{\rank, 1})$
%   such that for all $(u,v) \in \ind(g_{\rank, 1})$, $g_{1,
%   (u,v)}L(g_{\rank_,1})(x) = L(g_{\rank, 2})(\lambda x) = g_{2, \lambda
%   (u,v)}$.

%   if, and only if, $g_{\rank, 1}$ and $g_{\rank, 2}$ are
%   syntactically-equivalent. If $g_{\rank,1}$ and $g_{\rank, 2}$ are
%   syntactically-equivalent then there exists $\lambda \in \aut(g_{\rank,1})$
%   such that $L(g_{\rank, 1})(\lambda x) \equiv L(g_{\rank, 2})(x)$. We can
%   define an automorphism $\pi : G \rightarrow G$ such that for $g \in G$, $\pi
%   (g) = g$ if $g$ is an input gate, $\pi g_{\rank, 1} = g_{\rank, 2}$ and $\pi
%   g_{\rank, 2} = g_{\rank, 1}$ and


%   Since Both $g_{\rank, 1}$ and $g_{\rank, 2}$ have unique labels.

%   Let $C'$ be a quotient of $C$.

%   which holds if, and only if, there exists $\pi \in \aut(C')$ extending the
%   trivial permutation such that $\pi (g_{\rank, 1}) = g_{\rank, 2}$, which is
%   true if, and only if, $C'$ does not have unique extensions. it follows that
%   the mapping of $(B_1, B_2)$ to $C'$ defines a reduction.
% \end{proof}
% We have that if a circuit is transparent then we may compute in polynomial
% time the syntactic equivalence relation on the gates of that circuit, and
% hence compute an equivalent circuit that has unique extensions. However, we've
% shown that absent the transparency condition, computing the the syntactic
% equivalence relation is at least as hard as the graph isomorphism problem.

% Moreover, other properties that can be computed in polynomial time for
% transparent circuits, e.g. deciding if particular gates have unique labels or
% might act as counterexamples to the unique extensions, have also been shown to
% be at least as the graph isomorphism problem.

% While we have not shown that there is no polynomial time algorithm that
% translates an arbitrary circuit into an equivalent transparent circuit, we
% have provided evidence in favour of the conjecture that such an algorithm
% might not exist.

% \begin{remark}
%   I really don't like the slightly vague language here. I would prefer to say
%   this differently. How does one provide `evidence' that a functional problem
%   is hard, when one has proved results about a few related decision problems?
% \end{remark}

% However, we must then address another question: If we must include an explicit
% requirement on circuits, why not simply require that the circuit have unique
% extensions? But we have from Lemma \ref{lem:unique-extensions-hard} that at
% the least verifying that a circuit have unique extensions is at least as hard
% as the graph isomorphism problem. We show that, in contrast, deciding if a
% circuit is transparent is in $\PT$.

% \begin{prop}
%   There is an algorithm that takes as input a circuit, decides if that circuit
%   is transitive and runs in time polynomial in the size of the circuit.
%   \label{prop:tansitive-polynomial-time}
% \end{prop}
% \begin{proof}
%   Let $C = \langle G, \Omega, \Sigma, \Lambda, L \rangle$ be a $(\mathbb{B},
%   \tau)$-circuit. We first check that, for each non-symmetric gate $g \in G$,
%   $L(g)$ is an injection. If not, we return that $C$ is not transitive.

%   The height of a gate $g$ in the circuit is the distance from $g$ to the set
%   of input gates. For each $p \in nats$ let $G^p \subseteq G$ be the set of
%   all gates of height $p$ and let $G^{\leq p} = \bigcup_{0 \leq i \leq p}G^i$.
%   Note that each $g \in G^1$, $g$ has unique labels. Thus, from Lemma \ref{},
%   we can compute the syntactic equivalence relation between gates in $G^{\leq
%   1}$ efficiently. We construct a loop as follows. Let $p$ be initialised to
%   $1$. We have that every non-symmetric gate $g \in G^{\leq p}$ has unique
%   gates. We compute the syntactic equivalence relation on $G^{\leq p}$ and
%   check if each non-symmetric gate in $g \in G^{i + 1}$ has unique labels. If
%   not, halt and output that the circuit is not transitive. If $p = \depth(C)
%   -1$ then halt and output that the circuit is transitive. If neither halt
%   state is reached, then increment $p$ by one and continue to the next
%   iteration of the loop.

%   We note that in every iteration of the loop we have that every non-symmetric
%   gate in $G^{\leq p}$ has unique labels. Thus, from Proposition
%   \ref{prop:unique-labels-syntactic-equiv}, we may compute the syntactic
%   equivalence relation on this set of gates efficiently. Thus it is easy to
%   see that the above algorithm can be implemented so as to run in polynomial
%   time.
% \end{proof}

% A similar result for circuits with unique labels.

% \begin{cor}
%   There is an algorithm that takes in a circuit and decides if that circuit
%   has unique labels and runs in time polynomial in the size of the circuit.
% \end{cor}
% \begin{proof}
%   Let $C$ be the input circuit. From Proposition
%   \ref{prop:transitive-polynomial-time} we may check if $C$ is transitive in
%   polynomial time. If $C$ is not transitive halt and output that $C$ does not
%   have unique labels. If $C$ is transitive then from Lemma \ref{} we may
%   compute the syntactic equivalence relation on the gates of $C$ efficiently.
%   This then allows us to check if each gate in $C$ has unique labels.
% \end{proof}

% We thus have that we can verify in polynomial time that a family of circuits
% indeed is transparent or has unique labels. The same cannot be said for the
% unique extensions property.


% \begin{lem}
%   There is an algorithm that takes in a symmetric circuit $C$ of order $n$
%   with unique labels, a gate $g$ in $C$ and $a \in \universe{g}$, the orbit
%   $\orb_g (a)$ and coarsest supporting partition $\SP_g (a)$.
% \end{lem}
% \begin{proof}
%   Let $(u,v) \in \sym_n$ be a transposition. We can check if $(u,v) \in
%   \stab(g)$ using Lemma~\ref{lem:compute-automorphisms}. Then $(u,v)$ acts
%   like an isomorphism at $g$, and hence $(u,v) \cdot a = L(g)^{-1}((\sigma
%   L(g)(\vec{x}))) (i)$, where $\vec{x} \in \ind(g)$ such that $\vec{x} (i) =
%   a$ for some $i \in [\vert \vec{x} \vert]$. Thus, since
%   Lemma~\ref{lem:compute-automorphisms} gives us that that we can compute
%   $\sigma L(g)(\vec{x})$ in polynomial time, we can compute $(u,v) \cdot a$ in
%   polynomial-time.

%   We note that
  
%   and hence we can compute $\sigma \cdot a$ effeciently. and hence compute
%   $\orb_g(a) = \{ \sigma \cdot a : \sigma \in \stab(g)\}$.

% \end{proof}

% Once again we note that computing the orbit of a gate for a general circuit is
% as hard as the graph isomorphism problem. We make use of the ability to
% compute the orbit of a gate in polynomial time in sub-section
% \ref{sec:translating-formulas-to-FPR} when translating families of circuits
% into equivalent formulas. As such the approach in this paper would fail for
% the general circuit.

% \begin{prop}
%   There is a polynomial-time reduction from the graph isomorphism problem to
%   the problem of computing if two gates in a given circuit are in the same
%   orbit.
%   \label{prop:graph-iso-to-orbit}
% \end{prop}
% \begin{proof}
%   Let $C$ be a circuit. Let $g_1$ and $g_2$ be two gates in $C$ such that
%   $H_{g_1} = H_{g_2}$. Then there exists $\pi \in \aut(C)$ such that $\pi
%   (g_1) = g_2$ if, and only if, $g_1$ is syntactically equivalent to $g_2$. As
%   such, we may use the same construction as in
%   Proposition~\ref{prop:syntactic-graph-iso} to prove this result.
% \end{proof}



% \begin{lem}
%   There is a polynomial-time Turing reduction from the problem of determining
%   if a given pair of gates in a given circuit are syntactically equivalent to
%   the problem of deciding if a circuit is transparent.
%   %   If the problem of deciding if a given circuit is transparent can be
%   %   decided
%   %   in
%   %   polynomial time then the graph isomorphism problem is in polynomial
%   %   time.
% \end{lem}
% \begin{proof}
%   Suppose there is an algorithm that takes as input, runs in time polynomial
%   in the size of the circuit, and decides whether or not the circuit is
%   transparent.

%   From Corollary \ref{} it is sufficient to show that there is a
%   polynomial-time algorithm for the problem of deciding if a pair of gates in
%   a given circuit are syntactically equivalent. Let $C_n$ be a circuit and
%   $g_1$ and $g_2$ be two gates in the circuit.

  
%   %   We simply need a polynomial-time reduction from the problem of computing
%   %   t
%   %   to the problem
%   %   of checking if a given circuit is transparent. Let $C_n =\langle G,
%   %   \Omega,
%   %   \Sigma, \Lambda, L\rangle$ be a circuit and let $g_1$ and $g_2$ be two
%   %   gates
%   %   in $G$. We now construct a circuit $C_n'$. If $g_1 = g_2$ then let
%   %   $C_n'$ be
%   %   any transparent circuit. If $g_1$ and $g_2$ do not satisfy any of
%   %   conditions
%   %   (i), (ii), (iii) or (v) of syntactic equivalence then let $C_n'$ be any
%   %   non-transparent circuit. So suppose all these conditions are met and
%   %   $g_1
%   %   \neq
%   %   g_2$, then let $D_n$ be the sub-circuit of $C_n$ consisting of exactly
%   %   those
%   %   gates $g$ in $C_n$ such that $W_t(g, g_1)$ or $W_t(g, g_2)$. Then let
%   %   $C_n'$
%   %   be $D_n'$ with an additional gate $g_\rank$, such that $g_\rank $ is
%   %   labelled
%   %   by the function $\rank^1_2[2,1]$ and $g_\rank$
% \end{proof}

% \begin{corollary}
% \end{corollary}

% We have from this proposition that even many nice properties Since there is a
% polynomial-time reduction from this problem reduces the general problem of
% deciding the syntatic equivilence relation for an arbitary



% \begin{corollary}
%   There is a polynomial-time reduction from the graph isomorphism problem to
%   the problem of determining if a given $(\mathbb{B}, \tau)$-circuit is rigid.
% \end{corollary}

% \begin{corollary}
%   There is a polynomial-time reduction from the graph isomorphism problem to
%   the problem of determining if a given gate in a given $(\mathbb{B},
%   \tau)$-circuit has unique labels.
% \end{corollary}


% reduction from the graph isomorphism from to the problem of of computing the
% the syntactic equivalence relation on the gates of an arbitrary $(\mathbb{B},
% \tau)$-circuit.

% It is worth noting that if we restrict the input to a class of circuits
% defined over symmetric bases then we can decide the syntactic equivalence
% relation in polynomial time.

% % \begin{prop}
% %   Let $C_n$ be a circuit with symmetric gates. There is an algorithm that
% %   takes in such a circuit, runs in time polynomial in the size of the circuit,
% %   and outputs the syntactic equivalence relation on the gates of $C_n$.
% %   \label{prop:symmetric-syntactic}
% % \end{prop}
% % \begin{proof}
% % \end{proof}

% Moreover, it turns out that being able to compute the syntactic equivalence
% relation in polynomial time for some class of circuits $\mathcal{C}$ implies
% that the existence of a polynomial-time algorithm for converting circuits in
% $C$ into equivalent rigid circuit.

% % \begin{prop}
% %   Let $\mathcal{C}$ be a set of circuits. Suppose the syntactic equivalence
% %   relation can be computed in polynomial time for circuits in $\mathcal{C}$.
% %   It follows that there is an algorithm that runs in polynomial time that
% %   takes in a circuit $C \in \mathcal{C}$ and outputs a rigid circuit $C''$
% %   such that if $C$ is symmetric then $C'$ is symmetric.
% %   \label{prop:syntactic-equivilence-rigid}
% % \end{prop}
% % \begin{proof}
% % \end{proof}

% The following result gives us that the unique labels condition is sufficient.

% % \begin{prop}
% %   Let $\mathcal{C}$ be syntactically transparent class of circuits. It follows
% %   that there exists an algorithm that takes in a $(\mathbb{B}, \tau)$-circuit
% %   $C \in \mathcal{C}$ and outputs a $(\mathbb{B} \cup \mathbb{B}_{\std},
% %   \tau)$-circuit $C'$ such that $C$ and $C'$ compute the same function, $C'$
% %   is rigid, and if $C$ is symmetric then $C'$ is symmetric. Moreover, this
% %   algorithm runs in time polynomial in the size of the input circuit.
% % \end{prop}
% % \begin{proof}
% %   Let $C' = \make-injective-all(\op{merge-all} (C, G)($). We have that $C'$ is
% %   symmetric if $C$ is symmetric. Since the syntactic equivalence relation can
% %   be computed in polynomial time for circuits in $\mathcal{C}$ it follows that
% %   this operation can be implemented so as to run in time polynomial in the
% %   size of $C$. Clearly every gate $g$ in $C'$ belongs to a singleton syntactic
% %   equivalence class.
% % \end{proof}

% \begin{lem}
%   Let $\mathbb{B}$ be a basis of symmetric functions. Then for any class of
%   circuits $\mathcal{C}$ defined over the basis $\mathbb{B}$, $\mathcal{C}$ is
%   a syntactically transparent class of circuits.
% \end{lem}
% In contrast to
% \begin{lem}
%   If the class of all circuits is syntactically transparent then then graph
%   isomorphism problem is in $\PT$.
% \end{lem}

% \begin{lem}
%   Let $\mathcal{C}$ be a syntactically transparent class of circuits. There is
%   an algorithm that takes as input a $(\mathbb{B}, \tau)$-circuit $C \in
%   \mathcal{C}$ and decides if $C$
% \end{lem}

% Since the class of The following result, also proved by Anderson and Dawar
% \cite{AndersonD17}, follows as a corollary.

% \begin{lem}
%   Let $\mathcal{C}$
% \end{lem}

% \begin{lem}
%   Let $C_n = \langle G, \Omega, \Sigma, \Lambda, L\rangle$ be a $(\mathbb{B},
%   \tau)$-circuit computing a $q$-ary query. If $C_n$ has unique labels then it
%   is $C_n$ rigid
%   \label{lem:unique-implies-rigid}
% \end{lem}
% \begin{proof}

%   %   Suppose there exists a gate $g'$ such that $W_t (g, g')$ and $W_t
%   %   (\pi(g),
%   %   g')$ and $\pi (g') = g'$, then $\pi H_{g'} = H_{g'}$, and since $g'$ has
%   %   unique labels it follows that $\pi$ acts trivially on $H_{g'}$ (i.e. for
%   %   all
%   %   $h \in H_{g'}$, $\pi(h) = h$). Moreover, for any pair of gates $h,h' \in
%   %   G$
%   %   such that $W(h, h')$ and $W_t(h', g')$, if $\pi$ acts on trivially on
%   %   the
%   %   children of $h'$ then $\pi (h) = h$ and so $\pi$ must act trivially

%   %   $\pi$ acts trivially on the children of $h$.

%   %   If $\Omega_g \cap \Omega_{\pi(g)} = \emptyset$ then, since
%   %   $\Omega_{\pi(g)}
%   %   =
%   %   \pi \Omega_g$, there exists $g' \in \Omega_g$ such that $\pi g' \neq
%   %   g'$.
%   %   But
%   %   $\pi$ must act trivially on output gates, so this is a contradiction. So
%   %   there
%   %   exists $g' \in \Omega_g \cap \Omega_{\pi(g)}$. But then $W_t (g, g')$
%   %   and
%   %   $W_t
%   %   (\pi (g), g')$.


%   %   We have that $g$ must be a non-output internal gate. So $g$ is
%   %   syntactically
%   %   equivalent to $\pi (g)$.

%   %   and let $h$ be a gate such that $W_t (g, h)$.
% \end{proof}

% \begin{prop}
%   Let $C_n$ be a circuit with unique labels. If
% \end{prop}

% \begin{prop}
  
% \end{prop}
% \begin{proof}
% \end{proof}

% \begin{prop}
%   Let $\mathcal{C}$ be a class on which the Let $C_n := \langle G, \Omega,
%   \Sigma, \Lambda, L \rangle$ be a $(\mathbb{B}, \tau)$-circuit with unique
%   labels. There is a deterministic algorithm that takes in such a circuit and
%   outputs the syntactic equivalence relation on $G$. Moreover, this algorithm
%   runs in time polynomial in the size of the circuit.
%   \label{prop:unique-labels-syntactic-equiv}
% \end{prop}

% % \begin{prop}
% %   There is an algorithm that takes in a $(\mathbb{B}, \tau)$-circuit $C$ with
% %   unique labels and outputs the syntactic equivalence relation on its gates.
% %   This algorithm runs in time polynomial in the size of $C$.
% %   \label{prop:unique-labels-syntactic-equiv}
% % \end{prop}
% % \begin{proof}
% %   We build of the relation by induction. Let $g$
% % \end{proof}

% Putting together Propositions \ref{prop:symmetric-syntactic},
% \ref{prop:syntactic-equivilence-rigid}, and
% \ref{prop:unique-labels-syntactic-equiv}, we have that there is a
% polynomial-time algorithm that takes as input a circuit with unique labels and
% outputs an equivalent rigid circuit. In fact, there is an equivalence of sorts
% between the unique labels condition and the rigidity condition.

% \begin{prop}
%   Let $\mathcal{C}$ be a family of circuits. There is an algorithm that runs
%   in polynomial-time that takes in a circuit $C \in \mathcal{C}$ and outputs a
%   rigid circuit $C'$ such that if $C$ is symmetric then $C'$ is symmetric if,
%   and only if, there is an algorithm that runs in polynomial-time and takes in
%   a circuit $C \in \mathcal{C}$ and outputs a circuit $C'$ with unique labels
%   such that if $C$ is symmetric then $C'$ is symmetric.
% \end{prop}

% It follows then that for the symmetric circuits defined over bases of
% symmetric functions discussed by Anderson and Dawar~\cite{} we may assume the
% circuits are rigid and/or have unique labels without a loss of generality. For
% the more general circuit discussed in this paper we cannot make such an
% assumption as deciding rigidity is harder then graph isomorphism. However, if
% we restrict ourselves to families of circuits with unique labels then again we
% may assume rigidity without a loss of generality.

% Of course, this restriction to circuits with unique labels is only useful if
% we can show that formulas in rank logic can be translated into $P$-uniform
% families circuits with unique labels. In the next subsection we prove that
% this is indeed the case.


\end{document}