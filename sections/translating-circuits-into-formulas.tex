% !TEX root = ../paper.tex
\documentclass[../paper.tex]{subfiles}
\begin{document}
We have thus far shown how to translate formulas of $\FPR$ into equivalent
families of circuits. In this section we show how to translate families of
circuits into equivalent formulas -- completing the proof of the main theorem of
this paper. More explicitly, in this section we show how to construct for every
$P$-uniform family of transparent symmetric rank-circuits a corresponding $\FPR$
formula defining the same query. In the first subsection we develop the theory
needed for this construction and in the second subsection we use this theory to explicitly construct
the formula.

% we show that for a rank gate $g$ in the circuit, the rank at $g$ depends only
% on which elements of the input structure are assigned to the support of $g$.
% We then construct for $g$ and an assignment to the support of $g$ a matrix $M$
% which has the same rank as the matrix defined at that gate. In the second
% subsection we implement the construction of this matrix in $\FPC$, and hence
% produce a formula for evaluating a rank gate in $\FPR$. This formula, together
% with the Immerman-Vardi theorem and the work of Anderson and Dawar
% \cite{AndersonD17}, allows us to both define and evaluate a $P$-uniform family
% of circuits in $\FPR$, completing the result.

\subsection {Evaluating Circuits}
In this subsection we let $\mathcal{C} = (C_n)_{n \in \mathbb{N}}$ denote a
fixed family of polynomial-size symmetric $(\RB,\rho)$-circuits with unique
labels that compute a $q$-ary query. Let $n_0$ and $k$ be the constants in the
statement of Lemma~\ref{lem:row-column-supports}, and fix an $n > n_0$ and a
$\rho$-structure $\mathcal{A}$ with universe $U$ of size $n$. Let $C_n = \langle
G, \Omega, \Sigma, \Lambda, L \rangle$.

Let $\gamma \in [n]^{\underline{U}}$. We first show that the evaluation of a
gate $g$ in $C_n$ depends only on those elements $\gamma$ maps to $\consp(g)$.

\begin{lem}
	Let $g$ be a gate in $C_n$. Let $\eta \in U^{\underline{\consp(g)}}$ and
  $\gamma_1, \gamma_2 \in [n]^{\underline{U}}$ such that $\gamma^{-1}_1 \sim
  \eta$ and $\eta \sim \gamma^{-1}_2$. Then $L^{\gamma_1 \mathcal{A}}(g)$ and
  $L^{\gamma_2 \mathcal{A}}(g)$ are isomorphism-equivalent.
	\label{lem:support-determines-evaluation}
\end{lem}

\begin{proof}
	We have that there exists a unique $\pi \in \sym_n$ such that $\pi \gamma_1 =
  \gamma_2$. Moreover, since $\gamma^{-1}_1$ and $\gamma^{-1}_2$ are both
  consistent with $\eta$, it follows that $\pi$ must fix $\consp(g)$ pointwise.
  From the definition of a support, we have that $\pi g = g$, and so $L(g)$ is
  isomorphism-equivalent to $\pi L(g)$. Thus there exists $\lambda \in \aut(g)$
  such that such that $\pi L(g) = L(g) \lambda$, and so for all $x \in \ind(g)$,
	\begin{align*}
		L^{\gamma_1 \mathcal{A}}(g) (x) & = C_n[\gamma_1 \mathcal{A}](L(g)(x))                    \\
                                    & = C_n[\pi \gamma_1 \mathcal{A}][\pi L(g)(x)]            \\
                                    & = C_n[\gamma_2 \mathcal{A}][L(g)(\lambda(a,b))] \\
                                    & = L^{\gamma_2 \mathcal{A}}(g) (\lambda (a,b)),                 
	\end{align*}
	and it follows that $L^{\gamma_1 \mathcal{A}}(g)$ and $L^{\gamma_2
    \mathcal{A}}(g)$ are isomorphism-invariant.
\end{proof}

We associate with each gate $g$ in $C_n$ a set $\Gamma_g:= \{\gamma \in
[n]^{\underline{U}} : C[\gamma \mathcal{A}](g) = 1 \}$. We also associate with
each gate $g$ in $C_n$ a set $\EV_g \subseteq U^{\underline{\consp(g)}}$
consisting of all assignments to the support of $g$ for which $g$ evaluates to
true, i.e. $\EV_g := \{ \eta \in U^{\underline{\consp(g)}} : \exists \gamma \in
\Gamma_h \, ,\eta \sim \gamma^{-1}\}$. It follows from
Lemma~\ref{lem:support-determines-evaluation} that $\Gamma_g$ is entirely
determined by $\EV_g$. In other words, the set of all bijections that cause $g$
to evaluate to true is entirely determined by a set of assignments to the
support of $g$. It is important to note that, from the support theorem and
choice of $n$, each $\eta \in \EV_g$ has a constant-size domain, and as such
$\EV_g$ gives us a succinct way of encoding $\Gamma_g$.

In the remainder of this subsection we show how to define $\EV_g$ recursively
for each internal gate $g$ in $C_n$, i.e. how to define $\EV_g$ given $\{EV_h :
h \in H_g \}$. In the next subsection we show that there is a formula $\theta
\in \FPR$ implementing this recursive definition. We then use $\theta$, and the
fixed-point operator, to define an $\FPR$-formula $Q$ that evaluates the output
gates of the appropriate-size circuit for a given input structure, and hence
defines the query computed by the family $(C_n)_{n \in \nats}$. In fact, the
recursive definition of $\EV_g$ is handled differently depending on if $g$ is a
constant, relational, $\AND$, $\NAND$, $\OR$, or $\RANK$ gate, and so we define
a different $\FPR$-formula in each case. We then use a disjunction over cases in
order to define $\theta$. We note that Anderson and Dawar~\cite{AndersonD17}
have already defined formulas of $\FPC$, and hence $\FPR$, that handle every
case except where $g$ is a rank gate. As such, we need only consider the case
where $g$ is a rank gate.

For the remainder of the section we fix a rank gate $g$ in $C_n$. For $\gamma
\in [n]^{\underline{U}}$ we let $L^{\gamma} = L^{\gamma \mathcal{A}}(g)$. We let
$A \times B := \ind(g)$. We informally think of $A$ as the set indexing rows and
$B$ as the set indexing columns. For each $h \in H_g$ we let $\row(h) :=
L(g)^{-1}(h)(1)$ and $\column(h) := L(g)^{-1}(h)(2)$. For $a \in \universe{g}$
we let $\consp(a) := \consp_{\spstab{g}}(a)$, $\orb(a) = \orb_{\spstab{g}}(a)$
and $\stab(a) = \stab_{\spstab{g}}(a)$.

We are often interested in the case where two injections can be combined into a
single injection over their combined domains. We say that two $f$ and $q$
injections are \emph{compatible} if we can define an injection over the union of
their domains that agrees with both $f$ and $q$ on their respective domains. We
formalise this notion in the following definition.

\begin{definition}
	Let $f \in Y^{\underline{X}}$ and $q : Z^{\underline{W}}$. We say that $f$ is
  \emph{compatible} with $q$, and we write $f \sim q$, if for all $a \in X \cap
  W$, $f(a) = q(a)$ and for all $a \in X \setminus W$ and $b \in W \setminus X$,
  $f(a) \neq q(b)$.
\end{definition}

It is also useful to have some notation for combining two compatible functions.
Let $f \in Y^{\underline{X}}$ and $q : Z^{\underline{W}}$ be compatible
injections. Define the combination $(f | q): X \cup W \rightarrow Y \cup Z$ by

\begin{align*}
	(f \vert q) (x) =
	\begin{cases}
    f (x) & x \in X  \\
    q (x) & x \in Y.
	\end{cases}
\end{align*}

We also introduce some other notation for combining functions. Let $f: X
\rightarrow Y$ be an injection and $q: X \rightarrow Z$ be a function. We let
$q_f : \img(f) \rightarrow Z$ be defined by $q_f(a) := q \circ f^{-1}(a)$ for
all $a \in \img(f)$.

% Given an assignment $\gamma \in [n]^{\underline{U}}$, we can evaluate the
% children of $g$ in order to form the matrix $L^{\gamma} : A \times B
% \rightarrow \{0,1\}$ defined by $L^{\gamma} (a,b) := C[\gamma
% \mathcal{A}](L(g)(a,b))$ for $(a,b) \in A \times B$. The evaluation of $g$ is
% given by $C[\gamma \mathcal{A}](g) = \Sigma(g) (L^{\gamma})$. Moreover, it is
% easy to see that for any $M : A \times B \rightarrow \{0,1\}$, if $M$ is
% isomorphism-equivalent to $L^{\gamma}$ then $\Sigma(g)(L^\gamma) = \Sigma (g)
% (M)$.

% In the following lemma we show that for any $\gamma_1, \gamma_2 \in
% [n]^{\underline{U}}$ that agree on the support of $g$, $L^{\gamma_1}$ is
% isomorphism-equivalent to $L^{\gamma_2}$. We may thus conclude that the
% evaluation of $g$ for any $\gamma \in [n]^{\underline{U}}$ depends only on
% what it assigns to the support of $g$.

% \begin{lem}
%   Let $g$ be a gate in $C_n$. Let $\eta \in U^{\underline{\consp(g)}}$ and
%   $\gamma_1, \gamma_2 \in [n]^{\underline{U}}$ such that $\gamma^{-1}_1 \sim
%   \eta$ and $\eta \sim \gamma^{-1}_2$. Then $L^{\gamma_1}$ and $L^{\gamma_2}$
%   are isomorphism-equivalent.
%   \label{lem:support-determines-evaluation}
% \end{lem}

% \begin{proof}
%   We have that there exists a unique $\pi \in \sym_n$ such that $\pi \gamma_1
%   = \gamma_2$. Moreover, since $\gamma^{-1}_1$ and $\gamma^{-1}_2$ are both
%   consistent with $\eta$, it follows that $\pi$ must fix $\consp(g)$
%   pointwise. From the definition of a support, we have that $\pi g = g$, and
%   so $L(g)$ is isomorphism-equivalent to $\pi L(g)$. Thus there exists
%   $\lambda \in \aut(g)$ such that such that $\pi L(g) = L(g) \lambda$, and so
%   for all $x \in \ind(g)$,
%   \begin{align*}
% 		L^{\gamma_1} (x) & = C_n[\gamma_1 \mathcal{A}](L(g)(x))                    \\
% 		% & = C_n[\pi \gamma_1 \mathcal{A}][\pi L(g)(x)] \\
% 		% & = C_n[\gamma_2 \mathcal{A}][L(g)(\lambda(a,b))] \\
% 		% & = L^{\gamma_2} (\lambda (a,b)),
% 	\end{align*}
% 	and it follows that $L^{\gamma_1}$ and $L^{\gamma_2}$ are
%  isomorphism-invariant.
% \end{proof}

% \begin{lem}
%   Let $g$ be a matrix-symmetric gate in $C_n$. Let $\eta \in
%   U^{\underline{\consp(g)}}$ and $\gamma_1, \gamma_2 \in [n]^{\underline{U}}$
%   such that $\gamma^{-1}_1 \sim \eta$ and $\eta \sim \gamma^{-1}_2$. Then
%   $L^{\gamma_1}$ and $L^{\gamma_2}$ are isomorphism-equivalent.
%   \label{lem:support-determines-evaluation}
% \end{lem}

% \begin{proof}
%   We have that there exists a unique $\pi \in \sym_n$ such that $\pi \gamma_1
%   = \gamma_2$. Moreover, since $\gamma^{-1}_1$ and $\gamma^{-1}_2$ are both
%   consistent with $\eta$, it follows that $\pi$ must fix $\consp(g)$
%   point-wise. Thus $L(g)$ is isomorphism-equivalent to $\pi L(g)$, and so
%   there exists $(\sigma, \lambda) \in \sym_A \times \sym_B$ such that $\pi
%   L(g) = L(g) (\sigma, \lambda)$.
		
%   We then have that,
%   \begin{align*}
% 		L^{\gamma_1} (a,b) & = C_n[\gamma_1 \mathcal{A}](L(g)(a,b))                    \\
% 		                   & = C_n[\pi \gamma_1 \mathcal{A}][\pi L(g)(a,b)]            \\
% 		                   & = C_n[\gamma_2 \mathcal{A}][L(g)((\sigma, \lambda)(a,b))] \\
% 		                   & = L^{\gamma_2} ((\sigma, \lambda) (a,b)),                 
% 	\end{align*}
% 	and it follows that $L^{\gamma_1} \sim L^{\gamma_2}$.
% \end{proof}

% For each gate $h$ in $C_n$ we associate with it a set $\Gamma_h$ consisting of
% all those bijections that cause $h$ to evaluate to true, i.e. $\Gamma_h:=
% \{\gamma \in [n]^{\underline{U}} : C[\gamma \mathcal{A}](h) = 1 \}$.
% Lemma~\ref{lem:support-determines-evaluation} gives us that the membership of
% $\gamma$ in $\Gamma_h$ is entirely determined by what $\gamma$ maps to
% $\consp(h)$. As such, we also associate with $h$ a set $\EV_h \subseteq
% U^{\underline{\consp(g)}}$ consisting of all assignments to the support of $h$
% for which $h$ evaluates to true, i.e. $\EV_h := \{ \eta \in
% U^{\underline{\consp(g)}} : \exists \gamma \in \Gamma_h \, ,\eta \sim
% \gamma^{-1}\}$. It follows that $\Gamma_h$ is entirely determined by $\EV_h$.
% An important point to emphasise is that each $\eta \in \EV_h$ is defined on a
% constant-size domain, and as such $\EV_h$ gives us a succinct way of encoding
% $\Gamma_h$.

We now show that for any $\eta \in U^{\underline{\consp(g)}}$, there is a matrix
$M$ such that for any $\gamma \in [n]^{\underline{U}}$ with $\gamma^{-1} \sim
\eta$, the rank of $M$ is equal to the rank of $L^{\gamma}$. This allows us to
decide the membership of $\eta$ in $\EV_g$ where $g$ is a rank gate, i.e.
$\Sigma(g) = \RANK^r_p$, by defining $M$ for $\eta$, computing the rank of $M$
over the field of characteristic $p$, and then checking if this result is less
than or equal to the threshold value $r$. We will show in the next subsection
that the construction of $M$, and hence the construction of $\EV_g$, can be done
in $\FPR$.

For the remainder of the subsection we fix $\eta \in U^{\underline{\consp(g)}}$.
For a gate $h \in H_g$, let $A_h := \{\vec{x} \in U^{\underline{\consp(h)}} :
\eta \sim \vec{x}\}$ be the set of assignments to the support of $h$ that are
compatible with $\eta$. We should also like to consider sets of assignments to
the supports of elements in the universe of $g$. For each $s \in \universe{g}$
let $A_s := \{\vec{x} \in U^{\underline{\consp(s)}} : \eta \sim \vec{x}\}$.

We now define the matrix $M$. We begin by defining the index sets for $M$. Let
$R^{\min} := \{\min (\orb(\row(h))) : h \in H_g\}$ and $C^{\min} := \{ \min
(\orb (\column(h))) : h \in H_g\}$, and let
\begin{align*}
	I := \{(i, \vec{x}): i \in R^{\min}, \vec{x} \in A_i\}, 
\end{align*}
and
\begin{align*}
	J := \{(j, \vec{y}): j \in C^{\min}, \vec{y} \in A_j\}. 
\end{align*}

We should like to associate with each index $((i, \vec{x}), (j, \vec{y}))$ a
gate $h$, and then somehow use the assignments $\vec{x}$ and $\vec{y}$ to
construct assignments to the row and column supports of $h$. The matrix at this
index is one if, and only if, the combination of these assignments causes $h$ to
evaluate to true. It remains to show how to select an appropriate gate $h$ and
ensure that the constructed assignments to its row and column supports are
consistent. We do this by shifting the domain of $\vec{y}$ such that the
compatibility conditions are met, and then finding a gate $h$ with row and
column supports equal to domains of the assignments $\vec{x}$ and the shifted
version of $\vec{y}$, respectively. We formalise this reasoning in
Lemma~\ref{lem:permutation-row-column}.

\begin{lem}
	\label{lem:permutation-row-column}
	For any $(i, \vec{x}) \in I$ and $(j, \vec{y}) \in J$, if $n > \max{n_0, 2k}$
  then there exists $\vec{c} \in [n]^{\underline{\consp(j)}}$ such that
  $\vec{y}_{\vec{c}} \sim \eta$ and $\vec{x} \sim \vec{y}_{\vec{c}}$.
\end{lem}

\begin{proof}
  Let us first speak informally about what is required in the definition of
  $\vec{c}$. The idea is to define $\vec{c}$ shifts the domain of $\vec{y}$ such
  that $\vec{y}_{\vec{c}}$ is compatible with $\eta$ and $\vec{x}$. As such, we
  need to define $\vec{c}$ such that, first, $\vec{y}_{\vec{c}}$ agrees with
  $\eta$ on $\consp(g)$, second, $\vec{y}_{\vec{c}}$ and $\vec{x}$ agree on the
  intersection of $\consp(i)$ and the image of $\vec{c}$, and, third,
  $\vec{y}_{\vec{c}}$ disagrees with $\eta$ and $\vec{x}$ outside of their
  domains. In order to satisfy the first requirement we define $\vec{c}$ to be
  the identity on $\consp(g)$. In order to satisfy the second requirement, we
  define $\vec{c}$ such that whenever $\vec{x}$ and $\vec{y}$ agree, i.e. there
  exists $b \in \consp(i)$, $a \in \consp(j)$ such that $\vec{x}(b) =
  \vec{y}(a)$, then then $\vec{c}$ `moves' the domain to be in accord with this
  agreement, i.e. $\vec{c}(a) = b = \vec{x}^{-1}(\vec{y}(a))$. In order to
  satisfy the third requirement we define $\vec{c}$ such that if $x \in
  \img(\vec{y})$ and $x$ is not in the image of either $\vec{x}$ or $\vec{\eta}$
  then $\vec{c}$ `moves' $\vec{y}^{-1}(x)$ outside of the domain of either
  $\vec{x}$ or $\eta$.

  We now define $\vec{c} \in [n]^{\underline{\consp(j)}}$ formally. Let $u_1,
  \ldots , u_k$ be the first $k$ elements of $[n] \setminus (\consp(g) \cup
  \consp(i))$. We define a set $T$ consisting of those elements of the domain
  Let $T = \{a \in \consp(j) \setminus \consp(g) : \vec{y}(a) \in
  \vec{x}(\consp(i) \setminus \consp(g))\}$, and let $\vec{c} \in
  [n]^{\underline{\consp(j)}}$ be defined by
	\[
		\vec{c} (a) =
		\begin{cases}
			a                        & a \in \consp(g) \cap \consp(j)                                     \\
			\vec{x}^{-1}(\vec{y}(a)) & a \in T                                                            \\
			u_{i} & \text{$a$ is the $i$th element of $(\consp(j) \setminus (\consp(g)
        \cup T)))$}.
		\end{cases}
	\]
	It is easy to see that $\vec{y}_{\vec{c}} \sim \eta$. It remains to show that
  $\vec{x} \sim \vec{y}_{\vec{c}}$. Let $c = \img(\vec{c})$. Let $z \in
  \consp(i) \cap c$ and $z' = \vec{c}^{-1}(z)$. Suppose $z' \in \consp(g)\cap
  \consp(j) \cap \consp(i)$. Then we have $\vec{x}(z) = \vec{x}(z') = \eta (z')
  = \vec{y}(z') = \vec{y}_{\vec{c}}(z)$. By a similar argument, if $z' \in
  \consp(g) \cap \consp(j) \setminus \consp(i)$ we have $\vec{x}(z) \neq
  \vec{y}_{\vec{c}}(z)$. Suppose $z' \in T$. Then $\vec{c}(z') =
  \vec{x}^{-1}(\vec{y}(z'))$ which gives us that $\vec{y}_{\vec{c}}(z) =
  \vec{y}(z') = \vec{x}(\vec{c}(z')) = \vec{x}(z)$. We finally note that $z'
  \notin (\consp(j) \setminus (\consp(g) \cup T))$ as $\{u_1 , \ldots , u_k\}
  \cap \consp(i) = \emptyset$. This completes the intersection component of
  compatibility.
		
	Let $z \in \consp(i) \setminus c$ and $w \in c \setminus \consp(i)$. Let $w' =
  \vec{c}^{-1}(w)$. Suppose $w' \in \consp(g) \cap \consp(j)$. Then from the
  fact that $w \notin \consp(i)$ we have that $\vec{y}_{\vec{c}}(w) \neq
  \vec{x}(z)$ (using a similar argument as in the above case). Suppose $w' \in
  T$. Then there exists $b \in \consp(i) \setminus \consp(g)$ such that
  $\vec{y}(w') = \vec{x}(b)$. It follows that $w = \vec{c}(w') =
  \vec{x}^{-1}\vec{y} (w') = b$, which is a contradiction as $w \notin
  \consp(i)$ by assumption, and we conclude $w' \notin T$. Suppose finally that
  $w' \in \consp(j) \setminus (\consp(g) \cup T)$. It follows that for all $b
  \in \consp(i) \setminus \consp(g)$ we have that $\vec{x}(b) \neq
  \vec{y}_{\vec{c}}(w)$. It remains to check the result for $b \in (\consp(i)
  \setminus c) \setminus (\consp(i) \setminus \consp(g)) = (\consp(g) \cap
  \consp(i)) \setminus c$. But then $b \notin \consp(j)$, and so $\vec{x}(b) =
  \eta (b)$. But $w' \notin \consp(g)$, and so $\vec{x}(b) = \eta(b) \neq
  \vec{y}(w') = \vec{y}(w)$. The result follows.
\end{proof}

% \begin{lem}
%   \label{lem:permutation-row-column}
%   For any $(i, \vec{x}) \in I$ and $(j, \vec{y}) \in J$ then if $n > \max{n_0,
%   2*k}$ (where $n_0$ and $k$ are both from the statement of Corollary
%   \ref{cor:constant-size-support-for-everything}) then there exists $\vec{c}
%   \in U^{\underline{\consp_g(j)}}$ such that $\vec{x} \sim \vec{y}_{\vec{c}}$.
% \end{lem}
% \begin{proof}
%   Let $u_1, \ldots , u_k$ be the first $k$ elements of $[n] \setminus
%   (\consp(g) \cup \consp(i))$. Let $T = \{a \in \consp(j) \setminus \consp(g)
%   : \vec{y}(a) \in \vec{x}(\consp(i) \setminus \consp(g))\}$, let $\vec{c}'
%   \in [n]^{\underline{\consp(j)}}$ be defined by
%   \[
%     \vec{c}' (a) =
%     \begin{cases}
%       a                        & a \in \consp(g) \cap \consp(j)                                     \\
%       \vec{x}^{-1}(\vec{y}(a)) & a \in T                                                            \\
%       u_{i} & \text{$a$ is the $i$th element of $(\consp(j) \setminus
%       (\consp(g) \cup T)))$}.
%     \end{cases}
%   \]
%   Let $\sigma_c$ be any permutation such that $\sigma_c \vec{\consp}(j)) =
%   \vec{c}'$. Then $\vec{c} := \sigma_c \vec{\consp}(j) = \vec{c}'$. Let $c$ be
%   the image of $\vec{c}$.
		
%   It remains to show that $\vec{x} \sim \vec{y}_{\vec{c}}$. Let $z \in
%   \consp(i) \cap c$ and $z' = \vec{c}^{-1}(z)$. Suppose $z' \in \consp(g)\cap
%   \consp(j) \cap \consp(i)$. Then we have $\vec{x}(z) = \vec{x}(z') \eta (z')
%   = \vec{y}(z') = \vec{y}_{\vec{c}}(z)$. By a similar argument, if $z'
%   \consp(g) \cap \consp(j) \setminus \consp(i)$ we have $\vec{x}(z) \neq
%   \vec{y}_{\vec{c}}(z)$. Suppose $z' \in T$. Then $\vec{c}(z') =
%   \vec{x}^{-1}(\vec{y}(z'))$ which gives us that $\vec{y}_{\vec{c}}(z) =
%   \vec{y}(z') = \vec{x}(\vec{c}(z')) = \vec{x}(z)$. We finally note that $z'
%   \notin (\consp(j) \setminus (\consp(g) \cup T))$ as $\{u_1 , \ldots , u_k\}
%   \cap \consp(i) = \emptyset$. This completes the intersection component of
%   compatibility.
		
%   Let $z \in \consp(i) \setminus c$ and $w \in c \setminus \consp(i)$. Let $w'
%   = \vec{c}^{-1}(w)$. Suppose $w' \in \consp(g) \cap \consp(j)$. Then from the
%   fact that $w \notin \consp(i)$ we have that $\vec{y}_{\vec{c}}(w) \neq
%   \vec{x}(z)$ (using a similar argument as in the above case). Suppose $w' \in
%   T$. Then there exists $b \in \consp(i) \setminus \consp(g)$ such that
%   $\vec{y}(w') = \vec{x}(b)$. It follows that $w = \vec{c}(w') =
%   \vec{x}^{-1}\vec{y} (w') = b$, which is a contradiction as $w \notin
%   \consp(i)$ by assumption, and we conclude $w' \notin T$. Suppose finally
%   that $w' \in \consp(j) \setminus (\consp(g) \cup T)$. It follows that for
%   all $b \in \consp(i) \setminus \consp(g)$ we have that $\vec{x}(b) \neq
%   \vec{y}_{\vec{c}}(w)$. It remains to check the result for $b \in (\consp(i)
%   \setminus c) \setminus (\consp(i) \setminus \consp(g)) = (\consp(g) \cap
%   \consp(i)) \setminus c$. But then $b \notin \consp(j)$, and so $\vec{x}(b) =
%   \eta (b)$. But $w' \notin \consp(g)$, and so $\vec{x}(b) = eta(b) \neq
%   \vec{y}(w') = \vec{y}(w)$. The result follows.
% \end{proof}

For any $(i, \vec{x}) \in I$ and $(j, \vec{y}) \in J$, let $\vec{c}$ be the
function from Lemma~\ref{lem:permutation-row-column} and let $\sigma_{c} \in
\spstab{g}$ be any permutation such that for all $a \in \consp(j)$, $\sigma_{c}
a = \vec{c}(a)$. We have from Lemma~\ref{lem:support-determine-action} that the
action of $\sigma_{c}$ on $j$ is well defined. Let $h := L(g)(i, \sigma_c j)$.
Let $\vec{w}$ be the restriction of $(\vec{x} \vert \vec{y}_{\vec{c}})$ to the
support of $h$. We define the matrix $M : I \times J \rightarrow \{0,1\}$ by

\begin{align*}
	M((i , \vec{x}), (j, \vec{y})) := \vec{w} \in EV_h. 
\end{align*}

Notice that we could equivalently define $\vec{w}$ as that element of $A_h$ such
that $\vec{w}$ is compatible with $\vec{x}$ and $\vec{y}_{\vec{c}}$. We make use
of this observation in the next subsection.

% From Lemma~\ref{lem:permutation-row-column} we have for any $(i, \vec{x}) \in
% I$ and $(j, \vec{y}) \in J$, corresponding vectors and permutations $\vec{r}$,
% $\vec{c}$, $\sigma_r$ and $\sigma_c$. Let $h := L(g)(\sigma_r(i), \sigma_c
% (j))$. Let $\vec{b}$ for $(i, \vec{x})$ and $(j, \vec{y})$ be the restriction
% of $(\vec{x}_{\vec{r}} \vert \vec{y}_{\vec{c}})$ to the support of $h$. We
% define the matrix $M : I \times J \rightarrow \{0,1\}$ by
% \begin{align*}
% 	M((i , \vec{x}), (j, \vec{y})) := \vec{b} \in EV_h. 
% \end{align*}

% Let $I /{\sim} = \{(i, [\vec{x}]): i \in R^{\min}, [\vec{x}] \in
% A_i/{\sim_i}\},$ and $J/{\sim} = \{(j, [\vec{y}]): j \in C^{\min}, [\vec{y}]
% \in A_j/{\sim_j}\}$. Let the matrix $M_{~} : I /{\sim} \times J / {\sim}
% rightarrow \{0,1\}$ be the function defined by $M_{~} ((i, [\vec{x}]) (j,
% [\vec{y}])) = M(((i, \vec{x}), (j, \vec{y})))$. Lemma
% \ref{lem:matrix-quot-well-defined} gives us that this function is well-define.

% It remains to show that $M_{~} \sim L^{\gamma}$ for some $\gamma: U
% \rightarrow [n]$.

Let $X$ be a set on which a group action of $G \leq \sym_n$ is defined, and let
$x \in X$. In this section we we will usually take $X$ to be $A$, $B$ or $H_g$,
and take $G$ to be $\spstab{g}$ or $\sym_n$, depending on the context. Let $f
\in U^{\underline{\consp(x)}}$ and $\gamma \in [n]^{\underline{U}}$, then we let
$\Pi^{\gamma}_{f}$ denote any permutation in $\spstab{g}$ such that
$\Pi^{\gamma}_f (a) = \gamma (f(a))$ for all $a \in \consp(x)$. Note that from
Lemma~\ref{lem:support-determine-action}, $\Pi^{\gamma}_f(x)$ is well-defined
independently of the particular choice of permutation.

We also note that, for a fixed gate $h \in H_g$, the mapping $\vec{z} \mapsto
\Pi^{\gamma}_{\vec{z}}$, for $\vec{z} \in A_h$, allows us to establish a
correspondence between compatible assignments to the support of $h$ and the
orbit of $h$. Lemma~\ref{lem:translate-EV-circuits} formalises this observation.

\begin{lem}
	Let $\gamma\in [n]^{\underline{U}}$ and $h \in C_n$. Then $\vec{z} \in \EV_h$
  if, and only if, $C_n[\gamma \mathcal{A}](\Pi^{\gamma}_{\vec{z}} (h)) = 1$.
  \label{lem:translate-EV-circuits}
\end{lem}
\begin{proof}
  From the definition of $\EV_h$, $\vec{z} \in \EV_h$ if, and only if, there
  exists $\delta \in [n]^{\underline{U}}$ such that $\delta^{-1} \sim \eta$,
  $\delta^{-1} \sim \vec{z}$, and $C_n[\delta \mathcal{A}](h) = 1$.

  We now make a few observations. First, we have $((\Pi^{\gamma}_{\vec{z}})^{-1}
  \gamma)^{-1} = \gamma^{-1}\Pi^{\gamma}_{\vec{z}} \sim \eta$, as
  $\Pi^{\gamma}_{\vec{z}} \in \spstab{g}$. Second, we have that for any $a \in
  \consp(h)$, $\Pi^{\gamma}_{\vec{z}}(a) = \gamma (\vec{z}(a))$ and so
  $\gamma^{-1}\Pi^{\gamma}_{\vec{z}} = ((\Pi^{\gamma}_{\vec{z}})^{-1}
  \gamma)^{-1} \sim \vec{z}$. Third, we have from
  Lemma~\ref{lem:support-determines-evaluation} that for any $\delta \in
  [n]^{\underline{U}}$ such that $\delta^{-1} \sim \eta$ and $\delta^{-1} \sim
  \vec{z}$, $C_n[\delta \mathcal{A}](h) =
  C_n[((\Pi^{\gamma}_{\vec{z}})^{-1}\gamma) \mathcal{A}](h) = C_n[\gamma
  \mathcal{A}](\Pi^{\gamma}_{\vec{z}}h)$.

  Putting these observations together we have that $\vec{z} \in EV_h$ if, and
  only if, there exists $\delta \in [n]^{\underline{U}}$ such that $\delta^{-1}
  \sim \eta$, $\delta^{-1} \sim \vec{z}$ and $C_n[\delta \mathcal{A}](h) = 1$,
  if, and only if, $C_n[\gamma \mathcal{A}](\Pi^{\gamma}_{\vec{z}}h) = 1$.

  % We note that $C_n[\gamma \mathcal{A}](\Pi^{\gamma}_{\vec{z}}(h)) = 1$ if,
  % and
  % only if, $C_n[(\Pi^{\gamma}_{\vec{z}})^{-1}\gamma \mathcal{A}] (h) = 1$ and
  % hence, using Lemma \ref{}, it is sufficient to prove that
  % $((\Pi^{\gamma}_{\vec{z}})^{-1} \gamma)^{-1} = \gamma^{-1}
  % \Pi^{\gamma}_{\vec{z}} \sim \vec{z}$. But we have $\Pi^{\gamma}_{\vec{z}}(a)
  % =
  % \gamma (\vec{z}(a))$, for $a \in \consp(h)$, and the direction follows.

  % Suppose $C_n[\gamma \mathcal{A}](\Pi^{\gamma}_{\vec{z}} (h)) = 1$. Then
  % $C_n[(\Pi^{\gamma}_{\vec{z}})^{-1}\gamma \mathcal{A}] (h) = 1$. We have that
  % $((\Pi^{\gamma}_{\vec{z}})^{-1}\gamma) \sim \eta$. Moreover, since $\vec{z}
  % \sim \eta$


  % From Lemma \ref{}, we may assume, without a loss of generality, that, since
  % $\Pi^{\gamma}_{\vec{z}} \in \spstab{g}$, $\Pi^{\gamma}_{\vec{z}}\delta =
  % \gamma$ But then $\gamma = \sigma \delta$ for some $\sigma \in \spstab{g}$



  
	% We have that $C_n[\gamma \mathcal{A}](\Pi^{\gamma}_{\vec{z}}(h)) = 1$ if,
	% and
  % only if, $C_n[(\Pi^{\gamma}_{\vec{z}})^{-1}\gamma \mathcal{A}] (h) = 1$. We
  % have that $\vec{z} \in \EV_h$ if, and only if, there exists $\gamma' \in
  % [n]^{\underline{U}}$, $(\gamma')^{-1} \sim \eta$, such that $C_n[\gamma'
  % \mathcal{A}](h) = 1$ and $(\gamma')^{-1} \sim \vec{z}$.
\end{proof}

Let $\gamma \in [n]^{\underline{U}}$ such that $\eta \sim \gamma^{_1}$. Let
$\alpha^{\gamma}: I \rightarrow A$ and $\beta^{\gamma}: J \rightarrow B$ be
defined by $\alpha^{\gamma} (i, \vec{x}) := \Pi^{\gamma}_{\vec{x}}(i)$ and
$\beta^{\gamma} (j, \vec{y}) := \Pi^{\gamma}_{\vec{y}}(j)$, respectively. We now
prove a number of technical lemmas that will ultimately allow us to to prove
that the matrix $M$ quotiented by some appropriate equivalence relation is
isomorphism-equivalent to $L^{\gamma}$. We will use $\alpha^{\gamma}$ and
$\beta^{\gamma}$ to construct the function that witnesses this
isomorphism-equivalence. We first show that $\alpha^{\gamma}$ and
$\beta^{\gamma}$ are surjective.

\begin{lem} 
	For any bijection $\gamma \in [n]^{\underline{U}}$ such that $\gamma^{-1} \sim
  \eta$ both $\alpha^{\gamma}$ and $\beta^{\gamma}$ are surjective.
  \label{lem:alpha-beta-surjective}
\end{lem}
\begin{proof}
	We show that $\alpha^{\gamma}$ is surjective, with the same result for
  $\beta^{\gamma}$ following similarly. Let $q \in A$ and let $i = \min
  (\orb_{g} (q))$. Then there exists $\sigma \in \spstab{g}$ such that $\sigma
  (i) = q$. Let $\vec{x} := \gamma^{-1} (\sigma (\id_{\consp(i)}))$. Notice that
  for $a \in \consp(i)$ we have that $\vec{x}(a) = \gamma^{-1} (\sigma (a))$,
  and since $\gamma^{-1} \sigma \sim \eta$, it follows that $\vec{x} \in A_i$.
		
	For $a \in \consp(i)$ we have $\Pi^{\gamma}_{\vec{x}} (a) = \gamma
  (\vec{x}(a)) = \gamma (\gamma^{-1} (\sigma (a))) = \sigma (a)$. From
  Lemma~\ref{lem:support-determine-action} it follows that $\alpha(i, \vec{x}) =
  \sigma(i) = q$.
\end{proof}

% Note that $\alpha^{\gamma}$ and $\beta^{\gamma}$ can be lifted to functions on
% $I /{\sim}$ and $J /{\sim}$ respectively. Lemma
% \ref{lem:functions-well-defined} gives us that these liftings are
% well-defined.

% We now show that $\alpha^{\gamma}$ and $\beta^{\gamma}$ witness the fact that
% $M_{~}$ and $L^{\gamma}$ are isomorphism-equivalent. We first show that
% $\alpha^{\gamma}$ and $\beta^{\gamma}$ are surjective.

% \begin{remark}
%   I am still in the process of rewriting this section (and figuring out how to
%   restructure it) so as to include this quotienting operation. The remainder
%   of this section should still be looked at, but I have yet to integrate the
%   quotienting operation. I would also like to talk with you about this step.
% \end{remark}

The following lemma allows us to factor a permutation through $\alpha^{\gamma}$
and $\beta^{\beta}$.

\begin{lem}
  \label{lem:alpha-and-gamma}
	Let $(i,\vec{x}) \in I$ and $(j, \vec{y}) \in J$. Let $\gamma \in
  [n]^{\underline{U}}$ be a bijection such that $\gamma^{-1} \sim \eta$ and $\pi
  \in \spstab{g}$. Then $\pi \alpha^{\gamma}(i, \vec{x}) = \alpha^{\pi
    \gamma}(i, \vec{x})$ and $\pi \beta^{\gamma}(j, \vec{y}) = \beta^{\pi
    \gamma}(j, \vec{y})$.
\end{lem}
\begin{proof}
	We have that $\pi \alpha^{\gamma}(i, \vec{x}) = \pi \Pi^{\gamma}_{\vec{x}}(i)$
  and $(\pi \Pi^{\gamma}_{\vec{x}}(\id_{\consp(i)}) = \pi \cdot \gamma (\vec{x})
  = \Pi^{\pi \gamma}_{\vec{x}}(\id_{\consp(i)})$. Since $\Pi^{\gamma}_{\vec{x}}$
  and $\Pi^{\pi \gamma}_{\vec{x}}$ are in $\spstab{g}$, it follows from Lemma
  ~\ref{lem:support-determine-action}, that $\pi \alpha^{\gamma}(i, \vec{x}) =
  \pi \Pi^{\gamma}_{\vec{x}} (i) = \Pi^{\pi \gamma}_{\vec{x}}(i) = \alpha^{\pi
    \gamma}(i, \vec{x})$. Similarly, $\pi \beta^{\gamma}(j, \vec{y}) =
  \beta^{\pi \gamma} (j, \vec{y})$.
\end{proof}

The following result applies Lemma~\ref{lem:alpha-and-gamma} to the evaluation
of gates in the circuit.

\begin{lem}
	\label{lem:alpha-ind-gamma}
	Let $(i,\vec{x}) \in I$ and $(j, \vec{y}) \in J$. Let $\gamma_1, \gamma_2 \in
  [n]^{\underline{U}}$ be such that $\gamma^{-1}_1 \sim \eta$ and $\gamma^{-1}_2
  \sim \eta$. Let $\mathcal{A}$ be a structure. Then $C_n[\gamma_1 \mathcal{A}]
  (L(\alpha^{\gamma_1}(i, \vec{x}), \beta^{\gamma_1}(j, \vec{y}))) =
  C_n[\gamma_2 \mathcal{A}] (L(\alpha^{\gamma_2}(i, \vec{x}),
  \beta^{\gamma_2}(j, \vec{y})))$.
\end{lem}
\begin{proof}
	We note that there exists $\pi \in \sym_n$ such that $\gamma_1 = \pi
  \gamma_2$. Moreover, since $\gamma^{-1}_1$ and $\gamma^{-1}_2$ are both
  consistent with $\eta$, it follows that $\pi \in \spstab{g}$. We then have
  that
	\begin{align*}
		C_n[\gamma_1 \mathcal{A}](L(\alpha^{\gamma_1}(i, \vec{x}), \beta^{\gamma_1}(j,
		\vec{y})) & = C_n[\pi \gamma_1 \mathcal{A}](\pi L(\alpha^{\gamma_1}(i, \vec{x}), 
                \beta^{\gamma_1}(j, \vec{y})) \\
		          & = C_n[\pi \gamma_1 \mathcal{A}](L(\pi                                
                \alpha^{\gamma_1}(i, \vec{x}), \pi \beta^{\gamma_1}(j, \vec{y}))\\
		          & = C_n[\pi                                                            
                \gamma_1 \mathcal{A}](L(\alpha^{\pi \gamma_1}(i, \vec{x}), \pi \beta^{\pi
                \gamma_1}(j, \vec{y})\\
		          & = C_n[\gamma_2 \mathcal] (L(\alpha^{\gamma_2}(i,                     
                \vec{x}), \beta^{\gamma_2}(j, \vec{y})))\\
	\end{align*}The third equality follows from Lemma \ref{lem:alpha-and-gamma}.
\end{proof}

In the definition of the matrix $M$, we define, for a given $(i, \vec{x}) \in I$
and $(j, \vec{y}) \in J$, a gate $h \in H_g$ and an assignment to its support.
We use this gate-assignment pair to define the value of the matrix at the point
$((i, \vec{x}), (j, \vec{y}))$. The following result is used to show that
$\alpha$ and $\beta$ can be used to determine the gate $h$, an important step in
developing the required isomorphism-equivalence.

\begin{lem}
  \label{lem:defining-h-from-IJ}
  Let $i \in A$, $j \in B$, $\vec{x} \in A_i$, $\vec{y} \in B_j$. Let $\sigma_1,
  \sigma_2 \in \spstab{g}$, $\vec{s}_1 \in [n]^{\underline(\consp(i))}$, and
  $\vec{s}_2 \in [n]^{\underline{\consp(j)}}$ be such that $\vec{s}_1$ and
  $\vec{s}_2$ are the restrictions of $\sigma_1$ and $\sigma_2$ to $\consp(i)$
  and $\consp(j)$, respectively, and $\vec{x}_{s_1}$ and $\vec{y}_{s_2}$ are
  compatible. Let $h := L(g)(\sigma_1 \cdot i, \sigma_2 \cdot j)$. Let $\vec{z}
  \in A_h$ be the restriction of $(\vec{x}_{\vec{s}_1} \vert
  \vec{y}_{\vec{s}_2})$ to $\consp(h)$ and $\gamma' :=
  (\Pi^{\gamma}_{\vec{z}})^{-1} \gamma$. Then $\Pi^{\gamma'}_{\vec{x}}(i) =
  \sigma_1 \cdot i = \row (h)$ and $\Pi^{\gamma'}_{\vec{y}}(j) = \sigma_2 \cdot
  j = \column (h)$.
\end{lem}
\begin{proof}

  We prove the result for the $\sigma_1$ case. The other case follows similarly.
  We have from Lemma \ref{lem:support-determine-action} that it is sufficient to
  show that for all $a \in \consp(i)$, $\Pi^{\gamma'}_{\vec{x}} (a) = \sigma_1
  (a)$. Let $a \in \consp(i)$. We have from Lemmas~\ref{lem:support-containment}
  and~\ref{lem:support-mapping} that $\sigma_1 (a) \in \consp(\row(h)) \subseteq
  \consp(\row(h))\cup \consp(\column(h)) = \consp(g) \cup \consp(h)$, and thus
  $\sigma_1(a) \in \consp(g)$ or $\sigma_1(a) \in \consp(h)$.
  
  If $\sigma_1(a) \in \consp(g)$, then, since $\Pi^{\gamma}_{\vec{z}}$ and
  $\sigma_1$ in $\spstab{g}$ and $\gamma^{-1} \sim \eta$ and hence $\gamma' \sim
  \eta$, we have that $\Pi^{\gamma'}_{\vec{x}} \in \spstab{g}$ and so
  $\sigma_1(a) = a = \Pi^{\gamma'}_{\vec{x}}(a)$.

  If $\sigma_1(a) \in \consp(h)$ then, since $\sigma_1(a) \in \consp(\row(h))$,
  $\Pi^{\gamma}_{\vec{z}}(\sigma_1(a)) = \gamma(\vec{z}(\sigma_1(a))) =
  \gamma(\vec{x}_{\vec{s}_1}(\sigma_1(a))) = \gamma (\vec{x}(a))$. Thus
  $\sigma_1 (a) = (\Pi^{\gamma}_{\vec{z}})^{-1}\gamma (\vec{x}(a)) =
  \Pi^{\gamma'}_{\vec{x}}(a)$. The result follows.
  
  % We have that $\Pi^{\gamma'}_{\vec{x}} (a) = (\Pi^{\gamma}_{\vec{z}})^{-1}
  % \gamma (\vec{x} (a))$. We now show that $\gamma (\vec{x}(a)) =
  % \Pi^{\gamma}_{\vec{z}}(\sigma_1(a))$, allowing us to conclude the result.

  % We note that $\gamma (\vec{x}(a)) = \gamma (\vec{x}
  % (\vec{s}^{-1}_1(\vec{s}_1(a)))) = \gamma (\vec{x}_{\vec{s}_1}
  % (\sigma_1(a))))$.

  % . We thus have that $\Pi^{\gamma'}_{\vec{x}}(a) =
  % (\Pi^{\gamma}_{\vec{z}})^{-1} \gamma (\vec{x} (a)) = \sigma_1(a)$. The
  % result
  % follows.
  % We have from Lemma \ref{lem:support-determine-action} that it is sufficient
  % to
  % show that for all $a \in \consp(i)$, $\Pi^{\gamma'}_{\vec{x}} (a) = a$. Let
  % $a
  % \in \consp(i)$. We have that $\Pi^{\gamma'}_{\vec{x}} (a) =
  % (\Pi^{\gamma}_{\vec{z}})^{-1} \gamma (\vec{x} (a))$ and $\gamma (\vec{x}(a))
  % =
  % \Pi^{\gamma}_{\vec{z}}(\sigma_r(a))$. The final equality follows from the
  % fact
  % that $\consp(i) \cup \consp(j) = \consp(g) \cup \consp(h)$, and thus $a \in
  % \consp(g)$ or $a \in \consp(h)$. If $a \in \consp(g)$ then $a =
  % \Pi^{\gamma}_{\vec{z}}(a)$ as $\Pi^{\gamma}_{\vec{z}} \in \spstab{g}$. If $a
  % \in \consp(g)$ then, since $a \in \consp(i)$, $\Pi^{\gamma}_{\vec{z}}(a) =
  % \gamma(\vec{z}(a)) = \gamma(\vec{x}(a))$, we thus have that
  % $\Pi^{\gamma'}_{\vec{x}}(a) =
  % (\Pi^{\gamma}_{\vec{z}})^{-1}\Pi^{\gamma}_{\vec{z}} (a) = a$. The result
  % follows.
\end{proof}

% \begin{lem}
%   \label{lem:defining-h-from-IJ}
%   Let $(i, \vec{x}) \in I$ and $(j, \vec{y}) \in J$. From
%   Lemma~\ref{lem:permutation-row-column} and let $h := L(g) (i, \sigma_c (j))$
%   and $\vec{z}$ be the restriction of $(\vec{x} \vert \vec{y}_{\vec{c}})$ to
%   the support of $h$. Let $\gamma' := (\Pi^{\gamma}_{\vec{z}})^{-1} \gamma$.
%   Then $\alpha^{\gamma'} (i, \vec{x}) = \row (h)$ and $\beta^{\gamma'}
%   (i,\vec{y}) = \column(h)$.
% \end{lem}
% \begin{proof}
%   We prove the result for $\beta^{\gamma'}$ case. We have from Lemma
%   \ref{lem:support-determine-action} that it is sufficient to show that for
%   all $a \in \consp(j)$, $\beta^{\gamma'}(j, \vec{y}) =
%   \Pi^{\gamma'}_{\vec{y}} (a) = \sigma_c (a)$. Let $a \in \consp(j)$. We have
%   that $\Pi^{\gamma'}_{\vec{y}} (a) = (\Pi^{\gamma}_{\vec{z}})^{-1} \gamma
%   (\vec{y} (a))$ and $\gamma (\vec{y}(a)) = \gamma (\vec{y}
%   (\vec{c}^{-1}(\vec{c}(a)))) = \gamma (\vec{y}_{\vec{c}} (\sigma_c(a)))) =
%   \Pi^{\gamma}_{\vec{z}}(\sigma_c(a))$. The final equality follows from the
%   fact that $\consp(i) \cup c = \consp(g) \cup \consp(h)$ (from Lemma \ref{}),
%   and thus $\sigma_r(a) \in \consp(g)$ or $\sigma_r(a) \in \consp(h)$. If
%   $\sigma_c(a) \in \consp(g)$ then $\sigma_c(a) = a =
%   \Pi^{\gamma}_{\vec{z}}(\sigma_c(a))$ as both $\sigma_c$ and
%   $\Pi^{\gamma}_{\vec{z}}$ are in $\spstab{g}$. If $\sigma_c(a) \in \consp(g)$
%   then, since $\sigma_r(a) \in r$, $\Pi^{\gamma}_{\vec{z}}(\sigma_r(a)) =
%   \gamma(\vec{z}(\sigma_r(a))) = \gamma(\vec{x}_{\vec{r}}(\sigma_r(a)))$. We
%   thus have that $\Pi^{\gamma'}_{\vec{x}}(a) =
%   (\Pi^{\gamma}_{\vec{z}})^{-1}\Pi^{\gamma}_{\vec{z}} (\sigma_r(a)) =
%   \sigma_r(a)$. The result follows.
% \end{proof}

% \begin{lem}
%   \label{lem:defining-h-from-IJ}
%   Let $(i, \vec{x}) \in I$ and $(j, \vec{y}) \in J$. From Lemma
%   \ref{lem:permutation-row-column} we have $\vec{r}$, $\vec{c}$, $\sigma_r$
%   and $\sigma_c$. Let $h := L(g) (\sigma_r (i), \sigma_c (j))$ and $\vec{z}$
%   be the restriction of $(\vec{x}_{\vec{r}} \vert \vec{y}_{\vec{c}})$ to the
%   support of $h$. Let $\gamma' := (\Pi^{\gamma}_{\vec{z}})^{-1} \gamma$. Then
%   $\alpha^{\gamma'} (i, \vec{x}) = \row (h)$ and $\beta^{\gamma'} (i,\vec{y})
%   = \column(h)$.
% \end{lem}
% \begin{proof}
%   We prove the result for $\alpha^{\gamma'}$. The $\beta^{\gamma'}$ case
%   follows similarly. We have from Lemma \ref{lem:support-determine-action}
%   that it is sufficient to show that for all $a \in \consp_g(i)$,
%   $\alpha^{\gamma'}(i, \vec{x}) = \Pi^{\gamma'}_{\vec{x}} (a) = \sigma_r (a)$.
%   Let $a \in \consp_g(i)$. We have that $\Pi^{\gamma'}_{\vec{x}} (a) =
%   (\Pi^{\gamma}_{\vec{z}})^{-1} \gamma (\vec{x} (a))$ and $\gamma (\vec{x}(a))
%   = \gamma (\vec{x} (\vec{r}^{-1}(\vec{r}(a)))) = \gamma (\vec{x}_{\vec{r}}
%   (\sigma_r(a)))) = \Pi^{\gamma}_{\vec{z}}(\sigma_r(a))$. The final equality
%   follows from the fact that $r \cup c = \consp(g) \cup \consp(h)\in $, and
%   thus $\sigma_r(a) \in \consp(g)$ or $\sigma_r(a) \in \consp(h)$. If
%   $\sigma_r(a) \in \consp(g)$ then $\sigma_r(a) = a =
%   \Pi^{\gamma}_{\vec{z}}(\sigma_r(a))$ as both $\sigma_r$ and
%   $\Pi^{\gamma}_{\vec{z}}$ are in $\spstab{g}$. If $\sigma_r(a) \in \consp(g)$
%   then, since $\sigma_r(a) \in r$, $\Pi^{\gamma}_{\vec{z}}(\sigma_r(a)) =
%   \gamma(\vec{z}(\sigma_r(a))) = \gamma(\vec{x}_{\vec{r}}(\sigma_r(a)))$. We
%   thus have that $\Pi^{\gamma'}_{\vec{x}}(a) =
%   (\Pi^{\gamma}_{\vec{z}})^{-1}\Pi^{\gamma}_{\vec{z}} (\sigma_r(a)) =
%   \sigma_r(a)$. The result follows.
% \end{proof}


We combine the above lemmas in order to show that $\alpha^{\gamma}$ and
$\beta^{\gamma}$ together define a surjective homomorphism from $M$ to
$L^{\gamma}$.

\begin{thm}
	Let $\gamma\in [n]^{\underline{U}}$ be such that $\eta \sim \gamma^{-1}$ and
  let $(i, \vec{x})\in I$ and $(j, \vec{y})\in J$. It follows that $M((i,
  \vec{x}), (j, \vec{y})) = L^{\gamma}(\alpha^{\gamma}(i, \vec{x}),
  \beta^{\gamma}(j, \vec{y})$.
	\label{lem:ML-equal-elements}
\end{thm}
\begin{proof}
	Let $\vec{c}$ be the vector defined in Lemma \ref{lem:permutation-row-column}
  and $\sigma_c$ be any permutation in $\spstab{g}$ such that the restriction of
  $\sigma_c$ to $\consp(j)$ equals $\vec{c}$.
  
  Let $\vec{w}$ be the restriction of $(\vec{x} \vert \vec{y}_{\vec{c}})$ to
  $\consp(h)$, let $\gamma' = (\Pi^{\gamma}_{\vec{w}})^{-1} \gamma$, and let $h
  = L(g)(i, \sigma_c(j))$. Then
	\begin{align*}
		M((i, \vec{x}), (j, \vec{y}))
    & = \vec{w} \in \EV_h                                    \\
    & = C_n[\gamma \mathcal{A}] (\Pi^{\gamma}_{\vec{w}} (h)) \\
    & = C_n[\gamma' \mathcal{A}] (h)                                                             \\
    & = C_n[\gamma' \mathcal{A}](L(\row(h), \column (h)))                                        \\
    & = C_n[\gamma' \mathcal{A}](L(\alpha^{\gamma'}(i, \vec{x}), \beta^{\gamma'}(j, \vec{y})))   \\
    & = C_n[\gamma \mathcal{A}](L(\alpha^{\gamma}(i, \vec{x}), \beta^{\gamma}(j, \vec{y})))     \\
    & = L^{\gamma}(\alpha^{\gamma}(i, \vec{x}), \beta^{\gamma}(j, \vec{y}))                      
	\end{align*}
	The second equality follows from Lemma~\ref{lem:translate-EV-circuits}. The
  fifth equality follows from Lemma~\ref{lem:defining-h-from-IJ}. The sixth
  equality follows from Lemma~\ref{lem:alpha-ind-gamma}.
\end{proof}

We have shown that, but for injectivety, $\alpha^{\gamma}$ and $\beta^{\gamma}$,
witnesses an isomorphism-equivalence between $M$ and $L^{\gamma}$. We should
thus like to show that $\alpha^{\gamma}$ and $\beta^{\gamma}$ are also
injective, and hence complete the proof. However, it can be shown that
$\alpha^{\gamma}(i, \vec{x}) = \alpha^{\gamma}(i, \vec{x}')$ if, and only if,
there exists $\pi \in \stab_{\consp(g)}(i)$ such that $\vec{x} = \vec{x}'\sigma
\pi$ (see Lemma~\ref{lem:functions-mutual-equivalence}) and, as such,
$\alpha^{\gamma}$ and $\beta^{\gamma}$ are not, in general, injective.

We instead define a new matrix $M_{\equiv}$ by quotienting $M$ by an appropriate
equivalence relation and show that the liftings of $\alpha^{\gamma}$ and
$\beta^{\gamma}$ to the equivalence classes of $\equiv$ witness an
isomorphism-equivalence between $M_\equiv$ and $L^{\gamma}$. We first define the
equivalence relation.

Let $s \in \universe{g}$ and let $\vec{x}, \vec{x}' \in A_s$ and we say that
$\vec{x}$ and $\vec{x}'$ are \emph{mutually stable} on $s$ if there exists $\pi
\in \stab(s)$ such that $\vec{x} (\id_{\consp(s)}) = \vec{x}'\pi
\id_{\vec{\consp(s)}})$. We also say that two permutations $\sigma, \sigma' \in
\spstab{g}$ are \emph{mutually stable} on $s$ if there exists $\pi \in \stab(s)$
such that $\sigma (\id_{\consp(s)}) = \sigma' \pi (\id_{\consp(s)}) $. We note
that mutual stability is an equivalence relation on $A_s$ (and $\spstab{g}$),
and we denote the equivalence of two vectors $\vec{x}, \vec{x}' \in A_s$ by
$\vec{x} \equiv_s \vec{x}'$ and the equivalence of two permutations $\sigma,
\sigma' \in \spstab{g}$ by $\sigma \equiv_s \sigma'$).

% We define a similar equivalence relation $\stab_n{\consp_g(g)} \cap
% \spstab{g}$

% We now show that any permutation

% \begin{lem}
%   Let $s \in D$ and let $\sigma, \sigma' \in \spstab{g} \cap \stab_g(s))$. We
%   have that $\sigma(s) = \sigma' (s)$ if, and only if, $\vec{x} \sigma
%   \equiv_s \vec{x} \sigma'$ for all $\vec{x} \in A_s$.
%   \label{lem:functions-mutual-equivalence}
% \end{lem}
% \begin{proof}
%   Suppose $\sigma(s) = \sigma'(s)$. Then let $\pi = (\sigma')^{-1} \sigma$.
%   Then clearly $\pi \in \stab_g(s) \cap \spstab{g} \subseteq
%   \setstab(\consp_g{s}) \cap \spstab{g}$ and for all $\vec{x} \in A_s$,
%   $\vec{x} \sigma = \vec{x} \sigma' \pi$.

%   Suppose $\vec{x} \sigma \equiv_s \vec{x} \sigma'$ for all $\vec{x} \in A_s$.
%   Thus there exists $\pi \in \spstab{g} \cap \setstab(\consp_g(i))$ such that
%   $\vec{x} \sigma = \vec{x} \sigma' \pi$ for all $\vec{x} \in A_s$. It can be
%   shown that $\pi = (\sigma')^{-1} \sigma$. From mutual stability $\pi \in
%   \stab_g (s)$ and so $(\sigma')^{-1}\cdot \sigma (s) = \pi (s) = s$. The
%   result follows.
% \end{proof}

% \begin{lem}
%   Let $\gamma \in [n]^{\underline{U}}$ such that $\gamma^{-1} \sim \eta$. Let
%   $s \in D$ and let $\sigma, \sigma' \in \spstab{g} \cap
%   \setstab(\consp_g(s))$. Then $\sigma(s) = \sigma' (s)$ if, and only if,
%   $\vec{x} \sigma \equiv_s \vec{x} \sigma'$ for all $\vec{x} \in A_s$.
%   \label{lem:functions-well-defined}
% \end{lem}

% \begin{proof}
%   Suppose $\sigma (s) = \sigma'(s)$. Then $s = \sigma^{-1} \sigma' (s)$. So
%   $\sigma^{-1}\sigma'$ (removed, to be included later)
%   %   Suppose $\sigma(s) = \sigma'(s)$. Take $x := \sigma(s)$. So then
%   %   $\gamma^{-1}(\sigma(s))$
% \end{proof}

We now define the matrix $M_{\equiv}$ and the liftings of $\alpha^{\gamma}$ and
$\beta^{\gamma}$.

Let $I_{\equiv} := \{(i, [\vec{x})]_{\equiv_i}) : (i, \vec{x}) \in I\}$ and
$J_\equiv := \{(j, [\vec{y}]_{\equiv_j}) : (j, \vec{y})\}$. Let $M_{\equiv} :
I_{\equiv} \times J_{\equiv} \rightarrow \{0,1\}$ be defined by $M_\equiv ((i,
[\vec{x}]_\equiv), (j, [\vec{y}]_\equiv)) := M((i,\vec{x}), (j, \vec{y}))$, for
$(i, [\vec{x}]_{\equiv}) \in I_\equiv$ and $(j, [\vec{y}]_{\equiv}) \in
J_\equiv$.

We show in Lemma~\ref{lem:matrix-quot-well-defined} that this matrix is
well-defined and in Lemma~\ref{lem:alpha-beta-mutal-equivalence} that
$\alpha^{\gamma}$ and $\beta^{\gamma}$ are constant on mutual equivalence
classes, and as such may be lifted to act on equivalence classes.

We first prove the claim that those permutations that agree on $s \in
\universe{g}$ are exactly those that are mutually stable on $s$.

\begin{lem}
	Let $s \in \universe{g}$ and let $\sigma, \sigma' \in \stab(\consp(g))$. Then
  $\sigma(s) = \sigma' (s)$ if, and only if, $\sigma \equiv_s \sigma'$.
	% there exists $\pi \in \stab_g(s) \cap \spstab{g}$ such that $\sigma
	% (\vec{\consp}_g(i)) = \sigma' \pi (\vec{\consp}_g(i))$.
	\label{lem:functions-mutual-equivalence}
\end{lem}
\begin{proof}
	Suppose $\sigma(s) = \sigma'(s)$. Then $\pi := (\sigma')^{-1}\sigma \in
  \stab(s)$ and $\sigma = \sigma' \pi$. Suppose there exists $\pi \in \stab(s)$
  such that for all $a \in \consp(g)$, $\sigma (a) = \sigma' \pi (a)$. From
  Lemma~\ref{lem:support-determine-action} we have that $\sigma (i) = \sigma'
  \pi (i)$, and so, since $\pi \in \stab(s)$, $\sigma(i) = \sigma' \pi (i) =
  \sigma' (i)$.
\end{proof}

% \begin{lem}
%   Let $X$ be a set on which the left group action of $\sym_n$ is defined, and
%   let $\sigma, \sigma' \in \stab(\consp(g)) \stab_g(i)$. We have that
%   $\sigma(s) = \sigma' (s)$ if, and only if, there exists $\sigma \equiv_s
%   \sigma'$.
%   \label{lem:functions-mutual-equivalence}
% \end{lem}
% \begin{proof}
%   Suppose $\sigma(s) = \sigma'(s)$. Then let $\pi = (\sigma')^{-1} \sigma$.
%   Then clearly $\pi \in \stab(s) \cap \spstab(g)$ and $\sigma = \sigma' \pi$.

%   Suppose $\sigma \equiv_s \sigma'$. Then let $\pi = (\sigma')^{-1} \cdot
%   \sigma$. From mutual stability $\pi \in \stab (s)$ and so
%   $(\sigma')^{-1}\cdot \sigma (s) = \pi (s) = s$. The result follows.
% \end{proof}

The following lemma gives us that $\alpha^{\gamma}$ and $\beta^{\gamma}$ are
constant on classes of mutually stable assignments.

\begin{lem}
	Let $((i, \vec{x}), (j, \vec{y})), ((i, \vec{x}'), (j, \vec{y}')) \in I \times
  J$ and let $\gamma \in [n]^{\underline{U}}$. If $\vec{x} \equiv_i \vec{x}'$
  then $\alpha^{\gamma}(i, \vec{x}) = \alpha^{\gamma}(i, \vec{x}')$ and if
  $\vec{y} \equiv_j \vec{y}'$ then $\beta^{\gamma}(j, \vec{y}) =
  \beta^{\gamma}(j, \vec{y}')$.
	\label{lem:alpha-beta-mutal-equivalence}
\end{lem}
\begin{proof}
	From mutual equivalence there exists $\sigma \in \stab(i)$ such that $\vec{x}'
  = \vec{x} \sigma$. We have that $\alpha^{\gamma}(i, \vec{x})$ stabilises
  $\consp(g)$. Also, for all $a \in \consp(i)$, $\Pi^{\gamma}_{\vec{x}} (\sigma
  (a)) = \gamma (\vec{x}(\sigma (a))) = \gamma (\vec{x}'(a)) =
  \Pi^{\gamma}_{\vec{x}'}(a)$. It follows from Lemma
  \ref{lem:functions-mutual-equivalence} that $\alpha^{\gamma}(i,\vec{x}) =
  \Pi^{\gamma}_{\vec{x}} (i) = \Pi^{\gamma}_{\vec{x}'}(i) = \alpha^{\gamma}(i,
  \vec{x}')$. The result follows similarly for $\beta$.
\end{proof}

We define the liftings of $\alpha^{\gamma}$ and $\beta^{\gamma}$ as follows. Let
$\alpha^{\gamma}_{\equiv} : I_\equiv \rightarrow A$ and $\beta^{\gamma}_\equiv:
J_\equiv \rightarrow B$ by $\alpha^{\gamma}_{\equiv}(i, [\vec{x}]) :=
\alpha^{\gamma} (i, \vec{x})$ and $\beta^{\gamma}_{\equiv}(j, [\vec{y}]) =
\beta^{\gamma} (j, \vec{y})$, for all $(i, \vec{x}) \in I_{\equiv}$ and $(j,
\vec{y}) \in J_\equiv$. Lemma~\ref{lem:alpha-beta-mutal-equivalence} gives us
that these liftings are well defined.

% \begin{proof}
%   From mutual equivalence there exists $\sigma_1 \in \stab(i) \cap \spstab{g}$
%   and $\sigma_2 \in \stab{j} \cap \spstab{g}$ such that $\vec{x}' = \vec{x}
%   \cdot \sigma_1\restriction{\consp(i)}$ and $\vec{y}' = \vec{y} \cdot
%   \sigma_2\restriction{\consp(j)}$. Notice that $\alpha^{\gamma}(i, \vec{x})$
%   and $\beta^{\gamma}(j, \vec{y})$ both stabilise $\consp(g)$. Then for $a \in
%   \consp(i)$, $\Pi^{\gamma}_{\vec{x}} (\sigma_1 (a)) = \gamma
%   (\vec{x}(\sigma_1 (a))) = \gamma (\vec{x}'(a)) =
%   \Pi^{\gamma}_{\vec{x}'}(a)$. It follows from Lemma
%   \ref{lem:functions-mutual-equivalence} that $\alpha^{\gamma}(i,\vec{x}) =
%   \Pi^{\gamma}_{\vec{x}} (i) = \Pi^{\gamma}_{\vec{x}'}(i)$. The result follows
%   similarly for $\beta$.
% \end{proof}

The following lemma gives us that $M_\equiv$ is well defined.

\begin{lem}
	Let $((i, \vec{x}), (j, \vec{y})), ((i, \vec{x}'), (j, \vec{y}')) \in I \times
  J$ be such that $\vec{x} \equiv_i \vec{x}'$ and $\vec{y} \equiv_j \vec{y}'$,
  then $M((i, \vec{x}), (j, \vec{y})) = M((i, \vec{x}'), (j, \vec{y}'))$.
	\label{lem:matrix-quot-well-defined}
\end{lem}
\begin{proof}
	\begin{align*}
		M((i, \vec{x}),(j, \vec{y})) & = L^{\gamma}(\alpha^{\gamma}(i, \vec{x}), \beta^{\gamma}(j, \vec{y})    \\
		                             & = L^{\gamma}(\alpha^{\gamma}(i, \vec{x}'), \beta^{\gamma}(j, \vec{y}')) \\
		                             & = M((i, \vec{x}'), (j, \vec{y}'))                                       
	\end{align*}
	The second equality follows from Lemma \ref{lem:alpha-beta-mutal-equivalence}.
\end{proof}

We now prove the existence of the required isomorphism-equivalence.

\begin{thm}
	Let $\gamma \in [n]^{\underline{U}}$ such that $\gamma^{-1} \sim \eta$. Then
  $L^{\gamma}$ is isomorphism-equivalent to $M_{\equiv}$.
	\label{thm:LM-equivalence}
\end{thm}
\begin{proof}
	Let $(i, [\vec{x}]) \in I_\equiv$ and $(j, [\vec{y}]) \in J_\equiv$. Then,
  from Lemmas~\ref{lem:matrix-quot-well-defined}
  and~\ref{lem:ML-equal-elements}, we have that $M_\equiv ((i, [\vec{x}]), (j,
  [\vec{y}])) = M ((i, \vec{x}), (j, \vec{y})) = L^{\gamma}(\alpha^{\gamma}(i,
  \vec{x}), \beta^{\gamma}(j, \vec{y}))$.
		
	Moreover, from Lemma \ref{lem:alpha-beta-mutal-equivalence} we can lift
  $\alpha^\gamma$ to $I_\equiv$ and $\beta^{\gamma}$ to $J_\equiv$. It remains
  to show that $\alpha^\gamma_{\equiv}$ and $\beta^{\gamma}_{\equiv}$ are
  bijections. We prove the result for $\alpha^{\gamma}_{\equiv}$, with the proof
  for $\beta^\gamma_\equiv$ following similarly.
		
	We first note that $\alpha^{\gamma}_{\equiv}$ is surjective as both
  $\alpha^{\gamma}$ (see Lemma \ref{lem:alpha-beta-surjective}) and the lifting
  function (i.e. the quotient map from $I$ to $I_\equiv$) are surjective.
		
	Suppose $\alpha^{\gamma}_\equiv((i, [\vec{x}])) = \alpha^{\gamma}_\equiv((i',
  [\vec{x}']))$, and so $\Pi^{\gamma}_{\vec{x}}(i) =
  \Pi^{\gamma}_{\vec{x}'}(i')$. But then $i$ and $i'$ are in the same orbit and
  so, from the definition of $I_{\equiv}$, we have $i = i'$. Thus
  $\Pi^{\gamma}_{\vec{x}}(i) = \Pi^{\gamma}_{\vec{x}'}(i)$, and so from Lemma
  \ref{lem:functions-mutual-equivalence} there exists $\sigma \in \stab(i)$ such
  that for all $a \in \consp(i)$ we have that $\Pi^{\gamma}_{\vec{x}}(a) =
  \Pi^{\gamma}_{\vec{x}'} (\sigma (a))$. But then $\Pi^{\gamma}_{\vec{x}}(a) =
  \gamma (\vec{x}(a)) = \Pi^{\gamma}_{\vec{x}'}(\sigma (a)) = \gamma (\vec{x}'
  (\sigma (a))$ and, since $\gamma$ is a bijection, it follows that $\vec{x}(a)
  = \vec{x}' \sigma (a)$. Thus $\vec{x} \equiv_i \vec{x}'$, and so $[\vec{x}] =
  [\vec{x}']$. We thus have that $\alpha^{\gamma}_\equiv$ and
  $\beta^{\gamma}_\equiv$ are injections, and the result follows.
\end{proof}

The final result in this subsection establishes that, while $M$ and $L^{\gamma}$
are not in general isomorphism-equivalent, $M$, $M_\equiv$ and $L^{\gamma}$ all
have the same rank.

\begin{lem}
	Let $\gamma \in U^{\underline{n}}$ be such that $\gamma^{-1} \sim \eta$ and
  let $p \in \nats$ be prime. Then $\rank_p (M) = \rank_p (M_\equiv) = \rank_p
  (L^{\gamma})$.
  \label{lem:rank-triple-equivilence}
\end{lem}
\begin{proof}
	Let $f : \{0,1\}^{J_\equiv} \rightarrow \{0,1\}^{J}$ be defined such that for
  all $\vec{b} \in {0,1}^{J_\equiv}$, $f(\vec{b}) (j, \vec{y}) := \vec{b}(j,
  [\vec{y}])$ for all $(j, \vec{y}) \in J$. We have that $f$ is injective as,
  for $\vec{b}_1, \vec{b}_2 \in \{0,1\}^{J_\equiv}$, if $f(\vec{b}_1) =
  f(\vec{b}_2)$ then $\vec{b}_1 (j, [\vec{y}]) = f(\vec{b}_1)(j, \vec{y}) =
  f(\vec{b}_2)(j, \vec{y}) = \vec{b}_2(j, [\vec{y}])$, for all $(j, \vec{y}) \in
  J$. Also $f$ is linear as, for $\lambda \in \ff_p$ and $\vec{b}_1, \vec{b}_2
  \in \{0,1\}^{J_\equiv}$, $f(\lambda \vec{b}_1) (j, \vec{y}) = (\lambda
  \vec{b}_1)(j, [\vec{y}]) = \lambda (\vec{b}_1 (j, [\vec{y}])) = \lambda (f(
  \vec{b}_1) (j, \vec{y}))$, and $ f(\vec{b}_1 + \vec{b}_2) (j, \vec{y}) =
  (\vec{b}_1 + \vec{b}_2) (j, [\vec{y}]) = \vec{b}_1(j, [\vec{y}]) +
  \vec{b}_2(j, [\vec{y}]) = f(\vec{b}_1)(j, \vec{y}) + f(\vec{b}_2)(j,
  \vec{y})$, for all $(j, \vec{y}) \in J$.
		
	From the construction of $M_\equiv$ that $f$ maps row vectors in $M_\equiv$ to
  row vectors in $M$. Let $\vec{b}'$ be a row vector in $M$. Then there exists
  $\vec{b} \in \{0,1\}^{J_\equiv}$ defined by $\vec{b} (j, [\vec{y}]) :=
  \vec{b}' (j, \vec{y})$ (Lemma~\ref{lem:matrix-quot-well-defined} gives us that
  this function is well defined). It follows that $f(\vec{b}) = \vec{b}'$, and
  so $f$ is a surjective mapping from the row vectors of $M_\equiv$ to the row
  vectors of $M$.
		
	It follows from the fact that $f$ is an injective linear map and that $f$ maps
  rows in $M_\equiv$ to rows in $M$ that if $B$ is a maximal independent set of
  row vectors in $M_\equiv$ then $f(B)$ is an independent set of row vectors in
  $M$. We now show that in this case $f(B)$ is also maximal. Suppose $f(B)$ is
  not a maximal independent set of row vectors in $M$, then there exists a row
  vector $\vec{b}'$ in $M$ such that $\vec{b}' \notin f(B)$ and $f(B) \cup
  \{b'\}$ is independent. But since $f$ maps rows in $M_\equiv$ to rows in $M$
  surjectively, it follows that $B \cup \{f^{-1}(b') \}$ must be an independent
  set of rows in $M_\equiv$. But since $B$ is maximal, it follows that
  $f^{-1}(b') \in B$ and so $b' \in f(B)$, a contradiction. We thus have that
  $f(B)$ is a maximal independent set of rows in $M$ and, since $f$ is
  injective, we have that $\rank_p (M) = \vert f(B) \vert = \vert B \vert =
  \rank_p (M_\equiv) = \rank_p(L^{\gamma})$. (The final equality follows from
  Theorem~\ref{thm:LM-equivalence}).
\end{proof}

In the next subsection we encode the definition and evaluation of $M$ for some
gate $g$ as a formula of $\FPR$. We use this formula, and the least fixed point
operator, to define an $\FPR$ formula that evaluates the entire circuit.

% Let $(i,\vec{x}), (i, \vec{x}') \in I$ be such that $\vec{x} \equiv \vec{x}'$.
% Let $B_\equiv \subseteq \{0,1\}^{J_{\equiv}}$ be a maximal independent set of
% row vectors in $M_\equiv$. Let $f: B_\equiv \rightarrow \{0,1\}^{J}$ be such
% that, for any $\vec{b}_\equiv \in B_\equiv$, $f(\vec{b}_\equiv) = \vec{b}$ if,
% and only if, $\vec{b}(j, \vec{y}) = \vec{b}_\equiv (j, [\vec{y}])$ for all
% $(j, \vec{y}) \in J$. Let $B := \image (f)$. Then from the definition of
% $M_\equiv$ we have that $B$ is a set of row vectors in $M$.

% From Lemma \ref{lem:matrix-quot-well-defined}, $f$ is injective

% Suppose $B$ is not independent. Then there exists $\vec{b}_1, \ldots,
% \vec{b}_p$

% From Lemma \ref{lem:matrix-quot-well-defined} it follows that for all $(j,
% \vec{y}) \in J$, $M((i, \vec{x}), (j, \vec{y})) = M((i, \vec{x}'), (j,
% \vec{y}))$. In other words any two rows indexed by vectors in the same
% equivalence class are equal. It follows that the set of rows vectors in $M$
% equals the set of rows vectors in $M_\equiv$, and so (from Theorem
% \ref{thm:LM-equivalence}) $\rank (M) = \rank (M_{\equiv}) = \rank
% (L^{\gamma})$.

% \begin{lem}
%   Let $\gamma \in [n]^{\underline{U}}$ such that $\gamma^{-1} \sim \eta$. Then
%   $\rk_p (M) = \rk_p (L^{\gamma})$.
% \end{lem}
% \begin{proof}
%   We show that $\rk(M) = \rk (M_\equiv)$, and the result will follow from
%   Theorem \ref{thm:LM-equivalence}.
% \end{proof}

% Let $((i, \vec{x}), (j, \vec{y})), ((i, \vec{x}'), (j, \vec{y}')) \in I \times
% J$ be such that $\vec{x} \equiv_i \vec{x}'$.
% \begin{lem}

% \end{lem}


% \begin{thm}
%   Let $\gamma\in [n]^{\underline{U}}$, $M$ is row-column equivalent to
%   $L^{\gamma}$. This equivalence is witnessed by $\alpha^{\gamma}$ and
%   $\beta^{\gamma}$.
% \end{thm}
% \begin{proof}
%   We have that $\alpha^{\gamma}$ and $\beta^{\gamma}$ are surjective. Let
%   $\gamma' = (\Pi^{\gamma}_{(\vec{x}_{\vec{r}} \vert \vec{y}_{\vec{c}})})^{-1}
%   \gamma$.

%   \begin{align*}
%     M((i, \vec{x}), (j, \vec{y}))
%     &= (\vec{x}_{\vec{r}} \vert \vec{y}_{\vec{c}}) \in \EV_h \\
%     &= C_n[\gamma \mathcal{A}] (\Pi^{\gamma}_{(\vec{x}_{\vec{r}} \vert
%       %     \vec{y}_{\vec{c}})} (h)) \\
%       %     &= C_n[\gamma' \mathcal{A}] (h) \\
%       %     &= C_n[\gamma' \mathcal{A}](L(\row(h), \column (h)))\\
%       %     &= C_n[\gamma' \mathcal{A}](L(\alpha^{\gamma'}(i, \vec{x}),
%       %     \beta^{\gamma'}(j, \vec{y})))\\
%       %     &= C_n[\gamma \mathcal{A}](L(\alpha^{\gamma}(i, \vec{x}),
%       %     \beta^{\gamma}(j, \vec{y}))y)\\
%       %     &= L^{\gamma}(\alpha^{\gamma}(i, \vec{x}), \beta^{\gamma}(j,
%       %     \vec{y}))
%   \end{align*}
%   The second equality follows from Lemma \ref{lem:translate_EV_circuits}. The
%   fifth equality follows from Lemma \ref{lem:defining_h_from_IJ}. The sixth
%   equality follows from Lemma \ref{lem:alpha_ind_gamma}.
% \end{proof}

% \begin{remark}
%   In fact, the above still requires injectivity. This still needs to be
%   integrated.
% \end{remark}


% \subsection{FPR Formulas}

% \begin{lem}
%   Let $(i, \vec{x}) \in I$ and $(j, \vec{y}) \in J$. Let $h \in H$ such that
%   $\row (h) \in \orb_r (i)$, $\column (h) \in \orb_c(j)$, and $\type(h) =
%   \type(\vec{x}, \vec{y})$. Let $\gamma: U \rightarrow [n]$ be a bijection and
%   $\mathcal{A}$ a structure. Then $C_n[\gamma
%   \mathcal{A}](\Pi^{\gamma}_{\vec{x} \vert \vec{y}} (h)) = C_n[\gamma
%   \mathcal{A}](L(\alpha^{\gamma}(i, \vec{x}), \beta^{\gamma}(j, \vec{y})))$.
% \end{lem}
% \begin{proof}
%   Let $\gamma' = (\Pi^{\gamma}_{\vec{x} \vert \vec{y}})^{-1} \gamma$. First we
%   show that $h = L(\alpha^{\gamma'}(i, \vec{x}), \beta^{\gamma'}(j,
%   \vec{y}))$. Notice that $\Pi^{\gamma'}_{\vec{x}}(\vec{r}_i) =
%   \gamma'(\vec{x}) = (\Pi^{\gamma}_{\vec{x} \vert \vec{y}})^{-1} \gamma
%   (\vec{x}) = \vec{r}_h$. But $\row(h) \in \orb_r(i)$ and so there exists
%   $\vec{x}' \in A^r_i$ such that $\Pi^{\gamma'}_{vec{x}'}(i) = \row{h}$ From
%   Lemma \ref{lem:support\_determine_action} it follows that $\row (h) =
%   \Pi^{\gamma'}_{\vec{x}}(i) = \alpha^{\gamma'}(i, \vec{x})$. Similarly, we
%   can show that $\column(h) = \beta^{\gamma'}(j, \vec{y})$. It follows that $h
%   = L(\alpha^{\gamma'}(i, \vec{x}), \beta^{\gamma'}(j, \vec{y}))$, and so
%   \begin{align*}
%     C_n[\gamma \mathcal{A}](\Pi^{\gamma}_{\vec{x} \vert \vec{y}} (h))
%     &= C_n[\gamma' \mathcal{A}](h)\\
%     &= C_n[\gamma' \mathcal{A}](L(\alpha^{\gamma'}(i, \vec{x}),
%       %     \beta^{\gamma'}(j, \vec{y})))\\
%       %     &= C_n[\gamma \mathcal{A}](L(\alpha^{\gamma}(i, \vec{x}),
%     %     \beta^{\gamma}(j, \vec{y}))).
%   \end{align*}
%   The final equality follows from Lemma \ref{lem:alpha_ind_gamma}.
% \end{proof}


% \chapter{New Stuff}
% Let $x,y \subset U$ such that $\vert x \vert = \vert y \vert = k \in
% \mathbb{N}$. Let $\vec{x}: [k] \rightarrow x$ and $\vec{y}: [k] \rightarrow y$
% be bijections.

% We need to define $r, c \subset [n]$ such that $\vert r \vert = \vert c \vert
% = k$ and there exists bijections $\vec {r}: [k] \rightarrow r$ and $\vec{c}:
% [k] \rightarrow c$.

% Let $u_1 , \ldots , u_{2k}$ be the first $2k$ elements of $[n] \setminus
% \SP(g)$ in order. Then let
% \[r = \eta^{-1} (x \cap \eta (\SP(g))) \cup \{u_{\vec{x}^{-1}(a)}: a \in x
%   \setminus \alpha (\SP (g))\} \] and
% \[s = \eta^{-1} (y \cap \eta (\SP(g))) \cup (x \cap y) \cup \{ u_{k +
%   \vec{x}^{-1}(a)} : a \in y \setminus (x \cup \alpha (\SP (g))) \}). \]
% Define
% \[
%   \vec{r} (a) =
%   \begin{cases}
%     \eta^{-1} (\vec{x} (a)) & a \in \vec{x}^{-1} (x \cap \eta (\SP(g))) \\
%     u_{a} & a \in \vec{x}^{-1} (x \setminus \eta(\SP(g)),
%   \end{cases}
% \]
% and

% \[
%   \vec{c} (a) =
%   \begin{cases}
%     \eta^{-1} (\vec{y} (a)) & a \in \vec{y}^{-1}(y \cap \eta (\SP (g))) \\
%     \vec{r} (a) & a \in \vec{y}^{-1} (x \cap y \setminus \eta (\SP (g))) \\
%     u_{k+a} & \text{otherwise}.
%   \end{cases}
% \]

% \begin{lem}
%   $x_r \sim \eta$ and $x_c \sim \eta$
% \end{lem}

% \begin{lem}
%   $\SP(g) \cap \SP(i) = \SP(g) \cap r$ and $\SP (g) \cap SP (j) = \SP (g) \cap
%   c$.
% \end{lem}

% Let $(\vec{x}, \vec{y})_{\vec{r}, \vec{c}}: r \cup c \rightarrow U$ be defined
% by
% \[
%   (\vec{x}, \vec{y})_{\vec{r}, \vec{c}}(a) =
%   \begin{cases}
%     \vec{x}(\vec{r}^{-1}(a)) & a \in r \\
%     \vec{y}(\vec{c}^{-1}(a)) & a \in c
%   \end{cases}
% \]

% This function is well defined.

% % \begin{lem}
% %   Let $r, c \subset U$ and let $r_1, r_2 : [k_1] \rightarrow r$ and $c_1, c_2 :
% %   [k_2] \rightarrow c$ then $\type(\vec{r}_1, \vec{c}_1) = \type (\vec{r}_2 ,
% %   \vec{c}_2)$.
% % \end{lem}

% \begin{lem}
%   $(\vec{x}_{\vec{r}} \vert \vec{y}_{\vec{y}}) \sim \eta$
% \end{lem}

% \begin{lem}
%   There exists $\sigma_1, \sigma_2 \in \spstab{g}$ such that $\sigma_1 \cdot
%   \vec{\consp(i)} = \vec{r}$ and $\sigma_2 \cdot \vec{\consp(j)} = \vec{c}$.
% \end{lem}

% \begin{lem}
%   Let $(i, \vec{x}) \in I$ and $j, \vec{y} \in J$. Let $\vec{r}$ and $\vec{c}$
%   be described as above. Let $\sigma_1$ and $\sigma_2$ be as from Lemma
%   \ref{}. Let $h = L(g) (\sigma_1 (i), \sigma_2 (j))$. Then $\alpha^{\gamma'}
%   (i, \vec{x}) = \row (h)$ and $\beta^{\gamma'} (i,\vec{y}) = \column(h)$.
% \end{lem}
% \begin{proof}
%   $\alpha^{\gamma'}(i, \vec{x}) = \Pi^{\gamma'}_{\vec{x}} (i)$. It is
%   sufficient to show that for all $a \in sp(g)$, $\Pi^{\gamma}_{\vec{x}} (a) =
%   \sigma_1 (a)$. Note that $\Pi^{\gamma'}_{\vec{x}_i} (a) =
%   (\Pi^{\gamma}_{(\vec{x}, \vec{y})_{\vec{r}, \vec{c}}})^{-1} \gamma
%   (\vec{x}_i (a))$, and if $b = \sigma_1 (a)$ we have that $\gamma (\vec{x}_i
%   (a)) = \gamma (\vec{x} (\vec{\consp}(i)^{-1} (a))) = \gamma (\vec{x}
%   (\vec{\consp}(i)^{-1} (\sigma^{-1}_1 b))) = \gamma (\vec{x} ((\sigma_1 \cdot
%   \vec{\consp}(i))^{-1} (b))) = \gamma (\vec{x} (\vec{r}^{-1}(b))) =
%   \Pi^{\gamma}_{(\vec{x}, \vec{y})_{\vec{r}, \vec{c}}}(b)$. So
%   $\Pi^{\gamma'}_{\vec{x}} (a) = b = \sigma_1 (a)$. Similarly for
%   $\beta^{\gamma'}$.
% \end{proof}

% \begin{lem}
%   Let $(i, \vec{x}) \in I$ and $(j, \vec{y}) \in J$. There exists $h \in H$
%   such that $h$ has type $(\vec{x}, \vec{y})$ and for any bijection $\gamma: U
%   \rightarrow [n]$ and structure $\mathcal{A}$ then $C_n[\gamma \mathcal{A}]
%   (\Pi^{\gamma}_{(\vec{x} \vert \vec{y})_{h}}) = C_n [\gamma
%   \mathcal{A}](L(\alpha^{\gamma}(i, \vec{x}), \beta^{\gamma}(j, \vec{y})))$.
% \end{lem}

% \begin{lem}
%   Let $h \in H$ and $\vec{z} \in A_h$ and $\Pi^{\delta}_h$ be a permutation
%   such that $\Pi^{\delta}_{\vec{z}}(a) = \delta(\vec{z}(a))$ for all $a \in
%   \sp(h)$. Then $C_n[\gamma \mathcal{A}](\Pi^{delta}_{\vec{z}} (h))$ iff
%   $\vec{z} \in \EV_h$.
% \end{lem}

% \begin{thm}
%   The matrix $M$ is equivalent to $L$.
% \end{thm}

\subsection{Translating to Formulas of FPR}
\label{sec:translating-formulas-to-FPR}
In this subsection we let $\mathcal{C} = (C_n)_{n \in \mathbb{N}}$ denote a
fixed $P$-uniform family of transparent symmetric $(\RB, \rho)$-circuits
defining a $q$-ary query. We define an $\FPR$-formula $Q$ such that for any
$\rho$-structure $\mathcal{A}$ over a universe $U$, with $\vert U \vert = n$,
the $q$-ary query defined by $C_n$ for the input $\mathcal{A}$ is defined by $Q$
when interpreted in $\mathcal{A}$.

The Immerman-Vardi theorem~\cite{Immerman198686, Vardi:1982} gives us that a
polynomial-time algorithm can be converted into an equivalent $\FP[\leq]$
interpretation. It is easy to see that any $t$-width $\FP[\tau]$-interpretation $\Phi'$
can be translated into an equivalent sequence of $\FPC[\tau]$-formulas $\Phi$.

\begin{lemma}
  Let $\Phi = \langle \phi_1, \ldots , \phi_p \rangle$ be a $t$-width
  $\FP[\leq]$-interpretation. There exists a sequence of formulas $\Phi' =
  \langle \phi_1' , \ldots, \phi_p' \rangle$ such that 
  \end{lemma}
Moreover, 

from the $P$-uniformity of $\mathcal{C}$ and
Lemma~\ref{lem:transparent-unique} that there is a $\FP(\leq)$ interpretation
$\Phi'$ that, when interpreted in $\langle [n], \leq \rangle$, defines a
symmetric rank-circuit with unique labels equivalent to $C_n$. We abuse notation
and also refer to this equivalent circuit as $C_n$. Let $t$ be the width of this
interpretation. It is easy to see that

We should like to define this interpretation `within' the number universe of
$\FPC$. It is easy to see that we can define $\Phi$ in $\FPC$ from $\Phi'$ such
that $\Phi$ defines $C_n$ using a sequence of $\FPC$-formulas rather than formulas
of $\FP(\leq)$. To see this, let $t$ be the width of $\Phi'$. Then the domain of
$\Phi'$ is a subset of $[n]^t$. Let $\phi_f$ be an number-term that defines a
bijection from $[n^t]$ to $[n]^t$ for each $n$. Then for each $\phi'
(\vec{\nu}_1, \ldots, \vec{\nu}_{p}) \in \Phi$, where $\vec{\nu}_i$ is an
$t$-length vector of variables, we can define a number-term $\phi''$ from
$\phi'$ by replacing all vertex variables with number variables and bounding
each quantifier by the size of the universe of the input structure such that for
$\vec{a}_1, \ldots, \vec{a}_p \in [n]^t$, $\langle [n], \leq \rangle \models
\phi' [\vec{a}_1, \ldots, \vec{a}_p]$ if, and only if, $\mathcal{A} \models
\phi'' [\vec{a}_1, \ldots, \vec{a}_p]$. We then let $\phi(\nu_1, \ldots, \nu_p)
:= \phi''(\phi_f (\nu_1), \ldots, \phi_f(\nu_p))$, and let $\Phi$ be the
sequence of formulas $\phi$ defined from $\phi'$ in $\Phi'$.

We thus have an interpretation $\Phi := (\phi_G, \phi_\Omega, (\phi_s)_{ s \in
  \RB \cup \rho \cup \{0,1\}}, (\phi_{\Lambda_R})_{R \in \rho}, \phi_L)$ in
$\FPC$ defining the circuit $C_n$ when interpreted in $\mathcal{A}$. Each of
these formulas are number terms that The formulas in this interpretation are
defined as follows.

\begin{myitemize}
\item The number term $\phi_G(\mu)$, when interpreted in $\mathcal{A}$, defines
  a subset of $[n^t]$, which we identify with $G$ (the set of gates in the
  circuit), and hence write $G \subseteq [n^t]$.
\item The number term $\phi_{\Omega}(\nu_1, \ldots , \nu_q, \mu)$ is defined
  such that $\mathcal{A} \models \phi_\Omega[a_1, \ldots, a_q, g]$ if, and only
  if, $(a_1, \ldots, a_q) \in [n]^q$ and $\Omega(a_1, \ldots, a_q) = g$.
\item The number term $\phi_s (\mu)$ is defined for $s \in \RB \uplus \rho
  \uplus \{0,1\}$ such that $\mathcal{A} \models \phi_s [g]$ if, and only if,
  $\Sigma$ maps $g$ to assigned to the symbol $s$.
	      	      
\item For $R \in \rho$ of arity $r$ the number term $\phi_{\Lambda_R}(\nu_1,
  \ldots, \nu_r, \mu)$ is defined such that $\mathcal{A} \models
  \phi_{\Lambda_R} [a_1, \ldots, a_r, g]$ if, and only if, $(a_1, \ldots,
  a_r)\in [n]^r$ and $g$ is a relational gate such that $\Sigma (g) = R$ and
  $\Lambda_R (g) = (a_1, \ldots, a_r)$.
\item The number term $\phi_L(\mu, \nu, \delta, \epsilon)$ is defined such that
  $\mathcal{A} \models \phi_L[g,h,i,j]$ if, and only if, $g$ and $h$ are gates
  and $L(g)(i,j) = h$.
\end{myitemize}
% The Immerman-Vardi Therorem can be used to show that there exist number terms
% $\FA{row}(\mu, \delta)$ and $\FA{col} (\mu, \delta)$ such that $\mathcal{A}
% \models \FA{row}[g, i]$ (resp. $\mathcal{A} \models \FA {col} [g, j]$) if, and
% only if, $g$ is a gate and $i \in A$ (resp. $g$ is a gate and $j \in B$).

Since there is an obvious polynomial-time computable function that takes in an
$n \in \nats$ and a gate $g$ in $C_n$ and outputs the characteristic and
threshold of a rank gate, we have from the Immerman-Verdi theorem that there
exists a formula $\FA{rank-type}(\mu, \kappa , \pi)$ such that $\mathcal{A}
\models \FA{rank-type}[g, r, p]$ if, and only if, $g$ is a rank gate with
characteristic $p$ and threshold $r$. We note that the bound on the domain is
definable as a closed number term $\FA{m} := (x\# (x = x))*t$.

Let $n_0$ and $k$ be the constants in the statement of
Lemma~\ref{lem:row-column-supports}, Let $n_0$ and $k$ be the constants. Then
for all $n \geq n_0$ the support of each gate has size at most $k$. Note that
for each $n \leq n_0$, $C_n$ can be evaluated by an $\FPC$ formula that
quantifies over all of the possible bijections from the universe of
$\mathcal{A}$ to $[n]$ (since there are at most constantly many such
bijections). As such we suppose $n > n_0$ in the rest of this subsection.

We recursively construct $\EV_g$ for each gate $g$ in the circuit. While we have
that the canonical support of $g$ has size at most $k$, it may not be equal to
$k$. As such, if $\vert \consp(g) \vert = \ell$, we define

\begin{align*}
	\overline{\EV}_g = \{ (a_1, \ldots , a_k) \in [n]^k : (a_1 , \ldots , a_\ell ) \in \EV_g \text{ and } i \neq j \implies a_i \neq a_j \}. 
\end{align*}

In this subsection we use $\mu$ and $\nu$ to denote number variables that should
be assigned to gates and use $\epsilon$ and $\delta$ to denote variables that
should be assigned to elements of the universe of a gate. We use $\kappa$ and
$\pi$ to denote other number variables. We use $x, y, z, \ldots$ to denote
vertex variables and $U, V, \ldots$ to denote relational variables. We use $a,
b, c , \ldots$ to denote elements of the vertex sort. When a vector of values or
variables is used without reference to size, it is taken to be a $k$-tuple.

Let $s \subseteq [n]$, $X$ be a set, and $f \in X^{\underline{s}}$. Then, since
$[n]$, and hence $s$, is an ordered set, we let $\vec{s}$ denote the $\vert s
\vert$-tuple given by listing the elements of $s$ in order. We let $\vec{f}$
denote a $\vert s \vert$-tuple formed by applying $f$ to $s$ in order (i.e.
$\vec{f} := f \circ \vec{s}$).

We seek to define the relation $V \subseteq [n^t] \times U^k$ such that $V(g,
\vec{a})$ if, and only if, $\vec{a} \in \overline {\EV}_g$ in $\FPR$ using the
least fixed point operator. In order to do so we first define a formula
$\theta(\mu, \vec{x})$ which holds that the gate denoted by $\mu$ evaluates for
the assignment denoted by $\vec{x}$ to its support. Importantly, $\theta$ is
defined in terms of a relation symbol, which we also call $V$, which is meant to
denote a relation that

if the relation symbol is assigned to using a relation symbol, which is
assigned, when applying the least fixed point operator, to the value of $V$ for
all gates of will be assigned to a relation symbol corresponding to the
restriction of $V$ to the children of

$evaluations of all the children of $\mu$ for any assignment to their supports.
terms of a relation symbol

gives the value of $V$ for the input gates gates to $\mu$. using a relation
symbol that will be assigned to $V$ We first define a formula $\theta(\mu,
\vec{x})$ that evaluates the gate denoted by $\mu$ given an assignment denoted
by $\vec{x}$. We will define $\theta(\mu, \vec{x})$ by disjunction over cases.
Let $S = \{\AND, \OR, \NAND, \MAJ, \RANK\}$ be a set of symbols. For each S \cup
\tau \cup \{0,1\}$ we define $\theta_s (\mu, \vec{x})$each of which evaluates
the denoted gate and evaluation in the case that the gate is of type $s$. for
the assignment to its support denoted by $\vec{x}$ when the denoted gate is
labelled by a symbol associated with $s$. Each of these formulas are written in
terms of $V$, the relation variable we are inductively defining.

Let $S = \{\AND, \OR, \NAND, \MAJ, \RANK\}$ be a set of symbols. For each symbol
$s \in \mathbb{B}$, we define a separate $\theta_s$ and then define $\theta(\mu,
\vec{x})$ using a disjunction over these symbols. We will define the $\FPR$
formula $\theta_\rank (\mu, \vec{x})$. The formulas for the other symbols have
formulas have already been defined by Anderson and Dawar~\cite{AndersonD17}, and
so this will suffice. We first define a formula $\psi_M$ that defines the matrix
$M$ from the previous subsection. We then use the rank operator to compute the
rank of the given matrix. In order to define $\psi_M$ and $\theta_\rank$
succinctly we first define a number of useful $\FPC$ formulas.

We define the closed number term $\FA{s} := x\# (x = x)$, denoting the size of
the structure. We define two formulas that define the set of elements of the
first and second sort of the universe of a gate $g$ (i.e. the set of row and
column indexes).
\begin{align*}
	\FA{row} (\mu, \delta) :=   & \exists \nu, \epsilon \leq \FA{m} \, (\Phi_L (\mu, \delta, \epsilon, \nu)) \\
	\FA{col} (\mu, \epsilon) := & \exists \nu, \delta \leq \FA{m} \, (\Phi_L (\mu, \nu, \delta , \epsilon))  
\end{align*}
From Lemma~\ref{lem:computing-support-orbit-index}, and invoking the
Immerman-Vardi theorem, there exists an $\FPC$-formula $\FA{orb}(\mu, \delta,
\epsilon)$ such that $\mathcal{A} \models \FA{orb}[g,i, i']$ if, and only if,
$i$ and $i'$ are in the universe of $g$ and $i \in \orb(i')$. The following
formula allows us to defines the minimal element of this orbit
\begin{align*}
	\FA{min-orb} (\mu, \delta) := \forall \epsilon \leq \FA{m} \, (\FA{orb} (\mu, \delta, \epsilon) \implies \delta \leq \epsilon). 
\end{align*}

% We define an $\FPC$ formula $\FA{agree}_s (\vec{s}_1, \vec{s}_1, \vec{x},
% \vec{y})$ such that for $\mathcal{A}$, $\mathcal{A}^{\leq} \models
% \FA{agree}_s[\vec{r}, \vec{c}, \vec{a}, \vec{b}]$ if, and only if,
% $\vec{a}_{\vec{r}} \sim \vec{b}_{\vec{c}}$.

From Anderson and Dawar~\cite{AndersonD17} there is an $\FPC$-formula
$\FA{supp}$ such that $\mathcal{A} \models \FA{supp} [g, u]$ if, and only if,
$\mathcal{A} \models \phi_G [g]$ and $u$ is in $\consp(g)$. Anderson and
Dawar~\cite{AndersonD17} use this formula to inductively define a set of
formulas $\FA{supp}_i$ for each $i \in \nats$ such that $\mathcal{A} \models
\FA{supp}_i[g, u]$ if, and only if, $u$ is the $i$th element of $\consp(g)$.

Similarly, we can define $\FA{supp}^r$ such that $\mathcal{A} \models
\FA{supp}^r[g, a, u]$ if, and only if, $\mathcal{A} \models \phi_G [g] \land
\FA{row}[g, a]$ and $u$ is in $\consp(a)$, and $\FA{supp}^c$ such that
$\mathcal{A} \models \FA{supp}^c[g, a, u]$ if, and only if, $\mathcal{A} \models
\phi_G [g] \land \FA{col}[g, a]$ and $u$ is in $\consp(u)$. Similarly, can
define the formulas $\FA{supp}^r_i$ and $\FA{supp}^c_i$.

From Anderson and Dawar~\cite{AndersonD17} we have an $\FPC$ formula
$\FA{agree}(\mu, \nu, \vec{x}, \vec{y})$ such that $\mathcal{A} \models
\FA{agree}[g, h, \vec{a}, \vec{b}]$ if, and only if, $\vec{a}_{\vec{\consp}(g)}$
is compatible with $\vec{b}_{\vec{\consp}(h)}$.

% A similar argument allows us to define $\FA{agree}_L (\mu, \nu, \delta ,
% \vec{x}, \vec{y}, \vec{z})$ (where $\vec{z}$ is a tuple of size $2k$) such
% that $\mathcal{A} \models \FA{agree}_L [g, h, i, \vec{a}, \vec{b}, \vec{c}]$
% if, and only if, $\vec{a}_{\vec{\consp}(g)}$, $\vec{b}_{\vec{\consp}(h)}$, and
% $\vec{c}_{\vec{\consp}_g(i)}$ are all pairwise compatible.

A similar argument allows us to define $\FA{agree}_L (\mu, \delta , \vec{x},
\vec{z})$ (where $\vec{z}$ is a tuple of size $2k$) such that $\mathcal{A}
\models \FA{agree}_L [g, i, \vec{a}, \vec{r}]$ if, and only if,
$\vec{a}_{\vec{\consp}(g)}$ and $\vec{r}_{\vec{\consp}(i)}$ are compatible.

It can be shown that given a number $n$, a gate $g$ in $C_n$ and two pairs $(i,
\vec{x}) \in I$ and $(j, \vec{y}) \in J$ the function $\vec{c}$ in
Lemma~\ref{lem:permutation-row-column} can be computed in time polynomial in
$n$. Thus, from the Immerman-Vardi Theorem, it can be defined by a number term.
Thus we assert that there exists an $\FPC$ formula $\FA{move} (\mu, \delta,
\epsilon, \vec{x}, \vec{y}, \vec{z}, \vec{w})$ (where $\vec{y}$ and $\vec{z}$
are $2k$-tuples) such that $\mathcal{A} \models \FA{move} [g, i, j, \vec{a},
\vec{b}, \vec{d}]$ if, and only if, $\mathcal{A} \models \phi_G [g] \land
\FA{row}_g[g,i] \land \FA{col}[g, j]$ and $\mathcal{A} \models \FA{agree}_L [g,
i, \vec{a}, \vec{b}] \land \FA{agree}_L [g, j, \vec{a}, \vec{d}]$ and
$\vec{d}_{\vec{\consp}(j)} = \vec{c}$, where $\vec{c}$ is the vector given in
Lemma~\ref{lem:permutation-row-column} defined from the pairs $(i,
\vec{a}_{\vec{\consp}(i)})$ and $(j, \vec{b}_{\vec{\consp}(j)})$.

It is possible to define a polynomial-time algorithm that takes in a gate $g$
and $j, j' \in \universe{g}$ and $\vec{c}$, a $2k$-tuple with values in $[n]$,
constructs a permutation $\sigma \in \spstab{g}$ such that $\sigma
(\vec{\consp}(j)) := \vec{c}$ and checks, using
Lemma~\ref{lem:compute-automorphisms-labels}, if $\sigma j = j'$.

It follows from the Immerman-Vardi theorem that there is an $\FPC$ formula
$\FA{map}(\mu, \delta_1, \delta_2, \vec{z})$ (where $\vec{z}$ is a $2k$-tuple)
such that $\mathcal{A} \models \FA{map}[g, j, j', \vec{c}]$ if, and only if,
$\mathcal{A} \models \phi_G [g] \land \FA{col}[g, j] \land \FA{col}[g, j']$ and
such that there exists $\sigma \in \spstab{g}$ where $\sigma (\vec{\consp}(j)) =
\vec{c}$ and $\sigma j = j'$.
				
% Similarly we can define $\FA{agree}_1 (\mu, \delta , \vec{x}, \vec{y})$ such
% that $\mathcal{A}^leq \models \FA{agree}_1 [g, i, \vec{a}, \vec{b}]$ if, and
% only if, $\alpha \sim \beta$, where $\alpha \in U^{\underline{\consp(g)}}$ and
% $\beta \in U^{\underline {\consp(i)}}$ are the restrictions of $\vec{a}$ and
% $\vec{b}$ to the length of $\consp(g)$ and $\consp(i)$ respectively. Lastly we
% can define $\FA{agree}_2 (\mu, \delta, \epsilon , \vec{x}, \vec{y})$ such that
% $\mathcal{A}^\leq \models \FA{agree}_2 [g, i,j ,\vec{a}, \vec{b}, \vec{c}]$
% if, and only if, $\mathcal{A}^{\leq} \models \FA{agree}_1[g, i, \vec{a},
% \vec{b}] \land \FA{agree}_1[g, j, \vec{a}, \vec{c}]$ and $\alpha \sim \beta$,
% where $\alpha \in U^{\underline{\consp_g(i)}}$ and $\beta \in U^{\underline
% {\consp_g(j)}}$ are the restrictions of $\vec{b}$ and $\vec{c}$ to the length
% of $\consp_g(i)$ and $\consp_g(j)$ respectively.
				
We now define an $\FPC$-formula $\FA{merge}$ such that $\mathcal{A} \models
\FA{merge}[g, h, \vec{a}, \vec{b}, \vec{r}, \vec{c}]$ if, and only if, (i) $g$
and $h$ are gates such that $h \in H_g$, (ii) $\vec{a}$ and $\vec{b}$ are
$k$-tuples in $[n]$ and $\vec{r}$ and $\vec{c}$ are $2k$-tuples in $[n]$, and
(iii) $\vec{a}_{\vec{\consp}(h)}$, $\vec{b}_{\vec{\consp}(h)}$,
$\vec{r}_{\vec{\consp}(i)}$, and $\vec{c}_{\vec{\consp}(j)}$ (where $i := \row
(h)$ and $j := \column (j)$) are all compatible with one another. We note that
$\vec{w}_1$ and $\vec{w}_2$ are $2k$-tuples of variables. Let
\begin{align*}
	\FA{merge} (\mu, \nu, \vec{x}, \vec{y}, \vec{w}_1, \vec{w}_2) := & \exists \delta, \epsilon \leq \FA{m} \, ( \phi_L (\mu, \nu, \delta, \epsilon) \\ & \land \FA{agree}_L (\mu, \nu , \delta, \vec{x}, \vec{y}, \vec{w}_1) \land \\ & \FA{agree}_L (\mu, \nu , \epsilon, \vec{x}, \vec{y}, \vec{w}_2)).
\end{align*}
We are almost ready to define the matrix $M$ from the previous subsection. We
break this up into two formulas. The first is used to to check if an index is in
the domain of the matrix and the second defines $M$ for a given index. We note
that $\vec{y}$ and $\vec{z}$ are $2k$-tuples in the below formulas and let
$\FA{dom}_{\phi_L} (\mu, \delta, \epsilon) := \exists \nu \leq \FA{m} \, \phi_L
(\mu, \nu, \delta, \epsilon)$. Let
				
\begin{align*}
	\FA{check-dom}(\mu, \vec{x}, \delta, \vec{y}, \epsilon, \vec{z})  := & \FA{dom}_{\phi_L} (\mu, \delta, \epsilon) \land \FA{min-orb}(\mu, \delta)\land \FA{min-orb} (\mu, \epsilon) \\ & \land \FA{agree}_L (\mu, \delta , \vec{x}, \vec{y}) \land \FA{agree}_L (\mu, \epsilon , \vec{x}, \vec{z}), 
\end{align*}
and
\begin{align*}
	\FA{find-eval} (\mu, \vec{x}, \delta, \vec{y}, \epsilon, \vec{z}) := & \exists \vec{s} \leq \FA{s} \, (\FA{move}(\mu, \delta, \epsilon, \vec{x}, \vec{y}, \vec{z}, \vec{s}) \\ & \land (\exists \epsilon' \leq \FA{m} \, (\FA{map}^c (\mu, \epsilon, \epsilon', \vec{s}) \land (\exists \nu \leq \FA{m} \, (\phi_L (\mu, \delta, \epsilon', \nu) \\ & \land (\exists \vec{m} \, \leq \FA{s} \, (\FA{merge} (\mu, \nu, \vec{x}, \vec{m}, \vec{y}, \vec{z}) \land V(\nu, \vec{m})))))))).
\end{align*}
				
% There is an $\FP$ formula $\FA{merge}(\nu , \vec{s}, \vec{s}_2, \vec{x},
% \vec{y}, \vec{w})$ such that $\mathcal{A} \models \FA{merge} [\vec{r},
% \vec{c}, \vec{a}, \vec{b}, \vec{d}]$ if, and only if, $\mathcal{A}^{\leq}
% \models \FA{agree}_s[\vec{r}, \vec{c}, \vec{a}, \vec{b}]$ and $\vec{d}_{\vec{r
% \cup c}} = \vec{a}_{\vec{r}} | \vec{b}_{\vec{c}}$.
				
% We define the $\FPC$ formula $\FA{FIND}$ that takes in gates $g$ and $h \in
% H_g$ and
% \begin{align*}
% \FA{FIND}(\mu, \nu, \vec{s}, \vec{t}) := \exists a, b \leq \FA{MAX} (\phi_L(\mu, a, b, \nu) \land \bigwedge_{1 \leq i \leq 2k} \left( (\exists u \leq \FA{SIZE} (\FA{supp}_i (\mu, a, u) \implies s_i = u)) \and (\exists u \leq \FA{SIZE} (\FA{supp}_i (\mu, b, u) \implies t_i = u)) \right)
% \end{align*}
% From Lemma \ref{} and the Immerman-Vardi theorem there is a formula
% $\FA{FIND}$ such that $\mathcal{A} \models \FA{FIND} [g, h, \vec{r}, \vec{c}]$
% if, and only if, $h \in H_g$ and $\mathcal{A} \models \bigwedge_\FA{supp}^_r_i
% [h, \vec{r}, g] \land \FA{supp}^c [h, \vec{c}, g]$. We can then define
% $\FA{MIN-FIND} (\vec{s}_1, \vec{s}_2, \mu, \vec{x}, \nu) := \FA{FIND}
% (\vec{s}_1, \vec{s}_2, \mu, \vec{x}, \nu) \land (\forall \nu' (\FA{FIND}
% (\vec{s}_1, \vec{s}_2, \mu, \vec{x}, \nu') \implies \nu \leq \nu'))$.
				
% We now define a formula for checking if the input is in the domain of the
% matrix, i.e. are elements of the sets $I$ and $J$ defined in the previous
% section.
% \begin{align*}
%     \FA{check-dom}(\mu, \vec{x}, \delta, \vec{y}, \epsilon, \vec{z})  := & \FA{dom}_{\Phi_L} (\mu, \delta, \epsilon) 
%     \land \FA{min-orb}(\delta, \vec{y}) \land \FA{min-orb} (\epsilon, \vec{z}) \\
%     &\land \FA{agree}_1 (g, \delta , \vec{x}, \vec{y}) \land \FA{agree}_1 (g, \epsilon , \vec{x}, \vec{z}).
% %     \FA{merge} (\mu, \vec{x}, \nu, \vec{w}, \delta, \vec{y}, \epsilon,
% %     \vec{z}, \vec{w}) := & \FA{agree} (\mu, \nu, \vec{x}, \vec{w}) \land
% %     \FA{agree}_2 (\mu , \delta, \epsilon, \vec{x}, \vec{y}, \vec{z}) \\ &
% %     \land \FA{agree}_2 (\nu , \delta, \epsilon, \vec{w}, \vec{y}, \vec{z}),
% %     and \\ \\
% %     \FA{MIN-MERGE} (\mu, \vec{x}, \nu, \vec{w}, \delta, \vec{y}, \epsilon,
% %     \vec{z}, \vec{w}) := & \FA{merge} (\mu, \vec{x}, \nu, \vec{w}, \delta,
% %     \vec{y}, \epsilon, \vec{z}, \vec{w}) \\ & \land (\forall \nu'
% %     (\FA{merge} (\mu, \vec{x}, \nu', \vec{w}, \delta, \vec{y}, \epsilon,
% %     \vec{z}, \vec{w}) \implies \nu \leq nu'))
% \end{align*}.
				
% We now define a formula that takes in a gate $g$ and an assignment to its
% support as well as an encoding of $(i, \vec{b}) \in I$ and $(j, \vec{d})\in
% J$, and constructs the vector $\vec{c}$, as defined in the previous section,
% such that $\vec{b}_{\consp_g(i)} \sim \vec{d}_{\vec{c}}$. It then defines a
% gate $h \in H_g$ that has row support $\consp_g(i)$ and column support
% $\vec{c}$, before evaluating for $h$ for the assignment to the support
% $(\vec{b}_{\consp_g(i)} | \vec{d}_{\vec{c}})$.
% \begin{align*}
%     \FA{find-eval} (\mu, \vec{x}, \delta, \vec{y}, \epsilon, \vec{z}) := & \exists \vec{v} (\FA{move}(\delta, \vec{y}, \epsilon, \vec{z}, \mu, \vec{x}, \vec{v}) \\ & \land (\exists \vec{u} (\FA{supp}_r(\delta, \vec{u}, \mu) \land (\exists \nu (\FA{MIN-FIND}(\vec{u}, \vec{v}, \nu, \mu) \\ & \land (\exists \vec{w} (\FA{merge}(\nu, \vec{y}, \vec{z}, \vec{w}) \FA{agree}(\mu, \nu, \vec{x}, \vec{w}) \land V(\nu, \vec{w}))))))))
% \end{align*}
				
We are now ready to define the formula that defines the matrix $M$. Let
				
\begin{align*}
	\psi_M (\mu, \vec{x}, \delta, \vec{x}, \epsilon, \vec{y}) :=  \FA{check-dom}(\mu, \vec{x}, \delta, \vec{y}, \epsilon, \vec{z}) \land \FA{find-eval} (\mu, \vec{x}, \delta, \vec{y}, \epsilon, \vec{z}).
\end{align*}
				
We now define the formula that evaluates a rank gate $g$. Let
				
\begin{align*}
	\theta_\rank (\mu, \vec{x}) := & \bigwedge_{1 \leq i < j \leq k} x_i \neq x_j \land (\exists \pi, \kappa \leq \FA{m} \, (\FA{rank-type}(\mu. \pi, \kappa) \\ &\land [\rank (\vec{y}\delta\leq \FA{m}, \vec{z}\epsilon\leq \FA{m}, \pi \leq \FA{m}). \psi_M] \leq \kappa ))).
\end{align*}
				
As mentioned above we have the formulas $\theta_0$, $\theta_1$, $\theta_\land$,
$\theta_\lor$, $\theta_\nand$, $\theta_\maj$ and $(\theta_R)_{R \in \tau}$ from
Anderson and Dawar~\cite{AndersonD17}. Let $S = \{\land, \lor, \nand, \maj,
\rank\}$ be a set of symbols. The relation $V$ is then given as a fixed point by
the following formula. Let

\begin{align*}
	\theta (\mu, \vec{x}) := [\ifp_{V,\nu \vec{y}} \bigvee_{s \in  S \uplus \tau \uplus \{0,1\}} (\phi_s(\mu) \land \theta_s (\nu, \vec{y} ] (\mu, \vec{x}).
\end{align*}

The following $\FPR$ formula defines the $q$-ary query computed by the circuit
family $\mathcal{C}$~\cite{AndersonD17}. Let
				
\begin{align*}
	Q (z_1, \ldots z_q) := & \exists \vec{x} \exists \mu, \nu_1 , \ldots  \nu_q \eta_1 , \ldots , \nu_k \leq \FA{m} [\theta (\mu, \vec{x}) \land \phi_\Omega (\nu_1, \ldots \nu_q, \mu) \land \\
                         & \bigwedge_{1 \leq i \leq k} \FA{supp}_i (\mu, \eta_i) \wedge \forall \eta (\neg \FA{supp}_i (\mu, \eta))) \land \\
                         & \bigwedge_{1 \leq i \leq k} \bigwedge_{1 \leq j \leq q}((\FA{supp}_i (\mu, \eta_i) \land (x_i = z_j) \implies \nu_j = \eta_i) \land \\ &
                                                                                                                                                                    \bigwedge_{1 \leq j \leq q} \bigvee_{1 \leq i \leq k} (x_i = z_j \land \FA{supp}_i (\mu, \eta_i)].
\end{align*}
				
This completes the proof of our main theorem.
				
				
				
				
				
% We define the following formulas:
% \begin{align*}
%     \FA{check-dom}(\mu, \vec{x}, \delta, \vec{y}, \epsilon, \vec{z})  := & \FA{dom}_{\Phi_L} (\mu, \delta, \epsilon) 
%     \land \FA{min-orb}(\delta, \vec{y}) \land \FA{min-orb} (\epsilon, \vec{z}) \\
%     &\land \FA{agree}_1 (g, \delta , \vec{x}, \vec{y}) \land \FA{agree}_1 (g, \epsilon , \vec{x}, \vec{z}), \\ \\
%     %     \FA{merge} (\mu, \vec{x}, \nu, \vec{w}, \delta, \vec{y}, \epsilon,
%     %     \vec{z}, \vec{w}) := & \FA{agree} (\mu, \nu, \vec{x}, \vec{w}) \land
%     %     \FA{agree}_2 (\mu , \delta, \epsilon, \vec{x}, \vec{y}, \vec{z}) \\
%     %     & \land \FA{agree}_2 (\nu , \delta, \epsilon, \vec{w}, \vec{y},
%     %     \vec{z}), and \\ \\
%     %     \FA{MIN-MERGE} (\mu, \vec{x}, \nu, \vec{w}, \delta, \vec{y},
%     %     \epsilon, \vec{z}, \vec{w}) := & \FA{merge} (\mu, \vec{x}, \nu,
%     %     \vec{w}, \delta, \vec{y}, \epsilon, \vec{z}, \vec{w}) \\ & \land
%     %     (\forall \nu' (\FA{merge} (\mu, \vec{x}, \nu', \vec{w}, \delta,
%     %     \vec{y}, \epsilon, \vec{z}, \vec{w}) \implies \nu \leq nu'))
% \end{align*}.
				
				
				
% \theta_M (\delta , \vec{y}, \epsilon, \vec{z}, \mu, \vec{x})
				
				
								
\end{document}
